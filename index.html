<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçî Palatarius - Card√°pio Digital</title>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ==============================
       BLOCO 1 - VISUAL E ESTRUTURA
    ===============================*/

    :root {
      --primary: #c62828;
      --secondary: #0d47a1;
      --accent: #ffd54f;
      --bg: #f8f9fa;
      --text: #333;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }

    h2, h3, h4 {
      font-family: 'Russo One', sans-serif;
      color: var(--secondary);
    }

    header {
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      color: white;
      text-align: center;
      padding: 1.2rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    header h1 {
      font-size: 1.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    main {
      padding: 1rem;
    }

    /* Bot√µes */
    button {
      cursor: pointer;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      margin-top: 0.5rem;
      transition: 0.2s ease;
      font-weight: 600;
    }

    button.primary {
      background: var(--secondary);
      color: white;
    }

    button.primary:hover {
      background: #1565c0;
    }

    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Inputs */
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      margin: 0.3rem 0 0.8rem 0;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* Card√°pio */
    .section-title {
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      display: inline-block;
      padding-bottom: 0.2rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }

    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s;
    }

    .card:hover { transform: translateY(-4px); }

    .card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .card-content {
      padding: 0.8rem;
    }

    .card-content h3 {
      font-size: 1.1rem;
      color: var(--secondary);
      margin-bottom: 0.3rem;
    }

    .card-content p {
      font-size: 0.9rem;
      color: #444;
    }

    .price {
      color: var(--primary);
      font-weight: 700;
      margin-top: 0.4rem;
    }

    /* Modal de Ingredientes */
    #ingredientes-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #ingredientes-content {
      background: white;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      padding: 1rem;
      overflow-y: auto;
      max-height: 90vh;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ingrediente-grupo {
      margin: 1rem 0;
      background: #f1f1f1;
      border-radius: 8px;
      padding: 0.5rem 1rem;
    }

    .ingrediente-grupo h4 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .ingrediente-grupo label {
      display: block;
      font-size: 0.9rem;
      margin: 0.3rem 0;
    }

    .ingrediente-grupo input[type="checkbox"]:disabled + span {
      color: #aaa;
      text-decoration: line-through;
    }

    /* Carrinho */
    #cart {
      position: fixed;
      right: -400px;
      top: 0;
      width: 350px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.3);
      transition: right 0.3s ease;
      padding: 1rem;
      z-index: 10000;
      overflow-y: auto;
    }

    #cart.active { right: 0; }

    #cart h2 { color: var(--primary); }

    .cart-item {
      border-bottom: 1px solid #ddd;
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
    }

    .cart-total {
      margin-top: 1rem;
      font-weight: bold;
      color: var(--secondary);
    }

    .btn-whatsapp {
      background: #25d366;
      color: white;
      font-weight: 700;
      border: none;
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      margin-top: 0.6rem;
      width: 100%;
    }

    /* Checkout / Resumo */
    .checkout-modal, #resumo-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 1rem;
    }

    .checkout-box, .resumo-box {
      background: #fff;
      width: 100%;
      max-width: 640px;
      border-radius: 12px;
      padding: 1rem 1.2rem;
      box-shadow: 0 10px 35px rgba(0,0,0,0.25);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .resumo-lista {
      background: #f6f6f6;
      border-radius: 8px;
      padding: 0.8rem;
      margin-top: 0.5rem;
    }

    .resumo-lista p {
      margin: 0.2rem 0;
      color: #333;
    }

    /* Editor */
    #editor-screen {
      display: none;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      padding: 1.5rem;
      margin-top: 2rem;
    }

    #editor-screen.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    .editor-form {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
    }

    /* Abas do Editor */
    .editor-tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1rem;
    }

    .editor-tab {
      background: #ddd;
      color: #333;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    .editor-tab.active {
      background: var(--secondary);
      color: white;
    }

    /* Ingredientes pausados */
    .paused {
      opacity: 0.4;
      text-decoration: line-through;
      pointer-events: none;
    }

    footer {
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      color: white;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }

    /* Responsividade */
    @media(max-width:600px){
      header h1 { font-size: 1.3rem; }
      .card img { height: 120px; }
      #cart { width: 100%; }
    }

/* =======================
   BOT√ÉO "VENHA NOS VISITAR"
======================= */
.floating-btn {
  position: fixed;
  bottom: 1.5rem;
  left: 1.5rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: all 0.3s;
  z-index: 10000;
}
.floating-btn:hover {
  background: var(--secondary);
  transform: scale(1.05);
}

/* =======================
   MODAL VISITE-NOS
======================= */
  #visite-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 10001;
  }
  .visite-content {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 700px;
    width: 90%;
    text-align: center;
    animation: fadeIn 0.4s ease;
  }
  .visite-content h2 {
    color: var(--secondary);
    margin-bottom: 0.5rem;
  }
  .visite-content p {
    color: #444;
    line-height: 1.6;
    font-size: 1rem;
    margin-bottom: 1rem;
  }
  .visite-fotos {
    display: flex;
    gap: 0.6rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .visite-fotos img {
    width: 30%;
    min-width: 150px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    object-fit: cover;
    height: 120px;
  }
  .visite-info {
    margin-top: 1rem;
  }
  .maps-btn, .whatsapp-btn {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 700;
    transition: 0.2s;
  }
  .maps-btn {
    background: var(--accent);
    color: #222;
  }
  .maps-btn:hover {
    background: #ffe083;
  }
  .whatsapp-btn {
    background: #25d366;
    color: white;
  }
  .whatsapp-btn:hover {
    background: #1ebc58;
  }

/* =======================
   Vers√£o responsiva ‚Äî bot√£o flutuante menor e √† direita
  ======================= */
  @media (max-width: 600px) {
    .floating-btn {
      bottom: 1rem;
      right: 1rem;         /* ‚úÖ move para a direita da tela */
      left: auto;
      padding: 0.8rem;
      border-radius: 50%;
      font-size: 1.2rem;   /* ‚úÖ tamanho da casa proporcional */
      width: 54px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      z-index: 9500;       /* abaixo do carrinho */
      background: var(--primary);
    }

    /* ‚úÖ mostra apenas o √≠cone üè† e oculta o texto */
    .floating-btn::after {
      content: "üè†";
      font-size: 1.5rem;
    }
    .floating-btn span,
    .floating-btn::before {
      display: none !important;
    }
  }
/* ==============================
   üéûÔ∏è BANNER ROTATIVO RESPONSIVO AJUSTADO (v2)
============================== */
#banner-container {
  position: relative;
  width: 100%;
  max-width: 1200px;
  height: 300px; /* altura padr√£o desktop */
  margin: 0 auto 1rem auto;
  overflow: hidden;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  background: #000; /* ‚úÖ evita transpar√™ncia enquanto carrega */
}

.banner-slide {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  transition: opacity 1s ease-in-out;
}

.banner-slide.active {
  opacity: 1;
  z-index: 2;
}

#banner-container img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* ‚úÖ cobre toda a √°rea vis√≠vel, n√£o corta no mobile */
  display: block;
}

/* üîπ Vers√£o mobile aprimorada */
@media (max-width: 768px) {
  #banner-container {
    height: 180px;  /* ‚úÖ garante altura fixa no celular */
    max-width: 100%;
    border-radius: 0;
    box-shadow: none;
  }

  #banner-container img {
    object-fit: cover;  /* ‚úÖ preenche, sem distorcer */
    width: 100%;
    height: 100%;
  }
}

  /* ==============================
   üåê Layout adaptado para celular
    ============================== */
  @media (max-width: 768px) {
    .card-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: space-between;
      padding: 0.6rem;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
    }

    .card img {
      width: 35%;
      height: auto;
      border-radius: 8px;
      object-fit: cover;
    }

    .card-content {
      width: 60%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .card-content h3 {
      font-size: 1rem;
      margin: 0 0 0.25rem 0;
      color: var(--primary);
    }

    .card-content p {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 0.25rem;
    }

    .card-content .price {
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 0.25rem;
    }

    .card-content button {
      align-self: flex-start;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
    }
  }

/* ==============================
   üïì BLOQUEIO DE HOR√ÅRIO DE FUNCIONAMENTO ‚Äî ESTILO AZUL PALATARIUS
    ============================== */
    #loja-fechada-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, #002b6b 20%, #000814 90%); /* fundo azul escuro vibrante */
      color: white;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 99999;
      padding: 2rem;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    #loja-fechada-overlay.active {
      display: flex;
    }

    .overlay-content h2 {
      font-size: 2rem;
      margin-bottom: 0.8rem;
      color: #ffd54f; /* dourado Palatarius */
      text-shadow: 0 0 12px rgba(255, 213, 79, 0.9);
    }

    .overlay-content p {
      font-size: 1.1rem;
      margin-bottom: 0.4rem;
      color: #e8e8e8;
    }

    .overlay-content .endereco {
      margin-top: 0.8rem;
      font-size: 1rem;
      color: #ffd54f;
      font-weight: 600;
    }

    #contador {
      font-size: 2.2rem;
      font-weight: bold;
      color: #ffd54f;
      margin-top: 1rem;
      background: rgba(0, 0, 0, 0.4);
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    }

    @media (max-width: 768px) {
      .overlay-content h2 { font-size: 1.6rem; }
      #contador { font-size: 1.6rem; }
      .overlay-content .endereco { font-size: 0.9rem; }
    }

    /* üîµ MAPA AJUSTADO PARA CELULAR */
    #mapa-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      padding: 10px;
    }

    #mapa-content {
      background: white;
      width: 95%;
      max-width: 550px;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    #mapa-mapa {
      width: 100%;
      height: 380px;
      border-radius: 10px;
    }

    /* CELULAR */
    @media (max-width: 600px) {
      #mapa-content {
        width: 100%;
        padding: 6px;
        border-radius: 10px;
      }

      #mapa-mapa {
        height: 280px;
      }

      #fechar-mapa {
        font-size: 1rem;
        padding: 0.8rem;
        width: 100%;
      }
    }

  </style>

<!-- Leaflet Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

</head>

<body>
<script>
// vari√°veis globais do card√°pio (carregadas via JSON externo)
let categorias = [];
let ingredientes = [];

async function carregarCardapio() {
  try {
    const resp = await fetch("cardapio_palatarius.json?cache=" + Date.now());
    const data = await resp.json();
    categorias = data.categorias || [];
    ingredientes = data.ingredientes || [];
    try { localStorage.setItem("palatarius_data", JSON.stringify(data)); } catch(e) {}
  } catch (e) {
    console.error("Erro ao carregar card√°pio externo:", e);
    // fallback offline: usa cache salvo no navegador, se existir
    try {
      const cache = localStorage.getItem("palatarius_data");
      if (cache) {
        const data = JSON.parse(cache);
        categorias = data.categorias || [];
        ingredientes = data.ingredientes || [];
        console.warn("Carregado do cache local (offline).");
      }
    } catch(err) {
        console.warn("Falha ao ler cache local:", err);
    }
  }
}
</script>
  <header>
    <h1>üçî Palatarius - Card√°pio Digital</h1>
  </header>

<!-- Banner agora vis√≠vel logo na tela inicial -->
<div id="banner-container">
  <div class="banner-slide"><img src="assets/images/propaganda1.jpg" alt="Promo√ß√£o Palatarius 1"></div>
  <div class="banner-slide"><img src="assets/images/propaganda2.jpg" alt="Promo√ß√£o Palatarius 2"></div>
  <div class="banner-slide"><img src="assets/images/propaganda3.jpg" alt="Promo√ß√£o Palatarius 3"></div>
  <div class="banner-slide"><img src="assets/images/propaganda4.jpg" alt="Promo√ß√£o Palatarius 4"></div>
  <div class="banner-slide"><img src="assets/images/propaganda5.jpg" alt="Promo√ß√£o Palatarius 5"></div>
</div>

<main>
  <div style="display:flex;align-items:center;justify-content:flex-end;gap:.5rem;margin:0.5rem 0;">
    <button id="open-cart" class="primary">Carrinho (<span id="cart-count">0</span>)</button>
  </div>
  <!-- =======================
     BLOCO 2 ‚Äî TELA DO CLIENTE (v8 + Localiza√ß√£o)
======================== -->
<section id="cliente-screen" class="checkout-modal" style="display:none;">
  <div class="checkout-box">
  <h2 style="text-align:center; color:var(--secondary); font-family:'Russo One'; margin-bottom:1rem;">
    Finalizar Pedido
  </h2>

  <label for="cliente-nome">Nome:</label>
  <input type="text" id="cliente-nome" placeholder="Digite seu nome" required>

  <label for="cliente-telefone">N√∫mero de WhatsApp:</label>
  <input type="tel" id="cliente-telefone" placeholder="(XX) XXXXX-XXXX" required>

  <label for="cliente-tipo">Tipo de Pedido:</label>
  <select id="cliente-tipo">
    <option value="Retirada">Retirada</option>
    <option value="Entrega">Entrega</option>
  </select>

  <div id="endereco-container">
    <label for="cliente-endereco">Endere√ßo (caso entrega):</label>
    <input type="text" id="cliente-endereco" placeholder="Rua, n√∫mero, bairro">
  </div>

  <div class="pagamento-box">
    <label for="forma-pagamento">Forma de pagamento:</label>
    <select id="forma-pagamento">
      <option value="PIX">PIX</option>
      <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
      <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
      <option value="Dinheiro">Dinheiro</option>
    </select>
    <div id="dinheiro-extra" style="display:none;">
      <label for="valor-dinheiro">Valor que ir√° pagar:</label>
      <input type="number" id="valor-dinheiro" min="0" step="0.01" placeholder="Ex: 50,00">
    </div>
  </div>

  <!-- üîµ NOVO BOT√ÉO: ESCOLHER LOCALIZA√á√ÉO -->
  <button id="abrir-mapa" class="primary" style="margin-bottom:0.7rem;">
    üìç Escolher Localiza√ß√£o no Mapa
  </button>

  <!-- üó∫Ô∏è MODAL DO MAPA -->
  <div id="mapa-modal">
    <div id="mapa-content">
      <h3>Escolha sua localiza√ß√£o</h3>

  <div id="mapa-mapa" style="width: 100%; height: 350px; border-radius: 8px;"></div>

      <p>Arraste o mapa e clique para marcar seu ponto exato de entrega.</p>

      <button id="fechar-mapa" class="primary">Confirmar Localiza√ß√£o</button>
    </div>
  </div>

  <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
    <button id="confirmar-dados" class="primary">Calcular entrega e continuar</button>
    <button id="fechar-checkout">Cancelar</button>
  </div>
  </div>
</section>

  <!-- =======================
       2Ô∏è‚É£ CARD√ÅPIO PRINCIPAL
  ======================== -->
  <section id="cardapio-screen">
    <h2 class="section-title">üçî Hamb√∫rgueres</h2>
    <div class="card-grid" id="hamburgueres-grid"></div>

    <h2 class="section-title">üçü Batatas</h2>
    <div class="card-grid" id="batatas-grid"></div>

    <h2 class="section-title">ü•î Batatas Recheadas</h2>
    <div class="card-grid" id="batatas-recheadas-grid"></div>

    <h2 class="section-title">ü•ü Past√©is</h2>
    <div class="card-grid" id="pasteis-grid"></div>

    <h2 class="section-title">üå≠ Cachorros-Quentes</h2>
    <div class="card-grid" id="hotdogs-grid"></div>

    <h2 class="section-title">üç® Sorvetes & A√ßa√≠s</h2>
    <div class="card-grid" id="sorvetes-grid"></div>

    <h2 class="section-title">üßÉ Bebidas</h2>
    <div class="card-grid" id="bebidas-grid"></div>
  </section>

  <!-- =======================
       RESUMO FINAL (somente leitura)
  ======================== -->
  <div id="resumo-modal">
    <div class="resumo-box">
      <h3 style="margin-bottom:0.5rem;">üõí Resumo do Pedido</h3>
      <div id="resumo-conteudo" class="resumo-lista"></div>
      <div style="margin-top:0.8rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button id="enviar-whatsapp" class="btn-whatsapp" style="flex:1;">Enviar para WhatsApp</button>
        <button id="fechar-resumo" style="flex:1;">Voltar</button>
      </div>
    </div>
  </div>

  <!-- =======================
       3Ô∏è‚É£ MODAL DE INGREDIENTES
  ======================== -->
  <div id="ingredientes-modal">
    <div id="ingredientes-content">
      <h3 id="modal-item-nome">Personalize seu pedido</h3>
      <div id="ingredientes-grupos"></div>

      <div class="ingrediente-grupo">
        <h4>üìù Observa√ß√£o:</h4>
        <textarea id="obs" placeholder="Ex: sem alface, ponto da carne, etc..."></textarea>
      </div>

      <button id="add-to-cart" class="primary">Adicionar ao Carrinho</button>
      <button id="close-modal">Cancelar</button>
    </div>
  </div>

  <!-- =======================
       4Ô∏è‚É£ CARRINHO DE PEDIDOS
  ======================== -->
  <aside id="cart">
    <h2>üõí Seu Pedido</h2>
    <div id="cart-items"></div>
    <div class="cart-total" id="cart-total">Total: R$ 0,00</div>
    <button class="btn-whatsapp" id="finalizar-carrinho">Finalizar Pedido</button>
    <button id="close-cart" class="primary" style="margin-top:0.5rem;">Fechar</button>
  </aside>

  <!-- =======================
       5Ô∏è‚É£ EDITOR ADMINISTRATIVO (v7 - +criar grupo sem apagar)
  ======================== -->
  <section id="editor-screen">
    <div class="editor-tabs">
      <div class="editor-tab active" id="tab-cardapio">üçî Card√°pio</div>
      <div class="editor-tab" id="tab-ingredientes">üßÇ Ingredientes</div>
    </div>

    <!-- üî∏ Aba Card√°pio -->
    <div id="editor-cardapio" class="editor-section">
      <h2>Gerenciar Card√°pio</h2>

      <div style="margin:1rem 0;">
        <button id="export-json" class="primary">Exportar JSON</button>
        <input type="file" id="import-json" accept="application/json" style="display:none;">
        <label for="import-json" class="primary" style="background:var(--primary);">Importar JSON</label>
      </div>

      <!-- ‚úÖ NOVO: Criar grupo de produtos sem apagar os existentes -->
      <div class="editor-form" style="border-bottom:1px solid var(--border); padding-bottom:1rem; margin-bottom:1rem;">
        <h3>Novo Grupo de Produtos</h3>
        <label>Nome do Grupo:</label>
        <input type="text" id="novo-grupo-cardapio-nome" placeholder="Ex: Combos, Promo√ß√µes, Sobremesas...">
        <button id="salvar-grupo-cardapio" class="primary" style="margin-top:0.5rem;">Criar Grupo</button>
        <p style="font-size:.85rem;color:#666;margin-top:.25rem;">
          Dica: os grupos existentes permanecem. Este bot√£o apenas adiciona um novo grupo ao final.
        </p>
      </div>

      <div class="editor-form">
        <h3>Novo Produto</h3>
        <label>Nome:</label>
        <input type="text" id="novo-nome" placeholder="Ex: X-Paladino">

        <label>Categoria:</label>
        <!-- Ser√° populado dinamicamente pelo BLOCO 4 (refreshCategoriaSelect) -->
        <select id="novo-categoria"></select>

        <label>Pre√ßo (R$):</label>
        <input type="number" id="novo-preco" step="0.01">

        <label>Imagem (nome do arquivo):</label>
        <input type="text" id="novo-imagem" placeholder="Ex: hadouken.jpg">

        <label>Descri√ß√£o:</label>
        <textarea id="novo-descricao" placeholder="Descri√ß√£o detalhada do produto"></textarea>


        <button id="salvar-produto" class="primary" style="margin-top:1rem;">Salvar Produto</button>
      </div>

      <div id="lista-produtos" style="margin-top:2rem;">
        <h3>Produtos Cadastrados:</h3>
        <div id="produtos-editor"></div>
      </div>

      <button id="close-editor" class="primary" style="margin-top:1rem;">Fechar Editor</button>
    </div>

    <!-- üî∏ Aba Ingredientes (mantida) -->
    <div id="editor-ingredientes" class="editor-section" style="display:none;">
      <h2>Gerenciar Ingredientes</h2>

      <div class="editor-form" style="border-bottom:1px solid var(--border); padding-bottom:1rem; margin-bottom:1rem;">
        <h3>Novo Grupo de Ingredientes</h3>
        <label>Nome do Grupo:</label>
        <input type="text" id="novo-grupo-nome" placeholder="Ex: Molhos Premium, Carnes Especiais...">
        <button id="salvar-grupo" class="primary" style="margin-top:0.5rem;">Salvar Grupo</button>
      </div>

      <div class="editor-form">
        <h3>Novo Ingrediente</h3>

        <label>Grupo:</label>
        <select id="novo-grupo"></select>

        <label>Nome do Ingrediente:</label>
        <input type="text" id="novo-ingrediente" placeholder="Ex: Cheddar, Alho Torrado...">

        <!-- ‚úÖ Campo adicionado -->
        <label>Valor (R$):</label>
        <input id="novo-ingrediente-valor" type="number" step="0.01" min="0" placeholder="Valor (R$)">

        <button id="salvar-ingrediente" class="primary" style="margin-top:0.5rem;">Salvar Ingrediente</button>
      </div>

      <div id="lista-ingredientes" style="margin-top:2rem;">
        <h3>Grupos e Ingredientes Cadastrados:</h3>
        <div id="ingredientes-editor"></div>
      </div>
    </div>
  </section>
  <!-- =======================
     SE√á√ÉO VISITE-NOS
======================= -->
<button id="visite-btn" class="floating-btn">üè† Venha nos Visitar!</button>

<div id="visite-modal">
  <div class="visite-content">
    <h2>üçî Bem-vindo √† Palatarius!</h2>
    <p>
      Um espa√ßo geek e aconchegante onde o sabor encontra a divers√£o!  
      Aqui a galera se re√∫ne pra saborear nossos hamb√∫rgueres artesanais,  
      curtir o fliperama, jogar PS4 e viver momentos √©picos com os amigos.  
      Venha sentir o <strong>Sabor Geek da Gal√°xia!</strong> üéÆ‚ú®
    </p>

    <div class="visite-fotos">
      <img src="assets/images/loja_1.jpg" alt="Fachada da Loja Palatarius">
      <img src="assets/images/fliperama.jpg" alt="Fliperama Palatarius">
      <img src="assets/images/ps4_area.jpg" alt="√Årea Gamer PS4">
    </div>

    <div class="visite-info">
      <p><strong>üìç Endere√ßo:</strong> BR-465, n¬∫ 199 ‚Äì Campo Lindo, Serop√©dica-RJ<br>
      (Pr√≥ximo √† LifeFit KM40)</p>
      <a href="https://www.google.com/maps/place/Palatarius/@-22.8060553,-43.6377571,19.5z/data=!4m6!3m5!1s0x9957204e3e3a25:0xdd752037ad31df35!8m2!3d-22.8059955!4d-43.6378252!16s%2Fg%2F11mdfkrt_t?hl=pt-BR&entry=ttu&g_ep=EgoyMDI1MTEwNC4xIKXMDSoASAFQAw%3D%3D"
         target="_blank" class="maps-btn">üó∫Ô∏è Ver no Google Maps</a>

      <p style="margin-top:0.5rem;"><strong>üìû WhatsApp:</strong> (21) 99759-9132</p>
      <a href="https://wa.me/5521997599132?text=Ol√°!%20Vim%20pelo%20card√°pio%20digital%20e%20quero%20saber%20mais%20sobre%20a%20Palatarius!"
         target="_blank" class="whatsapp-btn">üí¨ Falar com a Palatarius</a>
    </div>

    <button id="fechar-visite" class="primary" style="margin-top:1rem;">Fechar</button>
  </div>
</div>

  <!-- =======================
       6Ô∏è‚É£ RODAP√â SECRETO
  ======================== -->
  <footer id="palatarius-footer">
    ¬© 2025 <span>Palatarius</span> - O Sabor Geek da Gal√°xia
  </footer>
</main>

<script>
/* =========================================================
   BLOCO 3 ‚Äî FUNCIONALIDADES DO CLIENTE (v8.1)
========================================================= */

let cliente = {};
let carrinho = [];
let itemSelecionado = null;

/* =========================================================
   FLUXO NOVO: abrindo checkout e validando dados
========================================================= */
const CART_KEY = "palatarius_cart_v1";

function salvarCarrinhoLocal() {
  try { localStorage.setItem(CART_KEY, JSON.stringify(carrinho)); } catch(e) {}
}

function carregarCarrinhoLocal() {
  try {
    const stored = localStorage.getItem(CART_KEY);
    if (stored) carrinho = JSON.parse(stored) || [];
  } catch(e) { carrinho = []; }
}

document.addEventListener("DOMContentLoaded", async () => {
  await carregarCardapio();
  renderCardapio();
  renderEditorProdutos();
  renderEditorIngredientes();
  carregarCarrinhoLocal();
  atualizarCarrinho(true);
});

function abrirCheckout() {
  if (!carrinho.length) return alert("Carrinho vazio!");
  document.getElementById("cliente-screen").style.display = "flex";
}

document.getElementById("open-cart").addEventListener("click", () => {
  atualizarCarrinho();
  document.getElementById("cart").classList.add("active");
});

document.getElementById("finalizar-carrinho").addEventListener("click", abrirCheckout);
document.getElementById("fechar-checkout").addEventListener("click", () => {
  document.getElementById("cliente-screen").style.display = "none";
});

document.getElementById("forma-pagamento").addEventListener("change", e => {
  document.getElementById("dinheiro-extra").style.display = e.target.value === "Dinheiro" ? "block" : "none";
});

document.getElementById("confirmar-dados").addEventListener("click", () => {
  const nome = document.getElementById("cliente-nome").value.trim();
  const telefone = document.getElementById("cliente-telefone").value.trim();
  const tipo = document.getElementById("cliente-tipo").value;
  const endereco = document.getElementById("cliente-endereco").value.trim();
  const formaPagamento = document.getElementById("forma-pagamento").value;
  const valorDinheiro = parseFloat(document.getElementById("valor-dinheiro").value);

  if (!nome || !telefone) return alert("Por favor, preencha nome e telefone.");
  if (tipo === "Entrega") {
    if (!endereco) return alert("Por favor, preencha o endereco.");
    const dadosEntrega = obterDadosEntrega();
    if (dadosEntrega.erro) {
      alert(dadosEntrega.erro);
      cliente.entrega = 0;
      cliente.distancia = 0;
      cliente.tempoEstimado = "";
      cliente.coordenadas = "";
      if (!localizacaoCliente) document.getElementById("abrir-mapa").click();
      return;
    }
    cliente.coordenadas = localizacaoCliente;
    cliente.distancia = dadosEntrega.distancia;
    cliente.entrega = dadosEntrega.taxa;
    cliente.tempoEstimado = `${dadosEntrega.tempo.minInicio} a ${dadosEntrega.tempo.minFim} min`;
  } else {
    cliente.entrega = 0;
    cliente.distancia = 0;
    cliente.tempoEstimado = "30 a 50 min";
    cliente.coordenadas = "";
  }

  const subtotal = calcularSubtotal();
  const taxaEntrega = tipo === "Entrega" ? (cliente.entrega || 0) : 0;
  const total = subtotal + taxaEntrega;

  let troco = 0;
  if (formaPagamento === "Dinheiro") {
    if (isNaN(valorDinheiro)) return alert("Informe o valor que ira pagar em dinheiro.");
    if (valorDinheiro < total) return alert("O valor informado e menor que o total.");
    troco = +(valorDinheiro - total).toFixed(2);
  }

  cliente.nome = nome;
  cliente.telefone = telefone;
  cliente.tipo = tipo;
  cliente.endereco = endereco;
  cliente.pagamento = {
    forma: formaPagamento,
    valorInformado: isNaN(valorDinheiro) ? null : valorDinheiro,
    troco
  };

  abrirResumo(total, subtotal, taxaEntrega);
});


/* ===============================
   RENDERIZA√á√ÉO DO CARD√ÅPIO
=============================== */
function renderCardapio() {

  const tela = document.getElementById("cardapio-screen");
  tela.innerHTML = "";

  if (!categorias?.length) {
    tela.innerHTML = `<p style="text-align:center;color:#777;">Nenhum produto cadastrado ainda.</p>`;
    return;
  }

  categorias.forEach(cat => {
    const sec = document.createElement("section");
    sec.classList.add("grupo-cardapio");
    sec.innerHTML = `<h2 class="section-title">${cat.nome}</h2>`;

    const grid = document.createElement("div");
    grid.className = "card-grid";

    if (!cat.itens?.length) {
      grid.innerHTML = `<p style="text-align:center;color:#aaa;">Nenhum produto neste grupo.</p>`;
    } else {
      cat.itens.forEach(item => {
        const img = item.imagem ? `assets/images/${item.imagem}` : "assets/images/placeholder.jpg";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${img}" onerror="this.src='assets/images/placeholder.jpg'">
          <div class="card-content">
            <h3>${item.nome}</h3>
            <p>${item.descricao || ""}</p>
            <div class="price">R$ ${Number(item.preco || 0).toFixed(2)}</div>
            <button onclick="abrirModalIngredientes('${cat.nome}','${item.nome}')">Adicionar</button>
          </div>`;
        grid.appendChild(card);
      });
    }
    sec.appendChild(grid);
    tela.appendChild(sec);
  });
}

// ===============================
// MODAL DE INGREDIENTES (v8.1 com controle de permiss√µes)
// ===============================
function abrirModalIngredientes(catNome, itemNome) {
  const cat = categorias.find(c => c.nome === catNome);
  const item = cat?.itens?.find(i => i.nome === itemNome);
  if (!item) return alert("Item n√£o encontrado!");

  itemSelecionado = item;
  document.getElementById("modal-item-nome").innerText = itemNome;
  document.getElementById("ingredientes-modal").style.display = "flex";
  gerarIngredientesModal(item);
}

function gerarIngredientesModal(item) {
  const cont = document.getElementById("ingredientes-grupos");
  cont.innerHTML = "";
  item.ingredientesPermitidos ||= {};
  item.limites ||= {};

  if (!ingredientes?.length) {
    cont.innerHTML = `<p style="color:#777;">Nenhum grupo de ingredientes cadastrado.</p>`;
    return;
  }

  // üîí Mostra somente grupos realmente liberados no produto
  const gruposLiberados = Object.keys(item.ingredientesPermitidos);
  if (!gruposLiberados.length) {
    cont.innerHTML = `<p style="color:#777;">Nenhum ingrediente dispon√≠vel para este item.</p>`;
    return;
  }

  ingredientes.forEach(gr => {
    const grupoNome = gr.grupo;
    const permitidos = item.ingredientesPermitidos?.[grupoNome];
    if (!permitidos) return; // grupo n√£o liberado ‚Üí ignora

    // Se o grupo inteiro foi liberado (*), usa todas as op√ß√µes
    let opcoesFiltradas = [];
    if (permitidos === "*") {
      opcoesFiltradas = gr.opcoes;
    } else if (Array.isArray(permitidos)) {
      // Mostra apenas ingredientes selecionados no editor
      opcoesFiltradas = gr.opcoes.filter(o => permitidos.includes(o.nome));
    }

    if (!opcoesFiltradas.length) return;

    const div = document.createElement("div");
    div.className = "ingrediente-grupo";
    const limite = item.limites?.[grupoNome] || 0;
    let html = `<h4>${grupoNome}${limite ? ` (m√°x ${limite})` : ""}</h4>`;

    opcoesFiltradas.forEach(op => {
      const pausado = op.pausado === true;
      const valor = Number(op.valor || 0);
      const textoValor = valor > 0 ? ` (+R$ ${valor.toFixed(2)})` : "";
      html += `
        <label ${pausado ? 'class="paused"' : ''}>
          <input type="checkbox" 
                 name="${grupoNome}" 
                 value="${op.nome}" 
                 data-valor="${valor}" 
                 ${pausado ? "disabled" : ""}>
          <span>${op.nome}${textoValor}</span>
        </label>`;
    });

    div.innerHTML = html;
    cont.appendChild(div);

    // controle de limite, se existir
    if (limite > 0) {
      div.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", e => {
          const checks = div.querySelectorAll('input:checked');
          if (checks.length > limite) {
            e.target.checked = false;
            alert(`M√°x. permitido: ${limite} em ${grupoNome}`);
          }
        });
      });
    }
  });
}

document.getElementById("close-modal").onclick = () => {
  document.getElementById("ingredientes-modal").style.display = "none";
  document.getElementById("obs").value = "";
  itemSelecionado = null;
};

// ===============================
// CARRINHO
// ===============================
document.getElementById("add-to-cart").addEventListener("click", () => {
  if (!itemSelecionado) return;

  const selecionados = {};
  let totalExtras = 0;

  document.querySelectorAll("#ingredientes-grupos .ingrediente-grupo").forEach(div => {
    const grupo = div.querySelector("h4").innerText.split(" (")[0];
    const checks = [...div.querySelectorAll("input:checked")];
    if (checks.length) {
      selecionados[grupo] = checks.map(i => i.value);
      totalExtras += checks.reduce((s, c) => s + Number(c.dataset.valor || 0), 0);
    }
  });

  const obs = document.getElementById("obs").value.trim();
  adicionarAoCarrinho(itemSelecionado, selecionados, obs, totalExtras);

  document.getElementById("ingredientes-modal").style.display = "none";
  document.getElementById("obs").value = "";
  itemSelecionado = null;
});

function adicionarAoCarrinho(item, ingredientesEscolhidos, obs, extras = 0) {
  const precoFinal = (Number(item.preco) || 0) + extras;
  carrinho.push({ ...item, precoFinal, ingredientesEscolhidos, obs });
  atualizarCarrinho();
}

function atualizarCarrinho(keepClosed = false) {
  const cont = document.getElementById("cart-items");
  cont.innerHTML = "";
  let total = 0;

  carrinho.forEach((it, i) => {
    total += Number(it.precoFinal) || 0;
    const div = document.createElement("div");
    div.className = "cart-item";
    let html = `<p><strong>${it.nome}</strong> - R$ ${it.precoFinal.toFixed(2)}</p>`;
    if (it.ingredientesEscolhidos) {
      for (const [g, l] of Object.entries(it.ingredientesEscolhidos)) {
        html += `<p style="font-size:0.85rem;color:#555;">${g}: ${l.join(", ")}</p>`;
      }
    }
    if (it.obs) html += `<p style="font-size:0.85rem;color:#777;"><em>Obs:</em> ${it.obs}</p>`;
    html += `<button onclick="removerItem(${i})" style="background:none;border:none;color:red;font-weight:bold;float:right;">x</button>`;
    div.innerHTML = html;
    cont.appendChild(div);
  });

  document.getElementById("cart-total").innerText = `Total: R$ ${total.toFixed(2)}`;
  const countEl = document.getElementById("cart-count");
  if (countEl) countEl.innerText = carrinho.length;
  salvarCarrinhoLocal();
  if (!keepClosed) document.getElementById("cart").classList.add("active");
}

function removerItem(i) {
  carrinho.splice(i, 1);
  atualizarCarrinho();
}

document.getElementById("close-cart").onclick = () =>
  document.getElementById("cart").classList.remove("active");

</script>

<script>
/* =========================================================
   BLOCO 3.5x ‚Äî MAPA COMPLETO (Leaflet + Taxa + Tempo + Obrigat√≥rio)
   Palatarius ‚Äî vers√£o FINAL unificada
========================================================= */

let mapa = null;
let marcador = null;
let localizacaoCliente = null;

const modalMapa = document.getElementById("mapa-modal");
const btnAbrirMapa = document.getElementById("abrir-mapa");
const btnFecharMapa = document.getElementById("fechar-mapa");

/* =========================================================
   1) COORDENADAS DA PALATARIUS
========================================================= */
const PALATARIUS_LAT = -22.805837237901123;
const PALATARIUS_LNG = -43.637674999789205;

/* =========================================================
   2) Fun√ß√£o Haversine ‚Äî dist√¢ncia entre dois pontos
========================================================= */
function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* =========================================================
   3) C√°lculo da taxa por dist√¢ncia (nova regra)
========================================================= */
function calcularTaxa(distanciaKm) {
  if (distanciaKm > 10) return -1; // fora do raio de entrega
  if (distanciaKm <= 3) return 4;
  const extraKm = Math.ceil(distanciaKm - 3);
  return +(4 + extraKm * 3).toFixed(2);
}

/* =========================================================
   4) C√°lculo do tempo estimado (nova regra)
========================================================= */
function calcularTempoEntrega(dist) {
  let minInicio = 30;
  let minFim = 50;

  if (dist > 4) {
    const extras = Math.ceil((dist - 4) / 2);
    minInicio += extras * 15;
    minFim += extras * 15;
  }
  return { minInicio, minFim };
}

// Centraliza a logica de conversao das coordenadas em distancia/taxa/tempo
function obterDadosEntrega() {
  if (!localizacaoCliente) {
    return { erro: "Clique no mapa para marcar sua localizacao!" };
  }

  const [lat, lng] = localizacaoCliente.split(",").map(Number);
  if (Number.isNaN(lat) || Number.isNaN(lng)) {
    return { erro: "Coordenadas invalidas. Clique novamente no mapa." };
  }

  const distancia = calcularDistancia(PALATARIUS_LAT, PALATARIUS_LNG, lat, lng);
  const taxa = calcularTaxa(distancia);
  if (taxa === -1) {
    return {
      erro: `Desculpe, nao conseguimos entregar acima de 10 km. Distancia: ${distancia.toFixed(2)} km.`,
      distancia
    };
  }

  const tempo = calcularTempoEntrega(distancia);
  return { distancia, taxa, tempo };
}

/* =========================================================
   5) ABRIR MAPA ‚Äî cria mapa + centraliza no endere√ßo
========================================================= */
btnAbrirMapa.addEventListener("click", async () => {
  modalMapa.style.display = "flex";

if (!mapa) {
  mapa = L.map('mapa-mapa').setView([PALATARIUS_LAT, PALATARIUS_LNG], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(mapa);

  mapa.on("click", e => {
    const { lat, lng } = e.latlng;
    if (marcador) mapa.removeLayer(marcador);
    marcador = L.marker([lat, lng]).addTo(mapa);
    localizacaoCliente = `${lat.toFixed(6)},${lng.toFixed(6)}`;
  });
}

  // Se o cliente escreveu endere√ßo ‚Üí geocoding
  const endereco = document.getElementById("cliente-endereco").value.trim();
  if (endereco) {
    try {
      // Restringe a busca para perto da loja para evitar resultados longe
      const delta = 0.3; // ~30km de margem
      const viewbox = [
        PALATARIUS_LNG - delta, // left (min lon)
        PALATARIUS_LAT + delta, // top (max lat)
        PALATARIUS_LNG + delta, // right (max lon)
        PALATARIUS_LAT - delta  // bottom (min lat)
      ].join(",");

      const resp = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&limit=1&viewbox=${viewbox}&bounded=1&q=${encodeURIComponent(endereco)}`
      );
      const dados = await resp.json();
      if (dados.length > 0) {
        const lat = parseFloat(dados[0].lat);
        const lon = parseFloat(dados[0].lon);

        mapa.setView([lat, lon], 18);

        if (marcador) mapa.removeLayer(marcador);
        marcador = L.marker([lat, lon]).addTo(mapa);
        // j√° define coordenadas a partir do endere√ßo digitado (primeira marca√ß√£o)
        localizacaoCliente = `${lat.toFixed(6)},${lon.toFixed(6)}`;
      }
    } catch (e) {
      console.log("Falha no geocoding.");
    }
  }

  setTimeout(() => mapa.invalidateSize(), 300);
});

/* =========================================================
   6) CONFIRMAR LOCALIZA√á√ÉO ‚Äî calcula taxa + tempo
========================================================= */
btnFecharMapa.addEventListener("click", () => {
  const dadosEntrega = obterDadosEntrega();
  if (dadosEntrega.erro) {
    alert(dadosEntrega.erro);
    cliente.entrega = 0;
    modalMapa.style.display = "none";
    return;
  }

  cliente.coordenadas = localizacaoCliente;
  cliente.distancia = dadosEntrega.distancia;
  cliente.entrega = dadosEntrega.taxa;
  cliente.tempoEstimado = `${dadosEntrega.tempo.minInicio} a ${dadosEntrega.tempo.minFim} min`;

  alert(
    `Localizacao salva!
` +
    `Distancia: ${dadosEntrega.distancia.toFixed(2)} km
` +
    `Taxa de entrega: R$ ${dadosEntrega.taxa.toFixed(2)}
` +
    `Tempo estimado: ${dadosEntrega.tempo.minInicio}-${dadosEntrega.tempo.minFim} min`
  );

  modalMapa.style.display = "none";
});

/* =========================================================
   7) RESUMO E ENVIO (WhatsApp + EmailJS)
========================================================= */
// Chaves EmailJS
const EMAILJS_PUBLIC_KEY = "P_Xdz3gl4S1FuQRw3";
const EMAILJS_SERVICE_ID = "service_u3jlu8c";
const EMAILJS_TEMPLATE_ID = "template_ufap5bd";

if (window.emailjs && EMAILJS_PUBLIC_KEY !== "COLOQUE_SUA_PUBLIC_KEY") {
  emailjs.init(EMAILJS_PUBLIC_KEY);
}

function calcularSubtotal() {
  return carrinho.reduce((s, it) => s + (Number(it.precoFinal) || 0), 0);
}

function abrirResumo(total, subtotal, taxaEntrega) {
  const codigo = Math.floor(Math.random() * 5000) + 1;
  cliente.codigoPedido = codigo;

  const conteudo = document.getElementById("resumo-conteudo");
  let html = `<p><strong>Codigo:</strong> #${codigo}</p>`;
  html += `<p><strong>Cliente:</strong> ${cliente.nome} (${cliente.telefone})</p>`;
  html += `<p><strong>Tipo:</strong> ${cliente.tipo}</p>`;
  if (cliente.tipo === "Entrega") {
    html += `<p><strong>Endereco:</strong> ${cliente.endereco}</p>`;
    html += `<p><strong>Distancia:</strong> ${cliente.distancia?.toFixed(2)} km</p>`;
    html += `<p><strong>Tempo estimado:</strong> ${cliente.tempoEstimado}</p>`;
    html += `<p><strong>Localizacao:</strong> ${cliente.coordenadas}</p>`;
  }

  html += `<div style="margin-top:0.6rem;"><strong>Itens:</strong></div>`;
  carrinho.forEach(it => {
    html += `<p>- ${it.nome} - R$ ${it.precoFinal.toFixed(2)}</p>`;
    if (it.ingredientesEscolhidos) {
      for (const [g, l] of Object.entries(it.ingredientesEscolhidos)) {
        html += `<p style="margin-left:10px;color:#555;">${g}: ${l.join(', ')}</p>`;
      }
    }
    if (it.obs) html += `<p style="margin-left:10px;color:#777;">Obs: ${it.obs}</p>`;
  });

  const pagamento = cliente.pagamento || {};
  html += `<p style="margin-top:0.6rem;"><strong>Pagamento:</strong> ${pagamento.forma || ""}</p>`;
  if (pagamento.forma === "Dinheiro") {
    html += `<p>Valor: R$ ${Number(pagamento.valorInformado || 0).toFixed(2)}</p>`;
    html += `<p>Troco: R$ ${Number(pagamento.troco || 0).toFixed(2)}</p>`;
  }

  html += `<p><strong>Subtotal:</strong> R$ ${subtotal.toFixed(2)}</p>`;
  html += `<p><strong>Taxa entrega:</strong> R$ ${taxaEntrega.toFixed(2)}</p>`;
  html += `<p><strong>Total:</strong> R$ ${total.toFixed(2)}</p>`;

  conteudo.innerHTML = html;
  document.getElementById("cliente-screen").style.display = "none";
  document.getElementById("resumo-modal").style.display = "flex";
}

document.getElementById("fechar-resumo").addEventListener("click", () => {
  document.getElementById("resumo-modal").style.display = "none";
});

function montarMensagem(total, subtotal, taxaEntrega) {
  const codigo = cliente.codigoPedido || Math.floor(Math.random() * 5000) + 1;
  const linhas = [];
  linhas.push(`PEDIDO Palatarius #${codigo}`);
  linhas.push(`Cliente: ${cliente.nome}`);
  linhas.push(`Telefone: ${cliente.telefone}`);
  linhas.push(`Tipo: ${cliente.tipo}`);
  if (cliente.tipo === "Entrega") {
    linhas.push(`Endereco: ${cliente.endereco}`);
    linhas.push(`Distancia: ${cliente.distancia?.toFixed(2)} km`);
    linhas.push(`Taxa: R$ ${taxaEntrega.toFixed(2)}`);
    linhas.push(`Tempo estimado: ${cliente.tempoEstimado}`);
    linhas.push(`Localizacao: https://www.google.com/maps?q=${cliente.coordenadas}`);
  }
  linhas.push(`-----------------------`);
  carrinho.forEach(it => {
    linhas.push(`- ${it.nome} - R$ ${it.precoFinal.toFixed(2)}`);
    if (it.ingredientesEscolhidos) {
      for (const [g, l] of Object.entries(it.ingredientesEscolhidos)) {
        linhas.push(`${g}: ${l.join(', ')}`);
      }
    }
    if (it.obs) linhas.push(`Obs: ${it.obs}`);
    linhas.push(`-----------------------`);
  });
  linhas.push(`Subtotal: R$ ${subtotal.toFixed(2)}`);
  linhas.push(`Taxa: R$ ${taxaEntrega.toFixed(2)}`);
  linhas.push(`Total: R$ ${total.toFixed(2)}`);
  if (cliente.pagamento?.forma) {
    linhas.push(`Pagamento: ${cliente.pagamento.forma}`);
    if (cliente.pagamento.forma === "Dinheiro") {
      linhas.push(`Valor pago: R$ ${Number(cliente.pagamento.valorInformado || 0).toFixed(2)}`);
      linhas.push(`Troco: R$ ${Number(cliente.pagamento.troco || 0).toFixed(2)}`);
    }
  }
  linhas.push(`Horario: ${new Date().toLocaleString('pt-BR')}`);
  linhas.push(`Codigo: #${codigo}`);
  return linhas;
}

async function enviarEmailCopia(textoBruto) {
  if (!window.emailjs || EMAILJS_PUBLIC_KEY === "COLOQUE_SUA_PUBLIC_KEY") {
    console.warn("Configure EmailJS com suas chaves para habilitar o envio automatico.");
    return;
  }
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      message: textoBruto,
      para: "palatarius@gmail.com",
      codigo: cliente.codigoPedido || "",
      cliente: cliente.nome,
      telefone: cliente.telefone
    });
  } catch (err) {
    console.warn("Falha ao enviar e-mail:", err);
  }
}

document.getElementById("enviar-whatsapp").addEventListener("click", async () => {
  const subtotal = calcularSubtotal();
  const taxaEntrega = cliente.tipo === "Entrega" ? (cliente.entrega || 0) : 0;
  const total = subtotal + taxaEntrega;
  const linhas = montarMensagem(total, subtotal, taxaEntrega);
  const textoBruto = linhas.join("\n");
  const msgCodificada = encodeURIComponent(linhas.join("\n"));
  window.open(`https://wa.me/5521997599132?text=${msgCodificada}`, "_blank");
  await enviarEmailCopia(textoBruto);
  carrinho = [];
  salvarCarrinhoLocal();
  atualizarCarrinho(true);
  document.getElementById("resumo-modal").style.display = "none";
});

</script>

<script>
/* =========================================================
   BLOCO 4 ‚Äî EDITOR ADMINISTRATIVO AVAN√áADO (v9.6)
   Produtos iniciam limpos (sem limites nem ingredientes)
   e ajustes no salvamento de edi√ß√£o
========================================================= */

// ===============================
// ACESSO SECRETO AO EDITOR
// ===============================
let clickCount = 0;
const footer = document.getElementById("palatarius-footer");
footer.addEventListener("click", () => {
  clickCount++;
  if (clickCount === 3) {
    const senha = prompt("üîê Digite a senha de acesso:");
    if (senha === "EdLeoMarc&2025") {
      document.getElementById("editor-screen").classList.add("active");
      alert("‚úÖ Acesso concedido ao editor Palatarius!");
      refreshCategoriaSelect();
      if (typeof atualizarSelectGrupos === "function") atualizarSelectGrupos();
      renderEditorProdutos();
      renderEditorIngredientes();
    } else {
      alert("‚ùå Senha incorreta!");
    }
    clickCount = 0;
  }
  setTimeout(() => (clickCount = 0), 1500);
});

// ===============================
// TROCA DE ABAS DO EDITOR
// ===============================
document.getElementById("tab-cardapio").addEventListener("click", () => ativarAba("cardapio"));
document.getElementById("tab-ingredientes").addEventListener("click", () => ativarAba("ingredientes"));

function ativarAba(aba) {
  document.querySelectorAll(".editor-tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`#tab-${aba}`).classList.add("active");

  document.querySelectorAll(".editor-section").forEach(s => (s.style.display = "none"));
  document.getElementById(`editor-${aba}`).style.display = "block";

  if (aba === "cardapio") {
    refreshCategoriaSelect();
    renderEditorProdutos();
  }
  if (aba === "ingredientes") {
    if (typeof atualizarSelectGrupos === "function") atualizarSelectGrupos();
    renderEditorIngredientes();
  }
}

// ===============================
// ATUALIZA SELECT DE CATEGORIAS
// ===============================
function refreshCategoriaSelect() {
  const sel = document.getElementById("novo-categoria");
  if (!sel) return;
  sel.innerHTML = "";
  (categorias || []).forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.nome;
    opt.textContent = c.nome;
    sel.appendChild(opt);
  });
}

// ===============================
// ADICIONAR PRODUTO ‚Äî sem limites nem ingredientes padr√£o
// ===============================
document.getElementById("salvar-produto").addEventListener("click", () => {
  const nome = document.getElementById("novo-nome").value.trim();
  const categoria = document.getElementById("novo-categoria").value;
  const preco = parseFloat(document.getElementById("novo-preco").value);
  const imagem = document.getElementById("novo-imagem").value.trim();
  const descricao = document.getElementById("novo-descricao").value.trim();

  if (!nome || isNaN(preco) || !imagem || !categoria) {
    alert("Preencha nome, imagem, pre√ßo e categoria!");
    return;
  }

  const grupo = categorias.find(c => c.nome === categoria);
  if (!grupo) return alert("Categoria n√£o encontrada!");

  grupo.itens ||= [];
  grupo.itens.push({
    nome,
    preco,
    imagem,
    descricao,
    limites: {},                // ‚úÖ Nenhum limite padr√£o
    ingredientesPermitidos: {}  // ‚úÖ Nenhum ingrediente at√© edi√ß√£o manual
  });

  document.querySelectorAll("#editor-cardapio input, #editor-cardapio textarea").forEach(i => (i.value = ""));
  refreshCategoriaSelect();
  renderEditorProdutos();
  if (typeof renderCardapio === "function") renderCardapio();
  if (typeof salvarLocal === "function") salvarLocal();

  alert(`‚úÖ Produto "${nome}" criado! Agora edite para escolher os ingredientes.`);
});

// ===============================
// LISTAGEM DE PRODUTOS
// ===============================
function renderEditorProdutos() {
  const container = document.getElementById("produtos-editor");
  if (!container) return;
  container.innerHTML = "";

  categorias.forEach(cat => {
    const divCat = document.createElement("div");
    divCat.innerHTML = `<h3 style="color:var(--secondary);margin-top:1rem;">${cat.nome}</h3>`;
    (cat.itens || []).forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "editor-item";
      div.style = "background:#fff;margin:.3rem 0;padding:.4rem .6rem;border-radius:6px;box-shadow:0 0 3px #ccc;";
      div.innerHTML = `
        <strong>${item.nome}</strong> - R$ ${Number(item.preco || 0).toFixed(2)} 
        <small style="color:#555;">[${item.imagem || ""}]</small><br>
        <em style="font-size:.85rem;color:#777;">${item.descricao || ""}</em><br>
        <button class="btn-edit" onclick="editarProduto('${cat.nome.replace(/'/g, "\\'")}', ${idx})">‚úèÔ∏è Editar</button>
        <button class="btn-delete" onclick="excluirProduto('${cat.nome.replace(/'/g, "\\'")}', ${idx})">üóëÔ∏è Excluir</button>
      `;
      divCat.appendChild(div);
    });
    container.appendChild(divCat);
  });
}

// ===============================
// MODAL DE EDI√á√ÉO DE PRODUTO (sem limites padr√£o)
// ===============================
let itemEmEdicaoRef = null;

(function ensureProdutoModal() {
  if (document.getElementById("produto-modal")) return;
  const modal = document.createElement("div");
  modal.id = "produto-modal";
  modal.style = `
    display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
    align-items:center;justify-content:center;z-index:9999;
  `;
  modal.innerHTML = `
    <div style="background:#fff;width:min(900px,95vw);max-height:90vh;overflow:auto;padding:1rem;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
      <h3>Editar Produto</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
        <div><label>Nome:</label><input type="text" id="pm-nome"></div>
        <div><label>Pre√ßo (R$):</label><input type="number" id="pm-preco" step="0.01"></div>
        <div><label>Imagem:</label><input type="text" id="pm-imagem" placeholder="hadouken.jpg"></div>
        <div style="grid-column:1/-1;"><label>Descri√ß√£o:</label><textarea id="pm-descricao" rows="3"></textarea></div>
      </div>
      <h4 style="margin-top:1rem;">Ingredientes Permitidos por Grupo</h4>
      <p style="margin:.25rem 0 .75rem;color:#555;font-size:.9rem;">
        Marque <strong>Selecionar grupo inteiro</strong> para liberar todas as op√ß√µes do grupo.
        Ou marque ingredientes espec√≠ficos. Cada ingrediente pode ter um <em>valor adicional</em>.
      </p>
      <div id="pm-grupos" style="display:grid;gap:.75rem;"></div>
      <div style="display:flex;gap:.5rem;margin-top:1rem;justify-content:flex-end;">
        <button id="pm-cancelar">Cancelar</button>
        <button id="pm-salvar" class="primary">Salvar Altera√ß√µes</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById("pm-cancelar").onclick = fecharProdutoModal;
  modal.onclick = e => { if (e.target === modal) fecharProdutoModal(); };
})();

function abrirProdutoModal() { document.getElementById("produto-modal").style.display = "flex"; }
function fecharProdutoModal() {
  document.getElementById("produto-modal").style.display = "none";
  itemEmEdicaoRef = null;
}

// ===============================
// ABRIR MODAL DE EDI√á√ÉO DE PRODUTO
// ===============================
function editarProduto(catNome, idx) {
  const categoria = categorias.find(c => c.nome === catNome);
  if (!categoria) return;
  const item = categoria.itens[idx];
  if (!item) return;

  itemEmEdicaoRef = { catNome, idx };
  document.getElementById("pm-nome").value = item.nome || "";
  document.getElementById("pm-preco").value = item.preco || 0;
  document.getElementById("pm-imagem").value = item.imagem || "";
  document.getElementById("pm-descricao").value = item.descricao || "";

  const wrap = document.getElementById("pm-grupos");
  wrap.innerHTML = "";

  (ingredientes || []).forEach(gr => {
    const grupoNome = gr.grupo;
    const opcoes = gr.opcoes || [];
    const permitidos = item.ingredientesPermitidos?.[grupoNome];
    const limiteAtual = item.limites?.[grupoNome] ?? 0;
    const isAll = permitidos === "*" || (Array.isArray(permitidos) && permitidos.length === opcoes.length);

    const bloco = document.createElement("div");
    bloco.className = "pm-grupo";
    bloco.style = "border:1px solid var(--border);border-radius:8px;padding:.6rem;";

    let html = `
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;">
        <div style="font-weight:600;color:var(--primary);">${grupoNome}</div>
        <div style="display:flex;align-items:center;gap:.5rem;">
          <label><input type="checkbox" class="pm-grupo-all" data-grupo="${grupoNome}" ${isAll ? "checked" : ""}> Selecionar grupo inteiro</label>
          <label>Limite: <input type="number" class="pm-grupo-limit" data-grupo="${grupoNome}" min="0" value="${parseInt(limiteAtual) || 0}" style="width:80px;"></label>
        </div>
      </div>
      <div class="pm-grupo-opcoes" data-grupo="${grupoNome}" style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.25rem .75rem;"></div>
    `;
    bloco.innerHTML = html;
    wrap.appendChild(bloco);

    const areaOp = bloco.querySelector(".pm-grupo-opcoes");
    opcoes.forEach(op => {
      const checked = isAll || (Array.isArray(permitidos) && permitidos.includes(op.nome));
      const valor = op.valor ?? 0;
      const opt = document.createElement("label");
      opt.style = "display:flex;align-items:center;gap:.4rem;padding:.2rem 0;";
      opt.innerHTML = `
        <input type="checkbox" class="pm-opcao" data-grupo="${grupoNome}" value="${op.nome}" ${checked ? "checked" : ""} ${isAll ? "disabled" : ""}>
        <span>${op.nome}</span>
        <input type="number" class="pm-opcao-valor" data-grupo="${grupoNome}" data-nome="${op.nome}" step="0.01" min="0" value="${valor}" style="width:70px;border:1px solid #ccc;border-radius:4px;padding:2px 4px;">
      `;
      areaOp.appendChild(opt);
    });
  });

  // Listener: selecionar grupo inteiro
  wrap.querySelectorAll(".pm-grupo-all").forEach(cb => {
    cb.addEventListener("change", e => {
      const grupo = e.target.dataset.grupo;
      const boxArea = wrap.querySelector(`.pm-grupo-opcoes[data-grupo="${grupo}"]`);
      const all = e.target.checked;
      boxArea.querySelectorAll(".pm-opcao").forEach(op => {
        op.checked = all ? true : op.checked;
        op.disabled = all;
      });
    });
  });

  abrirProdutoModal();
}

// ===============================
// SALVAR ALTERA√á√ïES DE PRODUTO (MODAL)
// ===============================
document.getElementById("pm-salvar").addEventListener("click", () => {
  if (!itemEmEdicaoRef) return;
  const { catNome, idx } = itemEmEdicaoRef;
  const categoria = categorias.find(c => c.nome === catNome);
  if (!categoria) return;
  const item = categoria.itens[idx];
  if (!item) return;

  // Campos b√°sicos
  item.nome = document.getElementById("pm-nome").value.trim();
  item.preco = parseFloat(document.getElementById("pm-preco").value) || 0;
  item.imagem = document.getElementById("pm-imagem").value.trim();
  item.descricao = document.getElementById("pm-descricao").value.trim();

  // Ingredientes e limites ‚Äî limpeza completa
  item.ingredientesPermitidos = {};
  item.limites = {};

  const wrap = document.getElementById("pm-grupos");
  wrap.querySelectorAll(".pm-grupo").forEach(bloco => {
    const grpName = bloco.querySelector(".pm-grupo-opcoes").dataset.grupo;
    const allCheck = bloco.querySelector(`.pm-grupo-all[data-grupo="${grpName}"]`);
    const limitInput = bloco.querySelector(`.pm-grupo-limit[data-grupo="${grpName}"]`);
    const limitVal = parseInt(limitInput.value) || 0;

    item.limites[grpName] = limitVal;

    if (allCheck && allCheck.checked) {
      item.ingredientesPermitidos[grpName] = "*";
      return;
    }

    const selecionados = [...bloco.querySelectorAll(`.pm-opcao[data-grupo="${grpName}"]`)]
      .filter(i => i.checked)
      .map(i => i.value);

    if (selecionados.length > 0) item.ingredientesPermitidos[grpName] = selecionados;
  });

  fecharProdutoModal();
  renderEditorProdutos();
  if (typeof renderCardapio === "function") renderCardapio();
  if (typeof salvarLocal === "function") salvarLocal();
});

// ===============================
// EXCLUIR PRODUTO (corrigido v9.6)
// ===============================
function excluirProduto(catNome, idx) {
  const categoria = categorias.find(c => c.nome === catNome);
  if (!categoria) return;

  const produto = categoria.itens[idx];
  if (!produto) return;

  if (confirm(`üóëÔ∏è Deseja realmente excluir "${produto.nome}"?`)) {
    categoria.itens.splice(idx, 1);
    renderEditorProdutos();
    if (typeof renderCardapio === "function") renderCardapio();
    if (typeof salvarLocal === "function") salvarLocal();
    alert(`‚úÖ Produto "${produto.nome}" removido com sucesso!`);
  }
}

// ===============================
// RENDERIZA√á√ÉO DO EDITOR DE INGREDIENTES (v9.7 completo)
// ===============================
function renderEditorIngredientes() {
  const cont = document.getElementById("ingredientes-editor");
  if (!cont) return;
  cont.innerHTML = "";

  if (!ingredientes?.length) {
    cont.innerHTML = `<p style="color:#777;">Nenhum grupo de ingredientes cadastrado ainda.</p>`;
    return;
  }

  ingredientes.forEach(gr => {
    const div = document.createElement("div");
    div.className = "ingrediente-grupo-editor";
    div.style = `
      background:#fff;
      margin:1rem 0;
      padding:0.8rem;
      border-radius:8px;
      box-shadow:0 0 5px rgba(0,0,0,0.1);
    `;
    div.innerHTML = `<h4 style="color:var(--primary);margin-bottom:0.5rem;">${gr.grupo}</h4>`;

    if (!gr.opcoes || !gr.opcoes.length) {
      div.innerHTML += `<p style="color:#999;">Nenhum ingrediente neste grupo.</p>`;
    } else {
      gr.opcoes.forEach((op, idx) => {
        const linha = document.createElement("div");
        linha.style = `
          display:flex;
          justify-content:space-between;
          align-items:center;
          flex-wrap:wrap;
          border-bottom:1px solid #eee;
          padding:4px 0;
        `;

        const valor = Number(op.valor || 0);
        const pausado = op.pausado === true;

        linha.innerHTML = `
          <div style="flex:1;">
            <span style="${pausado ? "color:#999;text-decoration:line-through;" : "color:#222;"}">
              ${op.nome}
            </span>
            <small style="color:#555;">(R$ ${valor.toFixed(2)})</small>
          </div>
          <div style="display:flex;align-items:center;gap:.3rem;">
            <input type="number" step="0.01" min="0" value="${valor}" 
                   style="width:70px;padding:3px 4px;border:1px solid #ccc;border-radius:4px;"
                   onchange="atualizarValorIngrediente('${gr.grupo.replace(/'/g, "\\'")}', ${idx}, this.value)">
            <button class="${pausado ? "btn-on" : "btn-off"}"
                    onclick="alternarIngrediente('${gr.grupo.replace(/'/g, "\\'")}', ${idx})">
              ${pausado ? "Ativar" : "Pausar"}
            </button>
            <button class="btn-delete"
                    onclick="excluirIngrediente('${gr.grupo.replace(/'/g, "\\'")}', ${idx})">üóëÔ∏è</button>
          </div>
        `;

        div.appendChild(linha);
      });
    }

    cont.appendChild(div);
  });
}

// ===============================
// CRIAR NOVO GRUPO DE INGREDIENTES
// ===============================
document.getElementById("salvar-grupo").addEventListener("click", () => {
  const nomeGrupo = document.getElementById("novo-grupo-nome").value.trim();
  if (!nomeGrupo) return alert("Digite o nome do grupo de ingredientes!");
  if (ingredientes.some(g => g.grupo.toLowerCase() === nomeGrupo.toLowerCase()))
    return alert("‚ö†Ô∏è J√° existe um grupo com esse nome!");

  ingredientes.push({ grupo: nomeGrupo, opcoes: [] });
  document.getElementById("novo-grupo-nome").value = "";
  if (typeof salvarLocal === "function") salvarLocal();
  if (typeof atualizarSelectGrupos === "function") atualizarSelectGrupos();
  renderEditorIngredientes();
  alert(`‚úÖ Grupo "${nomeGrupo}" criado com sucesso!`);
});

// ===============================
// ATUALIZA SELECT DE GRUPOS
// ===============================
function atualizarSelectGrupos() {
  const select = document.getElementById("novo-grupo");
  if (!select) return;
  select.innerHTML = "";
  ingredientes.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g.grupo;
    opt.textContent = g.grupo;
    select.appendChild(opt);
  });
}

// ===============================
// ADICIONAR NOVO INGREDIENTE AO GRUPO
// ===============================
document.getElementById("salvar-ingrediente").addEventListener("click", () => {
  const grupoNome = document.getElementById("novo-grupo").value;
  const nomeIng = document.getElementById("novo-ingrediente").value.trim();
  const valor = parseFloat(document.getElementById("novo-ingrediente-valor").value) || 0;
  if (!grupoNome || !nomeIng) return alert("Selecione o grupo e digite o nome do ingrediente!");
  const grupo = ingredientes.find(g => g.grupo === grupoNome);
  if (!grupo) return alert("Grupo n√£o encontrado!");
  grupo.opcoes ||= [];
  if (grupo.opcoes.some(o => o.nome.toLowerCase() === nomeIng.toLowerCase()))
    return alert("‚ö†Ô∏è Este ingrediente j√° existe neste grupo!");

  grupo.opcoes.push({ nome: nomeIng, valor, pausado: false });
  document.getElementById("novo-ingrediente").value = "";
  document.getElementById("novo-ingrediente-valor").value = "";
  if (typeof salvarLocal === "function") salvarLocal();
  renderEditorIngredientes();
  alert(`‚úÖ Ingrediente "${nomeIng}" adicionado ao grupo "${grupoNome}"!`);
});


// ===============================
// FUN√á√ÉO: ATUALIZAR VALOR DO INGREDIENTE
// ===============================
function atualizarValorIngrediente(grupoNome, idx, novoValor) {
  const grupo = ingredientes.find(g => g.grupo === grupoNome);
  if (!grupo) return;
  grupo.opcoes[idx].valor = parseFloat(novoValor) || 0;
  if (typeof salvarLocal === "function") salvarLocal();
  if (typeof renderCardapio === "function") renderCardapio();
}

// ===============================
// FUN√á√ÉO: PAUSAR / ATIVAR INGREDIENTE
// ===============================
function alternarIngrediente(grupoNome, idx) {
  const grupo = ingredientes.find(g => g.grupo === grupoNome);
  if (!grupo) return;
  grupo.opcoes[idx].pausado = !grupo.opcoes[idx].pausado;
  if (typeof salvarLocal === "function") salvarLocal();
  renderEditorIngredientes();
  if (typeof renderCardapio === "function") renderCardapio(); // atualiza card√°pio do cliente
}

// ===============================
// FUN√á√ÉO: EXCLUIR INGREDIENTE
// ===============================
function excluirIngrediente(grupoNome, idx) {
  const grupo = ingredientes.find(g => g.grupo === grupoNome);
  if (!grupo) return;
  const ing = grupo.opcoes[idx];
  if (confirm(`Excluir o ingrediente "${ing.nome}"?`)) {
    grupo.opcoes.splice(idx, 1);
    if (typeof salvarLocal === "function") salvarLocal();
    renderEditorIngredientes();
    if (typeof renderCardapio === "function") renderCardapio();
  }
}


</script>

<script>
/* =========================================================
   BLOCO 6 ‚Äî EXPORTA√á√ÉO FUNCIONAL GARANTIDA (v10.1)
   Gera .JSON e .TXT mesmo offline / local / GitHub
========================================================= */

// Caminho online (usado s√≥ quando publicado no GitHub Pages)
const JSON_URL = "cardapio_palatarius.json";

// ----------------------------------------------------------
// RESTAURA√á√ÉO SEGURA  (ignora falhas de rede sem travar nada)
// ----------------------------------------------------------
async function restaurarLocal() {
  try {
    const response = await fetch(JSON_URL + "?v=" + Date.now());
    if (!response.ok) throw new Error("Erro ao buscar remoto");
    const data = await response.json();
    categorias = data.categorias || [];
    ingredientes = data.ingredientes || [];
    renderCardapio(); renderEditorProdutos(); renderEditorIngredientes();
    localStorage.setItem("palatarius_data", JSON.stringify(data));
    console.log("‚úÖ Dados carregados do GitHub Pages.");
  } catch (err) {
    console.warn("‚ö†Ô∏è  Falha de rede ou CORS ‚Äî usando dados locais.", err);
    const local = localStorage.getItem("palatarius_data");
    if (local) {
      const obj = JSON.parse(local);
      categorias = obj.categorias || [];
      ingredientes = obj.ingredientes || [];
    }
    renderCardapio(); renderEditorProdutos(); renderEditorIngredientes();
  }
}

// ----------------------------------------------------------
// EXPORTADOR UNIVERSAL  (.json ou .txt)
// ----------------------------------------------------------
function exportarCardapio(formato = "json") {
  try {
    const data = {
      atualizado_em: new Date().toISOString(),
      versao: "10.1",
      categorias: JSON.parse(JSON.stringify(categorias || [])),
      ingredientes: JSON.parse(JSON.stringify(ingredientes || []))
    };

    data.ingredientes.forEach(gr => {
      gr.opcoes = gr.opcoes.map(op => ({
        nome: op.nome || "Ingrediente",
        valor: op.valor !== undefined ? Number(op.valor) : 0,
        pausado: !!op.pausado
      }));
    });

    const conteudo = JSON.stringify(data, null, 2);
    const tipo = formato === "txt" ? "text/plain" : "application/json";
    const nome = formato === "txt" ? "cardapio_palatarius.txt" : "cardapio_palatarius.json";

    const blob = new Blob([conteudo], { type: tipo });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = nome;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);

    console.log(`‚úÖ Exportado ${nome} (${blob.size} bytes)`);
    alert(`üì¶ Card√°pio exportado com sucesso!\nArquivo: ${nome}`);
  } catch (err) {
    console.error("‚ùå Erro ao exportar:", err);
    alert("Erro ao gerar o arquivo. Veja o console (F12).");
  }
}

// ----------------------------------------------------------
// BOT√ïES DE EXPORTA√á√ÉO + FECHAR EDITOR (sempre criados)
// ----------------------------------------------------------
window.addEventListener("load", async () => {
  // tenta carregar dados (mas n√£o trava se falhar)
  try { await restaurarLocal(); } catch(e) {}

  const editor = document.getElementById("editor-cardapio");
  if (editor) {
    // bot√£o JSON
    const btnJson = document.createElement("button");
    btnJson.textContent = "üì§ Exportar JSON (Online)";
    btnJson.className = "primary";
    btnJson.style = "margin-top:1rem;";
    btnJson.onclick = () => exportarCardapio("json");

    // bot√£o TXT
    const btnTxt = document.createElement("button");
    btnTxt.textContent = "üßæ Exportar TXT (Offline)";
    btnTxt.className = "secondary";
    btnTxt.style = "margin-top:0.5rem;";
    btnTxt.onclick = () => exportarCardapio("txt");

    editor.appendChild(btnJson);
    editor.appendChild(btnTxt);
  }

  const closeBtn = document.getElementById("close-editor");
  if (closeBtn)
    closeBtn.onclick = () => {
      localStorage.setItem("palatarius_data", JSON.stringify({ categorias, ingredientes }));
      document.getElementById("editor-screen").classList.remove("active");
      alert("‚úÖ Editor fechado. Exporte o JSON/TXT para salvar as altera√ß√µes!");
    };

  console.log("üöÄ Palatarius v10.1 ‚Äî bot√£o de exporta√ß√£o sempre ativo.");
});
</script>
<script>
const btnVisite = document.getElementById("visite-btn");
const modalVisite = document.getElementById("visite-modal");
const fecharVisite = document.getElementById("fechar-visite");

btnVisite.addEventListener("click", () => modalVisite.style.display = "flex");
fecharVisite.addEventListener("click", () => modalVisite.style.display = "none");
modalVisite.addEventListener("click", e => {
  if (e.target === modalVisite) modalVisite.style.display = "none";
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const slides = document.querySelectorAll(".banner-slide");
  if (slides.length === 0) return;

  let currentBanner = 0;
  slides[currentBanner].classList.add("active");

  // Fun√ß√£o para trocar banner
  function trocarBanner() {
    slides[currentBanner].classList.remove("active");
    currentBanner = (currentBanner + 1) % slides.length;
    slides[currentBanner].classList.add("active");
  }

  // Troca autom√°tica a cada 5 segundos
  setInterval(trocarBanner, 5000);

  // ‚úÖ Garante visibilidade no mobile: define altura ap√≥s carregamento da imagem
  slides.forEach(slide => {
    const img = slide.querySelector("img");
    img.addEventListener("load", () => {
      slide.style.display = "block";
    });
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const overlay  = document.getElementById("loja-fechada-overlay");
  const contador = document.getElementById("contador");
  const titulo   = document.getElementById("contador-titulo");

  // ==============================
  // CONFIGURA√á√ïES
  // ==============================
  // ‚è∞ Hor√°rio de funcionamento
  const HORA_ABRE = 18, MIN_ABRE = 0;
  const HORA_FECHA = 23, MIN_FECHA = 30;

  // üö™ Fechar todo S√ÅBADO (0=Dom, 1=Seg, ... 6=S√°b)
  const FECHA_TODO_SABADO = true;

  function dentroDoHorario(hora, minuto) {
    const abre   = (hora > HORA_ABRE) || (hora === HORA_ABRE && minuto >= MIN_ABRE);
    const fecha  = (hora < HORA_FECHA) || (hora === HORA_FECHA && minuto <= MIN_FECHA);
    return abre && fecha;
  }

  function proximaDataAbertura(base = new Date()) {
    const d = new Date(base);
    d.setHours(HORA_ABRE, MIN_ABRE, 0, 0);

    // se j√° passou do hor√°rio de hoje ‚Üí pr√≥ximo dia
    if (base > d) d.setDate(d.getDate() + 1);

    // se cair no s√°bado, pula para domingo
    if (FECHA_TODO_SABADO && d.getDay() === 6) {
      d.setDate(d.getDate() + 1);
    }

    return d;
  }

  function atualizarStatusLoja() {
    const agora   = new Date();
    const hora    = agora.getHours();
    const minuto  = agora.getMinutes();
    const dia     = agora.getDay(); // 0 dom ... 6 s√°b

    // üö´ FECHADO AOS S√ÅBADOS
    if (FECHA_TODO_SABADO && dia === 6) {
      overlay.classList.add("active");
      titulo.textContent = "üõë Fechado hoje (S√°bado)";
      contador.textContent = "Voltamos amanh√£ √†s 18:00";
      return;
    }

    // Dentro do hor√°rio normal?
    const aberta = dentroDoHorario(hora, minuto);
    if (aberta) {
      overlay.classList.remove("active");
      return;
    }

    // Pr√≥xima abertura
    const prox = proximaDataAbertura(agora);
    const diff = prox - agora;

    const horas   = Math.floor(diff / 1000 / 60 / 60);
    const minutos = Math.floor((diff / 1000 / 60) % 60);
    const segundos= Math.floor((diff / 1000) % 60);

    titulo.textContent = "‚è≥ Reabriremos em:";
    contador.textContent =
      `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}:${String(segundos).padStart(2,'0')}`;

    overlay.classList.add("active");
  }

  atualizarStatusLoja();
  setInterval(atualizarStatusLoja, 1000);
});
</script>

</body>
</html>








