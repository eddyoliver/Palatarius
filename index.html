<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palatarius – Cardápio Digital</title>
  <style>
    /* Paleta de cores do tema */
    :root {
      --bg-base: #0B0B0F;
      --primary-red: #E53935;
      --primary-yellow: #FFD60A;
      --primary-white: #FFFFFF;
      --gray-dark: #151515;
      --gray-medium: #232323;
      --gray-light: #BDBDBD;
      --radius-card: 16px;
      --radius-input: 8px;
      --shadow: 0 4px 8px rgba(0,0,0,0.3);
      --font-size-base: 1rem;
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: var(--primary-white);
      background: var(--bg-base);
      overflow-x: hidden;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
    }
    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.2rem; }
    p { margin: 0.2rem 0; }

    /* Cabeçalho */
    header {
      padding: 1rem;
      text-align: center;
      background-color: var(--gray-dark);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    header h1 {
      color: var(--primary-yellow);
      font-size: 1.8rem;
    }

    /* Conteúdo principal dividido em telas */
    section {
      display: none;
      padding: 1rem;
    }
    section.active {
      display: block;
    }

    /* Formulário de dados do cliente */
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.3rem;
      color: var(--primary-white);
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.6rem;
      border-radius: var(--radius-input);
      border: none;
      /* Para os campos de edição ficarem visíveis sobre o fundo escuro,
         use um tom médio de cinza que contraste com o fundo mais escuro */
      background-color: var(--gray-medium);
      color: var(--primary-white);
      font-size: 1rem;
      /* contorno suave para melhor distinção */
      box-shadow: inset 0 0 0 1px var(--gray-light);
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--primary-red);
    }
    .row {
      display: flex;
      gap: 0.5rem;
    }
    .row .form-group {
      flex: 1;
    }

    /* Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: var(--radius-input);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-primary {
      background-color: var(--primary-red);
      color: var(--primary-white);
    }
    .btn-primary:hover {
      background-color: #c62828;
    }
    .btn-secondary {
      background-color: var(--primary-yellow);
      color: var(--bg-base);
    }
    .btn-secondary:hover {
      background-color: #e6c50a;
    }
    .btn-small {
      font-size: 0.9rem;
      padding: 0.4rem 0.6rem;
      min-height: 36px;
    }

    /* Navegação de categorias */
    .category-nav {
      display: flex;
      overflow-x: auto;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }
    .category-nav button {
      flex: 1 0 auto;
      white-space: nowrap;
      padding: 0.6rem 1rem;
      border-radius: var(--radius-input);
      border: none;
      background-color: var(--gray-dark);
      color: var(--primary-white);
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
    }
    .category-nav button.active {
      background-color: var(--primary-red);
      color: var(--primary-white);
    }

    /* Cards de produtos */
    .product-card {
      background-color: var(--gray-dark);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .product-image {
      position: relative;
      width: 100%;
      /* mantenha a proporção 4/3 */
      aspect-ratio: 4 / 3;
      background-color: var(--gray-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-light);
      font-size: 2rem;
    }
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-top-left-radius: var(--radius-card);
      border-top-right-radius: var(--radius-card);
    }
    .product-content {
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .product-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-yellow);
    }
    .product-desc {
      font-size: 0.9rem;
      color: var(--gray-light);
    }
    .product-price {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-yellow);
    }
    .product-actions {
      margin-top: auto;
      display: flex;
      justify-content: flex-end;
    }
    .product-actions button {
      margin-left: auto;
    }

    /* Badge do carrinho flutuante */
    .cart-badge {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background-color: var(--primary-red);
      color: var(--primary-white);
      padding: 0.6rem 1rem;
      border-radius: 50px;
      box-shadow: var(--shadow);
      font-weight: 600;
      cursor: pointer;
      z-index: 1000;
    }
    .cart-badge span {
      margin-left: 0.4rem;
      font-weight: 700;
    }

    /* Tela de carrinho */
    .cart-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      margin-bottom: 1rem;
      background-color: var(--gray-dark);
      border-radius: var(--radius-card);
      padding: 0.6rem;
      box-shadow: var(--shadow);
    }
    .cart-item img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart-item-details {
      flex: 1;
    }
    .cart-item-title {
      font-weight: 600;
      color: var(--primary-yellow);
    }
    .cart-item-options {
      font-size: 0.85rem;
      color: var(--gray-light);
      margin-top: 0.2rem;
    }
    .cart-item-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .quantity-control {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .quantity-control button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: none;
      background-color: var(--primary-yellow);
      color: var(--bg-base);
      font-weight: 700;
      cursor: pointer;
    }
    .cart-totals {
      margin-top: 1rem;
      background-color: var(--gray-dark);
      padding: 1rem;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
    }
    .cart-totals div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.4rem;
      font-size: 1rem;
    }
    .cart-totals div.total {
      font-weight: 700;
      color: var(--primary-yellow);
    }

    /* Modal de montagem */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background-color: var(--gray-medium);
      color: var(--primary-white);
      border-radius: var(--radius-card);
      padding: 1rem;
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    .modal h2 {
      margin-bottom: 0.8rem;
      color: var(--primary-yellow);
    }
    .modal-section {
      margin-bottom: 1rem;
    }
    .modal-section label {
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }
    .modal-section .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .option-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.4rem 0.6rem;
      border-radius: var(--radius-input);
      background-color: var(--gray-dark);
      cursor: pointer;
      font-size: 0.9rem;
    }
    .option-item input {
      margin-right: 0.3rem;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .modal-actions button {
      flex: 1;
    }

    .error {
      color: var(--primary-red);
      font-size: 0.85rem;
      margin-top: 0.3rem;
    }

    @media (min-width: 768px) {
      .product-card {
        flex-direction: row;
      }
      .product-image {
        width: 40%;
        height: auto;
      }
      .product-content {
        width: 60%;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>Palatarius</h1>
  </header>

  <!-- Cliente -->
  <section id="customer-screen" class="active">
    <h2>Dados do Cliente</h2>
    <form id="customer-form">
      <div class="form-group">
        <label>Nome completo *</label>
        <input type="text" id="customer-name" required>
        <div class="error" id="error-name"></div>
      </div>
      <div class="form-group">
        <label>Telefone *</label>
        <input type="tel" id="customer-phone" required placeholder="(21) 99999-9999">
        <div class="error" id="error-phone"></div>
      </div>
      <div class="form-group">
        <label>Tipo de pedido *</label>
        <select id="order-type">
          <option value="Entrega">Entrega</option>
          <option value="Retirada">Retirada</option>
        </select>
      </div>
      <div id="delivery-fields" style="display:none;">
        <div class="form-group">
          <label>Logradouro *</label>
          <input type="text" id="address-logradouro">
          <div class="error" id="error-logradouro"></div>
        </div>
        <div class="row">
          <div class="form-group">
            <label>Número *</label>
            <input type="text" id="address-number">
            <div class="error" id="error-number"></div>
          </div>
          <div class="form-group">
            <label>Complemento</label>
            <input type="text" id="address-complement">
          </div>
        </div>
        <div class="form-group">
          <label>Bairro *</label>
          <input type="text" id="address-bairro">
          <div class="error" id="error-bairro"></div>
        </div>
        <div class="form-group">
          <label>Marco</label>
          <input type="text" id="address-marco">
        </div>
        <div class="form-group">
          <label>Cidade</label>
          <input type="text" value="Seropédica-RJ" readonly>
        </div>
        <div class="form-group">
          <label>KM *</label>
          <select id="address-km">
            <option value="39">KM 39</option>
            <option value="40">KM 40</option>
            <option value="41">KM 41</option>
            <option value="42">KM 42</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group" id="uber-freight-group" style="display:none;">
          <label>Frete (R$) *</label>
          <input type="number" id="uber-freight" step="0.01" min="0">
          <div class="error" id="error-freight"></div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Continuar → Cardápio</button>
      <p style="margin-top:1rem; font-size:0.9rem;">
        <a href="#" id="customer-editor-link" style="color: var(--primary-yellow); text-decoration: underline; cursor: pointer;">
          Área do Editor
        </a>
      </p>
    </form>
  </section>

  <!-- Cardápio -->
  <section id="menu-screen">
    <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
      <input type="text" id="search-input" placeholder="Buscar no cardápio..." style="flex:1; margin-right:0.5rem;">
      <button id="menu-exit" class="btn btn-secondary btn-small">Editar Dados</button>
    </div>
    <div class="category-nav" id="category-nav"></div>
    <div id="products-container"></div>
    <div id="cart-badge" class="cart-badge" style="display:none;">
      Carrinho <span id="cart-count">0</span>
    </div>
  </section>

  <!-- Carrinho -->
  <section id="cart-screen">
    <h2>Seu Pedido</h2>
    <div id="cart-items"></div>
    <div class="form-group">
      <label>Observações</label>
      <textarea id="cart-observations" rows="3" placeholder="Ex: sem cebola, ponto bem passado..."></textarea>
    </div>
    <div class="cart-totals">
      <div><span>Subtotal</span> <span id="subtotal">R$ 0,00</span></div>
      <div id="freight-row" style="display:none;"><span>Frete</span> <span id="freight">R$ 0,00</span></div>
      <div class="total"><span>Total</span> <span id="total">R$ 0,00</span></div>
    </div>
    <div style="display:flex; gap:0.5rem; margin-top:1rem;">
      <button id="back-to-menu" class="btn btn-secondary">Continuar Comprando</button>
      <button id="checkout-whatsapp" class="btn btn-primary">Enviar no WhatsApp</button>
    </div>
    <button id="print-coupon" class="btn btn-small" style="margin-top:0.5rem; width:100%;">Gerar Cupom</button>
  </section>

  <!-- Modal de Montagem -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2 id="modal-title">Monte seu prato</h2>
      <div id="modal-content"></div>
      <div class="modal-actions">
        <button id="modal-cancel" class="btn btn-secondary">Cancelar</button>
        <button id="modal-save" class="btn btn-primary">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- Tela do Editor -->
  <section id="editor-screen">
    <h2>Editor do Cardápio</h2>
    <button id="editor-add-category" class="btn btn-primary" style="margin-bottom:1rem;">+ Nova Categoria</button>
    <div id="editor-categories"></div>
    <div style="margin-top:2rem; display:flex; gap:0.5rem;">
      <button id="editor-cancel" class="btn btn-secondary">Cancelar</button>
      <button id="editor-save" class="btn btn-primary">Salvar Cardápio</button>
      <button id="editor-export" class="btn btn-secondary">Exportar HTML</button>
    </div>
  </section>

  <script>
    // === DADOS GLOBAIS ===
    let categories = [];
    let activeCategory = '';
    let customer = { address: {} };
    let cart = [];
    let cartObservations = '';
    let modalProduct = null;
    let proteins = [];
    let ingredients = [];
    let sauces = [];
    let extras = [];
    let acaiFlavors = [];
    let iceCreamFlavors = [];
    let toppings = [];
    let syrups = [];
    let assets = {};
    let users = {};

    // Senha do editor
    function getEditorPassword() {
      return 'EdLeoMarc&2025';
    }

    // === LOCALSTORAGE ===
    function saveToStorage() {
      localStorage.setItem('palatarius_categories', JSON.stringify(categories));
      localStorage.setItem('palatarius_proteins', JSON.stringify(proteins));
      localStorage.setItem('palatarius_ingredients', JSON.stringify(ingredients));
      localStorage.setItem('palatarius_sauces', JSON.stringify(sauces));
      localStorage.setItem('palatarius_extras', JSON.stringify(extras));
      localStorage.setItem('palatarius_acaiFlavors', JSON.stringify(acaiFlavors));
      localStorage.setItem('palatarius_iceCreamFlavors', JSON.stringify(iceCreamFlavors));
      localStorage.setItem('palatarius_toppings', JSON.stringify(toppings));
      localStorage.setItem('palatarius_syrups', JSON.stringify(syrups));
      localStorage.setItem('palatarius_customer', JSON.stringify(customer));
      localStorage.setItem('palatarius_cart', JSON.stringify(cart));
      localStorage.setItem('palatarius_observations', cartObservations);
    }

    function loadFromStorage() {
      const cat = localStorage.getItem('palatarius_categories');
      if (cat) categories = JSON.parse(cat);
      const prot = localStorage.getItem('palatarius_proteins');
      if (prot) proteins = JSON.parse(prot);
      const ing = localStorage.getItem('palatarius_ingredients');
      if (ing) ingredients = JSON.parse(ing);
      const sau = localStorage.getItem('palatarius_sauces');
      if (sau) sauces = JSON.parse(sau);
      const ext = localStorage.getItem('palatarius_extras');
      if (ext) extras = JSON.parse(ext);
      const acai = localStorage.getItem('palatarius_acaiFlavors');
      if (acai) acaiFlavors = JSON.parse(acai);
      const ice = localStorage.getItem('palatarius_iceCreamFlavors');
      if (ice) iceCreamFlavors = JSON.parse(ice);
      const top = localStorage.getItem('palatarius_toppings');
      if (top) toppings = JSON.parse(top);
      const syr = localStorage.getItem('palatarius_syrups');
      if (syr) syrups = JSON.parse(syr);
      const cust = localStorage.getItem('palatarius_customer');
      if (cust) customer = JSON.parse(cust);
      const c = localStorage.getItem('palatarius_cart');
      if (c) cart = JSON.parse(c);
      cartObservations = localStorage.getItem('palatarius_observations') || '';
    }

    function saveUsers(u) {
      localStorage.setItem('palatarius_users', JSON.stringify(u));
    }

    function loadUsers() {
      return JSON.parse(localStorage.getItem('palatarius_users')) || {};
    }

    // === NAVEGAÇÃO ENTRE TELAS ===
    function showScreen(screenId) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if (screenId === 'menu-screen') updateCartBadge();
    }

    // === VALIDAÇÃO DO CLIENTE ===
    function validateCustomerForm() {
      let ok = true;
      const name = document.getElementById('customer-name').value.trim();
      const phone = document.getElementById('customer-phone').value.replace(/\D/g, '');
      const type = document.getElementById('order-type').value;

      document.querySelectorAll('.error').forEach(e => e.textContent = '');

      if (!name) { document.getElementById('error-name').textContent = 'Preencha o nome.'; ok = false; }
      if (!/^\d{10,11}$/.test(phone)) { document.getElementById('error-phone').textContent = 'Telefone inválido.'; ok = false; }

      if (type === 'Entrega') {
        const log = document.getElementById('address-logradouro').value.trim();
        const num = document.getElementById('address-number').value.trim();
        const bairro = document.getElementById('address-bairro').value.trim();
        const km = document.getElementById('address-km').value;
        const freight = document.getElementById('uber-freight').value;

        if (!log) { document.getElementById('error-logradouro').textContent = 'Preencha o logradouro.'; ok = false; }
        if (!num) { document.getElementById('error-number').textContent = 'Preencha o número.'; ok = false; }
        if (!bairro) { document.getElementById('error-bairro').textContent = 'Preencha o bairro.'; ok = false; }
        if (km === 'Outro' && (!freight || parseFloat(freight) <= 0)) {
          document.getElementById('error-freight').textContent = 'Informe o frete.'; ok = false; }
        }
        customer.address = {
          logradouro: log,
          number: num,
          complement: document.getElementById('address-complement').value.trim(),
          bairro: bairro,
          marco: document.getElementById('address-marco').value.trim(),
          cidade: document.getElementById('address-cidade').value,
          km: km,
          freight: freight || '0'
        };
      }

      if (ok) {
        customer.name = name;
        customer.phone = phone;
        customer.type = type;
        saveToStorage();
      }
      return ok;
    }

    // === RENDERIZAÇÃO ===
    function renderCategories() {
      const nav = document.getElementById('category-nav');
      nav.innerHTML = '';
      if (categories.length === 0) return;
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.name;
        btn.onclick = () => {
          activeCategory = cat.key;
          renderCategories();
          renderProducts();
        };
        if (cat.key === activeCategory) btn.classList.add('active');
        nav.appendChild(btn);
      });
      if (!activeCategory && categories[0]) activeCategory = categories[0].key;
    }

    function renderProducts() {
      const container = document.getElementById('products-container');
      container.innerHTML = '';
      const search = document.getElementById('search-input').value.toLowerCase();
      const cat = categories.find(c => c.key === activeCategory);
      if (!cat) return;

      const filtered = cat.products.filter(p =>
        p.name.toLowerCase().includes(search) ||
        (p.description && p.description.toLowerCase().includes(search))
      );

      filtered.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';

        const imgDiv = document.createElement('div');
        imgDiv.className = 'product-image';
        if (product.imageUrl) {
          const img = document.createElement('img');
          img.src = product.imageUrl;
          img.alt = product.name;
          img.onerror = () => { imgDiv.innerHTML = '<div style="text-align:center;">Foto em breve</div>'; };
          imgDiv.appendChild(img);
        } else if (product.image) {
          const img = document.createElement('img');
          img.src = `assets/images/${product.image}`;
          img.alt = product.name;
          img.onerror = () => { imgDiv.innerHTML = '<div style="text-align:center;">Foto em breve</div>'; };
          imgDiv.appendChild(img);
        } else {
          imgDiv.innerHTML = '<div style="text-align:center;">Foto em breve</div>';
        }

        const content = document.createElement('div');
        content.className = 'product-content';
        content.innerHTML = `
          <div class="product-title">${product.name}</div>
          ${product.description ? `<div class="product-desc">${product.description}</div>` : ''}
          <div class="product-price">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</div>
          <div class="product-actions">
            <button class="btn btn-primary btn-small" onclick='openModal(${JSON.stringify(product).split('"').join('&quot;')})'>Adicionar</button>
          </div>
        `;
        card.appendChild(imgDiv);
        card.appendChild(content);
        container.appendChild(card);
      });
    }

    function updateCartBadge() {
      const badge = document.getElementById('cart-badge');
      const count = cart.reduce((s, i) => s + i.quantity, 0);
      const span = document.getElementById('cart-count');
      if (count > 0) {
        span.textContent = count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    // === MODAL ===
    function openModal(product) {
      modalProduct = { ...product, quantity: 1, options: {} };
      const title = document.getElementById('modal-title');
      title.textContent = product.name;

      const content = document.getElementById('modal-content');
      content.innerHTML = '';

      if (product.customizable) {
        // Adicionar opções de customização aqui
        const section = document.createElement('div');
        section.className = 'modal-section';
        section.innerHTML = `<label>Escolha uma opção:</label><div class="options"></div>`;
        content.appendChild(section);
      }

      document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      modalProduct = null;
    }

    function saveModal() {
      if (!modalProduct) return;
      const existing = cart.find(i => i.id === modalProduct.id);
      if (existing) {
        existing.quantity += modalProduct.quantity;
      } else {
        cart.push({ ...modalProduct });
      }
      saveToStorage();
      updateCartBadge();
      renderCart();
      closeModal();
    }

    // === CARRINHO ===
    function renderCart() {
      const container = document.getElementById('cart-items');
      container.innerHTML = '';
      let subtotal = 0;
      cart.forEach((item, index) => {
        const price = parseFloat(item.price) * item.quantity;
        subtotal += price;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <img src="${item.image ? 'assets/images/' + item.image : ''}" onerror="this.style.display='none'">
          <div class="cart-item-details">
            <div class="cart-item-title">${item.name}</div>
            <div class="cart-item-options">R$ ${parseFloat(item.price).toFixed(2)} x ${item.quantity}</div>
          </div>
          <div class="cart-item-actions">
            <div class="quantity-control">
              <button onclick="updateQuantity(${index}, -1)">-</button>
              <span>${item.quantity}</span>
              <button onclick="updateQuantity(${index}, 1)">+</button>
            </div>
            <button class="btn btn-small" style="margin-top:0.5rem; background:#E53935;" onclick="removeFromCart(${index})">Remover</button>
          </div>
        `;
        container.appendChild(div);
      });

      const freight = customer.type === 'Entrega' && customer.address.freight ? parseFloat(customer.address.freight) : 0;
      document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
      document.getElementById('freight').textContent = `R$ ${freight.toFixed(2).replace('.', ',')}`;
      document.getElementById('freight-row').style.display = freight > 0 ? 'flex' : 'none';
      document.getElementById('total').textContent = `R$ ${(subtotal + freight).toFixed(2).replace('.', ',')}`;
    }

    function updateQuantity(index, delta) {
      cart[index].quantity = Math.max(1, cart[index].quantity + delta);
      saveToStorage();
      renderCart();
      updateCartBadge();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      saveToStorage();
      renderCart();
      updateCartBadge();
    }

    // === WHATSAPP ===
    function buildWhatsAppMessage() {
      let msg = `*PEDIDO - PALATARIUS*%0A%0A`;
      msg += `*Cliente:* ${customer.name}%0A`;
      msg += `*Telefone:* ${customer.phone}%0A`;
      msg += `*Tipo:* ${customer.type}%0A`;
      if (customer.type === 'Entrega') {
        msg += `*Endereço:* ${customer.address.logradouro}, ${customer.address.number}`;
        if (customer.address.complement) msg += ` - ${customer.address.complement}`;
        msg += `, ${customer.address.bairro}, ${customer.address.cidade} (KM ${customer.address.km})%0A`;
        if (customer.address.marco) msg += `*Marco:* ${customer.address.marco}%0A`;
        if (customer.address.freight > 0) msg += `*Frete:* R$ ${parseFloat(customer.address.freight).toFixed(2)}%0A`;
      }
      msg += `%0A*Itens:*%0A`;
      let total = 0;
      cart.forEach(item => {
        const price = parseFloat(item.price) * item.quantity;
        total += price;
        msg += `- ${item.quantity}x ${item.name} - R$ ${price.toFixed(2)}%0A`;
      });
      if (customer.type === 'Entrega' && customer.address.freight > 0) {
        total += parseFloat(customer.address.freight);
        msg += `- Frete: R$ ${parseFloat(customer.address.freight).toFixed(2)}%0A`;
      }
      if (cartObservations) msg += `%0A*Obs:* ${cartObservations}%0A`;
      msg += `%0A*Total: R$ ${total.toFixed(2)}*`;
      return msg;
    }

    // === EDITOR ===
    let backupCategories;
    let backupOptions;

    function renderEditor() {
      const container = document.getElementById('editor-categories');
      container.innerHTML = '';
      categories.forEach((cat, catIndex) => {
        const div = document.createElement('div');
        div.style = 'background:var(--gray-dark); padding:1rem; border-radius:var(--radius-card); margin-bottom:1rem;';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <input type="text" value="${cat.name}" style="flex:1; margin-right:0.5rem;" onchange="categories[${catIndex}].name=this.value; renderEditor();">
            <button class="btn btn-small" style="background:#E53935;" onclick="deleteCategory(${catIndex})">Excluir</button>
          </div>
          <button class="btn btn-primary" style="margin-top:0.5rem; width:100%;" onclick="addProduct(${catIndex})">+ Adicionar Item</button>
          <div style="margin-top:1rem;"></div>
        `;
        const prodContainer = div.querySelector('div:last-child');
        cat.products.forEach((prod, prodIndex) => {
          const pdiv = document.createElement('div');
          pdiv.style = 'background:var(--gray-medium); padding:0.8rem; border-radius:8px; margin-top:0.5rem;';
          pdiv.innerHTML = `
            <input type="text" value="${prod.name}" placeholder="Nome" onchange="categories[${catIndex}].products[${prodIndex}].name=this.value">
            <input type="text" value="${prod.description || ''}" placeholder="Descrição" onchange="categories[${catIndex}].products[${prodIndex}].description=this.value">
            <div style="display:flex; gap:0.5rem; margin-top:0.5rem; align-items:flex-start; flex-direction:column;">
              <small style="color:var(--light);">Imagem (GitHub ou local):</small>
              <input 
                type="text" 
                placeholder="https://raw.githubusercontent.com/..." 
                value="${prod.imageUrl || ''}" 
                onchange="categories[${catIndex}].products[${prodIndex}].imageUrl=this.value; categories[${catIndex}].products[${prodIndex}].image=''" 
                style="flex:1; font-size:0.85rem; padding:0.4rem;">
              <div style="display:flex; gap:0.3rem; width:100%;">
                <input 
                  type="text" 
                  value="${prod.image||''}" 
                  placeholder="ou nome-local.jpg" 
                  id="img-${catIndex}-${prodIndex}" 
                  style="flex:1; font-size:0.85rem; padding:0.4rem;">
                <label class="upload-btn" for="upload-${catIndex}-${prodIndex}">Escolher</label>
                <input type="file" id="upload-${catIndex}-${prodIndex}" accept="image/*" style="display:none;" onchange="handleUpload(event,${catIndex},${prodIndex})">
              </div>
            </div>
            <input type="number" step="0.01" value="${prod.price}" placeholder="Preço base" onchange="categories[${catIndex}].products[${prodIndex}].price=this.value">
            <div style="margin-top:0.5rem;">
              <label><input type="checkbox" ${prod.customizable ? 'checked' : ''} onchange="toggleCustomizable(${catIndex},${prodIndex},this.checked)"> Personalização</label>
            </div>
            <div id="groups-${catIndex}-${prodIndex}" style="${prod.customizable ? 'display:block' : 'display:none'}; margin-top:0.5rem;"></div>
            <button class="btn btn-small" style="background:#E53935; margin-top:0.5rem; width:100%;" onclick="categories[${catIndex}].products.splice(${prodIndex},1);renderEditor()">Remover Item</button>
          `;

          const groupsDiv = pdiv.querySelector(`#groups-${catIndex}-${prodIndex}`);
          if (prod.customizable) {
            renderProductGroups(catIndex, prodIndex, groupsDiv);
          }

          prodContainer.appendChild(pdiv);
        });
        container.appendChild(div);
      });
    }

    function toggleCustomizable(catIdx, prodIdx, enabled) {
      categories[catIdx].products[prodIdx].customizable = enabled;
      if (!enabled) {
        delete categories[catIdx].products[prodIdx].allowedGroups;
        delete categories[catIdx].products[prodIdx].limits;
      } else {
        categories[catIdx].products[prodIdx].allowedGroups = [];
        categories[catIdx].products[prodIdx].limits = {};
      }
      renderEditor();
    }

    function renderProductGroups(catIdx, prodIdx, container) {
      container.innerHTML = '';
      ingredientGroups.forEach(group => {
        const checked = categories[catIdx].products[prodIdx].allowedGroups?.includes(group.key);
        const limit = categories[catIdx].products[prodIdx].limits?.[group.key] || 1;

        const div = document.createElement('div');
        div.style = 'display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;';
        div.innerHTML = `
          <input type="checkbox" id="grp-${catIdx}-${prodIdx}-${group.key}" ${checked ? 'checked' : ''} onchange="updateGroup(${catIdx},${prodIdx},'${group.key}',this.checked)">
          <label for="grp-${catIdx}-${prodIdx}-${group.key}">${group.name}</label>
          <input type="number" min="1" value="${limit}" style="width:60px;" onchange="updateLimit(${catIdx},${prodIdx},'${group.key}',this.value)">
        `;
        container.appendChild(div);
      });
    }

    function updateGroup(catIdx, prodIdx, groupKey, enabled) {
      const product = categories[catIdx].products[prodIdx];
      if (!product.allowedGroups) product.allowedGroups = [];
      if (!product.limits) product.limits = {};

      if (enabled) {
        if (!product.allowedGroups.includes(groupKey)) {
          product.allowedGroups.push(groupKey);
          product.limits[groupKey] = 1;
        }
      } else {
        product.allowedGroups = product.allowedGroups.filter(k => k !== groupKey);
        delete product.limits[groupKey];
      }
    }

    function updateLimit(catIdx, prodIdx, groupKey, limit) {
      const product = categories[catIdx].products[prodIdx];
      product.limits[groupKey] = parseInt(limit) || 1;
    }

    function addProduct(catIdx) {
      categories[catIdx].products.push({
        id: Date.now(),
        name: 'Novo Item',
        description: '',
        image: '',
        imageUrl: '',
        price: '0.00',
        customizable: false
      });
      renderEditor();
    }

    function handleUpload(e, catIdx, prodIdx) {
      const file = e.target.files[0];
      if (!file) return;
      const filename = file.name;
      categories[catIdx].products[prodIdx].image = filename;
      categories[catIdx].products[prodIdx].imageUrl = ''; // Limpa o link do GitHub
      document.getElementById(`img-${catIdx}-${prodIdx}`).value = filename;
      alert(`Imagem local "${filename}" salva! Coloque em assets/images/`);
    }

    // === EVENTOS ===
    document.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
      renderCategories();
      renderProducts();

      if (customer && customer.name) {
        showScreen('menu-screen');
        updateCartBadge();
      } else {
        showScreen('customer-screen');
      }

      // Formulário cliente
      document.getElementById('customer-form').addEventListener('submit', e => {
        e.preventDefault();
        if (validateCustomerForm()) {
          showScreen('menu-screen');
          renderCategories();
          renderProducts();
          updateCartBadge();
        }
      });

      // Tipo de pedido
      document.getElementById('order-type').addEventListener('change', e => {
        document.getElementById('delivery-fields').style.display = e.target.value === 'Entrega' ? 'block' : 'none';
      });

      // KM Outro
      document.getElementById('address-km').addEventListener('change', e => {
        document.getElementById('uber-freight-group').style.display = e.target.value === 'Outro' ? 'block' : 'none';
      });

      // Pesquisa
      document.getElementById('search-input').addEventListener('input', renderProducts);

      // Botões
      document.getElementById('menu-exit').addEventListener('click', () => {
        populateCustomerForm();
        showScreen('customer-screen');
      });

      document.getElementById('cart-badge').addEventListener('click', () => {
        renderCart();
        showScreen('cart-screen');
      });

      document.getElementById('back-to-menu').addEventListener('click', () => showScreen('menu-screen'));

      document.getElementById('modal-cancel').addEventListener('click', closeModal);
      document.getElementById('modal-save').addEventListener('click', saveModal);

      document.getElementById('cart-observations').addEventListener('input', e => {
        cartObservations = e.target.value;
        saveToStorage();
      });

      document.getElementById('checkout-whatsapp').addEventListener('click', () => {
        if (!validateCustomerForm()) return alert('Preencha os dados do cliente.');
        if (cart.length === 0) return alert('Carrinho vazio.');
        const url = `https://wa.me/5521997599132?text=${buildWhatsAppMessage()}`;
        window.open(url, '_blank');
      });

      // Editor
      document.getElementById('customer-editor-link').addEventListener('click', e => {
        e.preventDefault();
        const pwd = prompt('Digite a senha do editor:');
        if (pwd === getEditorPassword()) {
          backupCategories = JSON.parse(JSON.stringify(categories));
          renderEditor();
          showScreen('editor-screen');
        } else if (pwd !== null) {
          alert('Senha incorreta.');
        }
      });

      document.getElementById('editor-add-category').addEventListener('click', addCategory);

      document.getElementById('editor-cancel').addEventListener('click', () => {
        if (backupCategories) categories = backupCategories;
        showScreen('menu-screen');
        renderCategories();
        renderProducts();
      });

      document.getElementById('editor-save').addEventListener('click', () => {
        if (categories.length === 0) return alert('Adicione pelo menos uma categoria.');
        saveCatalog();
        showScreen('menu-screen');
        renderCategories();
        renderProducts();
      });

      document.getElementById('editor-export').addEventListener('click', exportHTML);
    });

    // Preencher formulário ao editar
    function populateCustomerForm() {
      document.getElementById('customer-name').value = customer.name || '';
      document.getElementById('customer-phone').value = customer.phone || '';
      document.getElementById('order-type').value = customer.type || 'Retirada';
      const addr = customer.address || {};
      document.getElementById('address-logradouro').value = addr.logradouro || '';
      document.getElementById('address-number').value = addr.number || '';
      document.getElementById('address-complement').value = addr.complement || '';
      document.getElementById('address-bairro').value = addr.bairro || '';
      document.getElementById('address-marco').value = addr.marco || '';
      document.getElementById('address-km').value = addr.km || '39';
      document.getElementById('uber-freight').value = addr.freight || '';
      document.getElementById('order-type').dispatchEvent(new Event('change'));
      document.getElementById('address-km').dispatchEvent(new Event('change'));
    }
  </script>

</body>
</html>