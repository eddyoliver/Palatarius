<!DOCTYPE html>
<html lang="pt-BR"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="1.png">
  <title>CardÃ¡pio Palatarius ðŸ”</title>
  <script src="assets/js/settings.js" defer></script>
  <!--
    Este arquivo implementa um cardapio digital completo para o restaurante
    Palatarius. Ele foi projetado para funcionar totalmente offline, sem
    dependÃªncias externas. Todo o estilo (CSS) e scripts (JS) estÃ£o
    incorporados neste documento. A interface segue um tema escuro com
    detalhes em vermelho, amarelo e branco conforme definido pelo cliente.

    As imagens dos itens sÃ£o incorporadas via Data URI (Base64) quando
    disponÃ­veis. Para itens sem imagem fornecida, um placeholder Ã© exibido
    com fundo escuro, um emoji representativo e o texto "Foto em breve".

    Este cardapio foi pensado para uso mobileâ€‘first, utilizando uma
    tipografia grande e botÃµes "touchâ€‘friendly" (mÃ­nimo de 44px de
    altura/largura). Os dados do cliente e o carrinho sÃ£o persistidos
    localmente via localStorage para permitir que o usuÃ¡rio retorne ao
    cardapio sem perder o progresso.
  -->
  <style>
    /* Paleta de cores do tema */
    :root {
      --bg-base: #0B0B0F;
      --primary-red: #E53935;
      --primary-yellow: #FFD60A;
      --primary-white: #FFFFFF;
      --gray-dark: #151515;
      --gray-medium: #232323;
      --gray-light: #BDBDBD;
      --radius-card: 16px;
      --radius-input: 8px;
      --shadow: 0 4px 8px rgba(0,0,0,0.3);
      --font-size-base: 1rem;
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: var(--primary-white);
      background: var(--bg-base);
      overflow-x: hidden;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
    }
    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.2rem; }
    p { margin: 0.2rem 0; }

    /* CabeÃ§alho */
    header {
      padding: 1rem;
      text-align: center;
      background-color: var(--gray-dark);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    header h1 {
      color: var(--primary-yellow);
      font-size: 1.8rem;
    }

    /* ConteÃºdo principal dividido em telas */
    section {
      display: none;
      padding: 1rem;
    }
    section.active {
      display: block;
    }

    /* FormulÃ¡rio de dados do cliente */
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.3rem;
      color: var(--primary-white);
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.6rem;
      border-radius: var(--radius-input);
      border: none;
      /* Para os campos de ediÃ§Ã£o ficarem visÃ­veis sobre o fundo escuro,
         use um tom mÃ©dio de cinza que contraste com o fundo mais escuro */
      background-color: var(--gray-medium);
      color: var(--primary-white);
      font-size: 1rem;
      /* contorno suave para melhor distinÃ§Ã£o */
      box-shadow: inset 0 0 0 1px var(--gray-light);
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--primary-red);
    }
    .row {
      display: flex;
      gap: 0.5rem;
    }
    .row .form-group {
      flex: 1;
    }

    /* BotÃµes */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: var(--radius-input);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-primary {
      background-color: var(--primary-red);
      color: var(--primary-white);
    }
    .btn-primary:hover {
      background-color: #c62828;
    }
    .btn-secondary {
      background-color: var(--primary-yellow);
      color: var(--bg-base);
    }
    .btn-secondary:hover {
      background-color: #e6c50a;
    }
    .btn-small {
      font-size: 0.9rem;
      padding: 0.4rem 0.6rem;
      min-height: 36px;
    }

    /* NavegaÃ§Ã£o de categorias */
    .category-nav {
      display: flex;
      overflow-x: auto;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }
    .category-nav button {
      flex: 1 0 auto;
      white-space: nowrap;
      padding: 0.6rem 1rem;
      border-radius: var(--radius-input);
      border: none;
      background-color: var(--gray-dark);
      color: var(--primary-white);
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
    }
    .category-nav button.active {
      background-color: var(--primary-red);
      color: var(--primary-white);
    }

    /* Cards de produtos */
    .product-card {
      background-color: var(--gray-dark);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .product-image {
      position: relative;
      width: 100%;
      /* mantenha a proporÃ§Ã£o 4/3 */
      aspect-ratio: 4 / 3;
      background-color: var(--gray-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-light);
      font-size: 2rem;
    }
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-top-left-radius: var(--radius-card);
      border-top-right-radius: var(--radius-card);
    }
    .product-content {
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .product-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-yellow);
    }
    .product-desc {
      font-size: 0.9rem;
      color: var(--gray-light);
    }
    .product-price {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-yellow);
    }
    .product-actions {
      margin-top: auto;
      display: flex;
      justify-content: flex-end;
    }
    .product-actions button {
      margin-left: auto;
    }

    /* Badge do carrinho flutuante */
    .cart-badge {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background-color: var(--primary-red);
      color: var(--primary-white);
      padding: 0.6rem 1rem;
      border-radius: 50px;
      box-shadow: var(--shadow);
      font-weight: 600;
      cursor: pointer;
      z-index: 1000;
    }
    .cart-badge span {
      margin-left: 0.4rem;
      font-weight: 700;
    }

    /* Tela de carrinho */
    .cart-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      margin-bottom: 1rem;
      background-color: var(--gray-dark);
      border-radius: var(--radius-card);
      padding: 0.6rem;
      box-shadow: var(--shadow);
    }
    .cart-item img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart-item-details {
      flex: 1;
    }
    .cart-item-title {
      font-weight: 600;
      color: var(--primary-yellow);
    }
    .cart-item-options {
      font-size: 0.85rem;
      color: var(--gray-light);
      margin-top: 0.2rem;
    }
    .cart-item-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .quantity-control {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .quantity-control button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: none;
      background-color: var(--primary-yellow);
      color: var(--bg-base);
      font-weight: 700;
      cursor: pointer;
    }
    .cart-totals {
      margin-top: 1rem;
      background-color: var(--gray-dark);
      padding: 1rem;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
    }
    .cart-totals div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.4rem;
      font-size: 1rem;
    }
    .cart-totals div.total {
      font-weight: 700;
      color: var(--primary-yellow);
    }

    /* Modal de montagem */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background-color: var(--gray-medium);
      color: var(--primary-white);
      border-radius: var(--radius-card);
      padding: 1rem;
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    .modal h2 {
      margin-bottom: 0.8rem;
      color: var(--primary-yellow);
    }
    .modal-section {
      margin-bottom: 1rem;
    }
    .modal-section label {
      font-size: 0.95rem;
      margin-bottom: 0.2rem;
    }
    .modal-section .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .option-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.4rem 0.6rem;
      border-radius: var(--radius-input);
      background-color: var(--gray-dark);
      cursor: pointer;
      font-size: 0.9rem;
    }
    .option-item input {
      margin-right: 0.3rem;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .modal-actions button {
      flex: 1;
    }

    /* Mensagens de erro */
    .error {
      color: var(--primary-red);
      font-size: 0.85rem;
      margin-top: 0.3rem;
    }

    /* Responsividade para telas maiores */
    @media (min-width: 768px) {
      .product-card {
        flex-direction: row;
      }
      .product-image {
        width: 40%;
        height: auto;
      }
      .product-content {
        width: 60%;
      }
    }
</style>
</head>
<body data-page="cardapio">
  <div class="pal-site-header">
    <div class="pal-site-container">
      <a class="pal-site-logo js-brand-name" href="index.html">Palatarius</a>
      <nav class="pal-site-nav">
        <a href="index.html">Inicio</a>
        <a href="cardapio.html" class="active">Cardapio</a>
        <a href="curiosidades.html">Curiosidades</a>
        <a href="contact.html">Contato</a>
        <a class="pal-site-whatsapp js-whatsapp-link" target="_blank" rel="noopener">Pedido rapido</a>
        <button type="button" class="pal-site-editor" id="pal-open-editor">Editar cardapio</button>
      </nav>
    </div>
  </div>
  <header>
    <h1><span class="js-brand-name">Palatarius</span></h1>
    <!-- O botÃ£o do editor nÃ£o Ã© exibido publicamente. Uma
         pequena Ã¡rea de administraÃ§Ã£o serÃ¡ acessÃ­vel a partir da tela
         de login mediante senha. O botÃ£o Ã© mantido no DOM, mas
         escondido com CSS e ativado apenas via link interno. -->
    <button id="open-editor" class="btn btn-secondary btn-small" style="display:none; position:absolute; top:0.8rem; right:1rem;">
      Editor
    </button>
  </header>

  <!-- Tela de Login: a autenticaÃ§Ã£o por usuÃ¡rio/senha foi removida. Esta
       seÃ§Ã£o permanece apenas para referÃªncia e nÃ£o Ã© exibida. -->
  <section id="login-screen" style="display:none;">
    <h2>Entrar</h2>
    <form id="login-form">
      <div class="form-group">
        <label for="login-username">UsuÃ¡rio</label>
        <input type="text" id="login-username" required="" placeholder="Nome de usuÃ¡rio">
      </div>
      <div class="form-group">
        <label for="login-password">Senha</label>
        <input type="password" id="login-password" required="" placeholder="Senha">
      </div>
      <button type="submit" class="btn btn-primary">Entrar</button>
    </form>
    <p style="margin-top:1rem;">
      <a href="#" id="show-register">Cadastre-se</a>
    </p>
    <p>
      <a href="#" id="login-editor-link">Ãrea do Editor</a>
    </p>
  </section>

  <!-- Tela de Registro removida. Os dados do cliente sÃ£o preenchidos diretamente
       na tela de dados do cliente (customer-screen). Esta seÃ§Ã£o fica oculta. -->
  <section id="register-screen" style="display:none;">
    <h2>Cadastro</h2>
    <form id="register-form">
      <!-- Campos de login -->
      <div class="form-group">
        <label for="reg-username">UsuÃ¡rio *</label>
        <input type="text" id="reg-username" required="" placeholder="Crie seu usuÃ¡rio">
      </div>
      <div class="form-group">
        <label for="reg-password">Senha *</label>
        <input type="password" id="reg-password" required="" placeholder="Crie uma senha">
      </div>
      <!-- Campos de dados do cliente reutilizados do formulÃ¡rio original -->
      <div class="form-group">
        <label for="reg-name">Nome completo *</label>
        <input type="text" id="reg-name" required="" placeholder="Digite seu nome completo">
        <div class="error" id="error-reg-name"></div>
      </div>
      <div class="form-group">
        <label for="reg-phone">Telefone (somente nÃºmeros) *</label>
        <input type="tel" id="reg-phone" required="" placeholder="(21) 99999-9999" pattern="\d{10,11}">
        <div class="error" id="error-reg-phone"></div>
      </div>
      <div class="form-group">
        <label for="reg-order-type">Tipo de pedido *</label>
        <select id="reg-order-type" required="">
          <option value="Entrega">Entrega</option>
          <option value="Retirada">Retirada no balcÃ£o</option>
        </select>
      </div>
      <!-- Campos de entrega -->
      <div id="reg-delivery-fields" style="display:none;">
        <div class="form-group">
          <label for="reg-logradouro">Logradouro *</label>
          <input type="text" id="reg-logradouro" placeholder="Rua/Avenida">
          <div class="error" id="error-reg-logradouro"></div>
        </div>
        <div class="row">
          <div class="form-group">
            <label for="reg-number">NÃºmero *</label>
            <input type="text" id="reg-number" placeholder="NÃºmero">
            <div class="error" id="error-reg-number"></div>
          </div>
          <div class="form-group">
            <label for="reg-complement">Complemento</label>
            <input type="text" id="reg-complement" placeholder="Apto, bloco...">
          </div>
        </div>
        <div class="form-group">
          <label for="reg-bairro">Bairro *</label>
          <input type="text" id="reg-bairro" placeholder="Bairro">
          <div class="error" id="error-reg-bairro"></div>
        </div>
        <div class="form-group">
          <label for="reg-marco">Marco</label>
          <input type="text" id="reg-marco" placeholder="Ponto de referÃªncia">
        </div>
        <div class="form-group">
          <label for="reg-cidade">Cidade</label>
          <input type="text" id="reg-cidade" value="SeropÃ©dica-RJ" readonly="">
        </div>
        <div class="form-group">
          <label for="reg-km">KM *</label>
          <select id="reg-km">
            <option value="39">KM 39</option>
            <option value="40">KM 40</option>
            <option value="41">KM 41</option>
            <option value="42">KM 42</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group" id="reg-uber-freight-group" style="display:none;">
          <label for="reg-uber-freight">Frete via Uber Moto Flash (R$) *</label>
          <input type="number" id="reg-uber-freight" min="0" step="0.01" placeholder="Digite o valor">
          <div class="error" id="error-reg-freight"></div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary" id="register-submit">Concluir Cadastro</button>
      <button type="button" class="btn btn-secondary" id="register-cancel">Cancelar</button>
    </form>
  </section>

  <!-- Tela de dados do cliente. Esta tela Ã© exibida inicialmente para que
       o cliente informe seu nome, telefone e endereÃ§o (quando for entrega).
       ApÃ³s validaÃ§Ã£o, o usuÃ¡rio prossegue para o cardapio. -->
  <section id="customer-screen" class="active">
    <h2>Dados do Cliente</h2>
    <form id="customer-form">
      <div class="form-group">
        <label for="customer-name">Nome completo *</label>
        <input type="text" id="customer-name" name="customer-name" required="" placeholder="Digite seu nome completo">
        <div class="error" id="error-name"></div>
      </div>
      <div class="form-group">
        <label for="customer-phone">Telefone (somente nÃºmeros) *</label>
        <input type="tel" id="customer-phone" name="customer-phone" required="" placeholder="(21) 99999-9999" pattern="\d{10,11}">
        <div class="error" id="error-phone"></div>
      </div>
      <div class="form-group">
        <label for="order-type">Tipo de pedido *</label>
        <select id="order-type" name="order-type" required="">
          <option value="Entrega">Entrega</option>
          <option value="Retirada">Retirada no balcÃ£o</option>
        </select>
      </div>
      <!-- Campos de entrega -->
      <div id="delivery-fields" style="display: block;">
        <div class="form-group">
          <label for="address-logradouro">Logradouro *</label>
          <input type="text" id="address-logradouro" placeholder="Rua/Avenida">
          <div class="error" id="error-logradouro"></div>
        </div>
        <div class="row">
          <div class="form-group">
            <label for="address-number">NÃºmero *</label>
            <input type="text" id="address-number" placeholder="NÃºmero">
            <div class="error" id="error-number"></div>
          </div>
          <div class="form-group">
            <label for="address-complement">Complemento</label>
            <input type="text" id="address-complement" placeholder="Apto, bloco...">
          </div>
        </div>
        <div class="form-group">
          <label for="address-bairro">Bairro *</label>
          <input type="text" id="address-bairro" placeholder="Bairro">
          <div class="error" id="error-bairro"></div>
        </div>
        <div class="form-group">
          <label for="address-marco">Marco</label>
          <input type="text" id="address-marco" placeholder="Ponto de referÃªncia">
        </div>
        <div class="form-group">
          <label for="address-cidade">Cidade</label>
          <input type="text" id="address-cidade" value="SeropÃ©dica-RJ" readonly="">
        </div>
        <div class="form-group">
          <label for="address-km">KM *</label>
          <select id="address-km">
            <option value="39">KM 39</option>
            <option value="40">KM 40</option>
            <option value="41">KM 41</option>
            <option value="42">KM 42</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group" id="uber-freight-group" style="display:none;">
          <label for="uber-freight">Frete via Uber Moto Flash (R$) *</label>
          <input type="number" id="uber-freight" min="0" step="0.01" placeholder="Digite o valor">
          <div class="error" id="error-freight"></div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary" id="continue-menu">Continuar para o Cardapio</button>
    </form>
    <!-- Link para acessar a Ã¡rea do editor diretamente. O editor permanece protegido por senha -->
    <p style="margin-top:1rem;">
      <a href="#" id="customer-editor-link">Ãrea do Editor</a>
    </p>
  </section>

  <!-- Tela 2: Cardapio -->
  <section id="menu-screen" class="">
    <div style="margin-bottom:1rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
      <button class="btn btn-secondary" id="menu-exit">Sair</button>
      <div class="search-group" style="flex:1 1 220px;">
        <input type="text" id="search-input" placeholder="Buscar item...">
      </div>
    </div>
    <nav class="category-nav" id="category-nav"></nav>
    <div id="product-list">
</div>
  </section>

  <!-- Tela 3: Carrinho -->
  <section id="cart-screen" class="">
    <h2>Seu Carrinho</h2>
    <!-- BotÃ£o para voltar ao cardapio e continuar comprando -->
    <button class="btn btn-secondary" id="back-to-menu" style="margin-bottom:1rem;">Voltar ao Cardapio</button>
    <div id="cart-items"></div>
    <div class="cart-totals" id="cart-totals"><div><span>Subtotal</span><span>R$&nbsp;0,00</span></div><div><span>Frete</span><span>R$&nbsp;4,00</span></div><div class="total"><span>Total</span><span>R$&nbsp;4,00</span></div></div>
    <div class="form-group">
      <label for="cart-observations">ObservaÃ§Ãµes gerais</label>
      <textarea id="cart-observations" rows="3" placeholder="Alguma observaÃ§Ã£o? (opcional)"></textarea>
    </div>
    <button class="btn btn-primary" id="checkout-whatsapp">Enviar pelo WhatsApp</button>
    <!-- BotÃ£o para gerar cupom/recibo em formato de impressÃ£o -->
    <button class="btn btn-secondary" id="print-coupon" style="margin-top:0.5rem;">Gerar Cupom</button>
  </section>

  <!-- Tela 4: Editor do cardapio -->
  <section id="editor-screen" class="">
    <h2>Editor do Cardapio</h2>
    <p>Use este editor para alterar grupos, itens, descriÃ§Ãµes, preÃ§os e imagens. As alteraÃ§Ãµes sÃ£o salvas no armazenamento local do navegador.</p>
    <div id="editor-content">
</div>
    <div style="margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
      <button class="btn btn-secondary" id="editor-add-category">Adicionar Grupo</button>
      <button class="btn btn-secondary" id="editor-cancel">Cancelar</button>
      <button class="btn btn-primary" id="editor-save">Salvar AlteraÃ§Ãµes</button>
      <!-- NOVO: exportaÃ§Ã£o -->
      <button class="btn btn-secondary" id="editor-export">Exportar HTML (com imagens)</button>
    </div>
  </section>

  <!-- Badge de carrinho flutuante -->
  <div class="cart-badge" id="cart-badge" style="display: none;">
    ðŸ›’ <span id="cart-count"></span>
  </div>

  <!-- Modal de montagem -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
      <h2 id="modal-title">Montar Hot Dog Noob Raiz</h2>
      <div id="modal-content"><div class="modal-section"><label data-group-key="protein" data-max="1" data-base-text="ProteÃ­na">ProteÃ­na</label><div class="options"><label class="option-item"><input type="radio" name="protein" value="Carne">Carne</label><label class="option-item"><input type="radio" name="protein" value="Frango">Frango</label><label class="option-item"><input type="radio" name="protein" value="Costela">Costela</label><label class="option-item"><input type="radio" name="protein" value="Pernil">Pernil</label><label class="option-item"><input type="radio" name="protein" value="">Nenhum</label></div></div><div class="modal-section"><label data-group-key="ingredients" data-max="18" data-base-text="Acompanhamentos (atÃ© 18)">Acompanhamentos (atÃ© 18) (0/18)</label><div class="options"><label class="option-item"><input type="checkbox" name="ingredients" value="Bacon">Bacon</label><label class="option-item"><input type="checkbox" name="ingredients" value="Calabresa">Calabresa</label><label class="option-item"><input type="checkbox" name="ingredients" value="Ovo de codorna">Ovo de codorna</label><label class="option-item"><input type="checkbox" name="ingredients" value="Presunto">Presunto</label><label class="option-item"><input type="checkbox" name="ingredients" value="Milho verde">Milho verde</label><label class="option-item"><input type="checkbox" name="ingredients" value="Ervilha">Ervilha</label><label class="option-item"><input type="checkbox" name="ingredients" value="Passas">Passas</label><label class="option-item"><input type="checkbox" name="ingredients" value="Azeitona">Azeitona</label><label class="option-item"><input type="checkbox" name="ingredients" value="Tomate cru">Tomate cru</label><label class="option-item"><input type="checkbox" name="ingredients" value="Cebola">Cebola</label><label class="option-item"><input type="checkbox" name="ingredients" value="Champignon">Champignon</label><label class="option-item"><input type="checkbox" name="ingredients" value="Palmito">Palmito</label><label class="option-item"><input type="checkbox" name="ingredients" value="Cebola crispy">Cebola crispy</label><label class="option-item"><input type="checkbox" name="ingredients" value="Alho torrado">Alho torrado</label><label class="option-item"><input type="checkbox" name="ingredients" value="Queijo Minas">Queijo Minas</label><label class="option-item"><input type="checkbox" name="ingredients" value="Queijo muÃ§arela">Queijo muÃ§arela</label><label class="option-item"><input type="checkbox" name="ingredients" value="Queijo prato">Queijo prato</label><label class="option-item"><input type="checkbox" name="ingredients" value="Catupiry">Catupiry</label><label class="option-item"><input type="checkbox" name="ingredients" value="Cheddar">Cheddar</label><label class="option-item"><input type="checkbox" name="ingredients" value="OrÃ©gano">OrÃ©gano</label><label class="option-item"><input type="checkbox" name="ingredients" value="Queijo parmesÃ£o">Queijo parmesÃ£o</label></div></div><div class="modal-section"><label>ObservaÃ§Ã£o do item</label><textarea id="custom-observation" rows="2"></textarea></div></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modal-cancel">Cancelar</button>
        <button class="btn btn-primary" id="modal-save">Adicionar</button>
      </div>
    </div>
  </div>

<script>
const PALATARIUS_CONFIG = window.PALATARIUS_CONFIG || {};
const UPLOAD_ENDPOINT = PALATARIUS_CONFIG.uploadEndpoint || null;
const ASSET_BASE_URL = PALATARIUS_CONFIG.assetBaseUrl || 'assets/images/';
const IMAGE_MANIFEST_URL = PALATARIUS_CONFIG.imageManifest || 'assets/images/manifest.json';
const DEFAULT_ASSETS_URL = PALATARIUS_CONFIG.defaultAssets || 'assets/default-assets.json';

let availableImages = [];
let defaultAssets = {};
let loadFromStorageCompleted = false;
// __ASSETS_START__
let assets = {};
// __ASSETS_END__
</script>

<script>

    function refreshEditorIfOpen() {
      const editorSection = document.getElementById('editor-screen');
      if (editorSection && editorSection.classList.contains('active') && typeof renderEditor === 'function') {
        renderEditor();
      }
    }

    function applyDefaultAssets(options) {
      if (!defaultAssets || typeof defaultAssets !== 'object') {
        return;
      }
      let updated = false;
      Object.entries(defaultAssets).forEach(([id, path]) => {
        if (!assets[id]) {
          assets[id] = path;
          updated = true;
        }
      });
      const shouldPersist = !options || options.skipPersist !== true;
      if (updated && shouldPersist) {
        try {
          localStorage.setItem('palatarius_assets', JSON.stringify(assets));
        } catch (error) {
          console.warn('NÃ£o foi possÃ­vel salvar assets padrÃ£o.', error);
        }
      }
    }

    fetch(IMAGE_MANIFEST_URL, { cache: 'no-store' })
      .then(response => response.ok ? response.json() : [])
      .then(list => {
        if (Array.isArray(list)) {
          availableImages = list;
          refreshEditorIfOpen();
        }
      })
      .catch(error => {
        console.warn('NÃ£o foi possÃ­vel carregar a lista de imagens.', error);
      });

    fetch(DEFAULT_ASSETS_URL, { cache: 'no-store' })
      .then(response => response.ok ? response.json() : null)
      .then(map => {
        if (map && typeof map === 'object') {
          defaultAssets = map;
          applyDefaultAssets({ skipPersist: !loadFromStorageCompleted });
          if (typeof renderProducts === 'function') {
            renderProducts();
          }
          refreshEditorIfOpen();
        }
      })
      .catch(error => {
        console.warn('NÃ£o foi possÃ­vel carregar o mapa de imagens padrÃ£o.', error);
      });

    const MAX_UPLOAD_SIZE = 3 * 1024 * 1024; // 3 MB

    /**
     * Resolve um valor de asset (nome do arquivo, caminho relativo ou URL)
     * para uma URL carregÃ¡vel na interface.
     */
    function getAssetUrl(value) {
      if (!value) return '';
      const trimmed = String(value).trim();
      if (
        trimmed.startsWith('data:') ||
        trimmed.startsWith('blob:') ||
        /^https?:\/\//i.test(trimmed)
      ) {
        return trimmed;
      }
      let normalized = trimmed.replace(/^\.\/+/, '');
      if (normalized.startsWith('/')) {
        return normalized;
      }
      if (normalized.includes('/')) {
        return normalized;
      }
      if (normalized.startsWith(ASSET_BASE_URL)) {
        return normalized;
      }
      return ASSET_BASE_URL + normalized;
    }

    /**
     * Valida o arquivo recebido antes do envio ao servidor.
     * LanÃ§a um erro em caso de formato ou tamanho invÃ¡lido.
     */
    function validateImageFile(file) {
      if (!file) {
        throw new Error('Nenhuma imagem selecionada.');
      }
      if (file.type !== 'image/png') {
        throw new Error('Envie imagens no formato PNG.');
      }
      if (file.size > MAX_UPLOAD_SIZE) {
        const maxMb = (MAX_UPLOAD_SIZE / (1024 * 1024)).toFixed(1);
        throw new Error(`A imagem deve ter no mÃ¡ximo ${maxMb.replace('.', ',')} MB.`);
      }
    }

    /**
     * Le a imagem localmente e devolve um Data URL para uso imediato.
     */
    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const result = ev.target && ev.target.result ? ev.target.result : '';
          resolve(result);
        };
        reader.onerror = () => reject(new Error('Nao foi possivel ler a imagem selecionada.'));
        reader.readAsDataURL(file);
      });
    }

    /**
     * Envia uma imagem para o servidor e devolve o caminho salvo.
     * No modo estatico (GitHub Pages), faz fallback para Data URL.
     */
    async function uploadCatalogImage(itemId, file, previousPath) {
      validateImageFile(file);

      if (!UPLOAD_ENDPOINT) {
        const basePathMessage = ASSET_BASE_URL.endsWith('/') ? ASSET_BASE_URL : `${ASSET_BASE_URL}/`;
        throw new Error(`Envie a imagem para ${basePathMessage} e selecione pelo campo de caminho.`);
      }

      const formData = new FormData();
      formData.append('image', file);
      formData.append('item_id', itemId);
      if (previousPath) {
        formData.append('previous_path', previousPath);
      }

      try {
        const response = await fetch(UPLOAD_ENDPOINT, {
          method: 'POST',
          body: formData,
          credentials: 'include',
        });

        let payload;
        try {
          payload = await response.json();
        } catch (error) {
          console.error('Resposta invalida do upload:', error);
          throw new Error('Erro ao interpretar a resposta do servidor.');
        }

        if (!response.ok || !payload || payload.success !== true || !payload.path) {
          const message = payload && payload.error ? payload.error : 'Falha ao enviar imagem.';
          throw new Error(message);
        }

        return payload.path;
      } catch (error) {
        console.warn('Falha no upload remoto. Usando Data URL local.', error);
        return readFileAsDataUrl(file);
      }
    }

// =====================
    // DefiniÃ§Ã£o de listas globais de ingredientes, sabores e acompanhamentos
    // Cada entrada possui um nome e uma flag de disponibilidade. Os dados
    // podem ser persistidos no localStorage para permitir o bloqueio de
    // ingredientes fora de estoque. O editor permite ajustar estes
    // valores. Se `available` for false o ingrediente nÃ£o serÃ¡ exibido
    // nas opÃ§Ãµes de montagem.

    // ProteÃ­nas para itens montados (pastÃ©is, tapiocas, etc.)
    let proteins = [
      { name: 'Carne', available: true },
      { name: 'Frango', available: true },
      { name: 'Costela', available: true },
      { name: 'Pernil', available: true },
    ];

    // Acompanhamentos (ingredientes) comuns para montagens
    let ingredients = [
      { name: 'Bacon', available: true },
      { name: 'Calabresa', available: true },
      { name: 'Ovo de codorna', available: true },
      { name: 'Presunto', available: true },
      { name: 'Milho verde', available: true },
      { name: 'Ervilha', available: true },
      { name: 'Passas', available: true },
      { name: 'Azeitona', available: true },
      { name: 'Tomate cru', available: true },
      { name: 'Cebola', available: true },
      { name: 'Champignon', available: true },
      { name: 'Palmito', available: true },
      { name: 'Cebola crispy', available: true },
      { name: 'Alho torrado', available: true },
      { name: 'Queijo Minas', available: true },
      { name: 'Queijo muÃ§arela', available: true },
      { name: 'Queijo prato', available: true },
      { name: 'Catupiry', available: true },
      { name: 'Cheddar', available: true },
      { name: 'OrÃ©gano', available: true },
      { name: 'Queijo parmesÃ£o', available: true },
    ];

    // Molhos especiais para hambÃºrgueres
    let sauces = [
      { name: 'Molho Verde', available: true },
      { name: 'Molho TartÃ¡ro', available: true },
      { name: 'Molho Tasty', available: true },
      { name: 'Molho Billy Jack', available: true },
      { name: 'Molho Alho com Ervas finas', available: true },
      { name: 'Molho de Alho', available: true },
      { name: 'Ketchup de Goiabada', available: true },
      { name: 'Ketchup de Goiabada Picante', available: true },
    ];

    // Extras opcionais para hambÃºrgueres
    let extras = [
      { name: 'Alho torrado', available: true },
      { name: 'Cebola crispy', available: true },
    ];

    // Sabores de aÃ§aÃ­
    let acaiFlavors = [
      { name: 'AÃ§ai Poupa', available: true },
      { name: 'AÃ§ai c/ Morango', available: true },
      { name: 'AÃ§ai c/ Banana', available: true },
      { name: 'AÃ§ai c/ Maracuja', available: true },
    ];

    // Sabores de sorvete
    let iceCreamFlavors = [
      { name: 'Torta LimÃ£o', available: true },
      { name: 'MaracujÃ¡', available: true },
      { name: 'Napolitano', available: true },
      { name: 'Prestigio', available: true },
      { name: 'Chocolate', available: true },
    ];

    // Toppings para aÃ§aÃ­ e sorvete
    let toppings = [
      { name: 'Canudo de Biscoito', available: true },
      { name: 'Jujuba', available: true },
      { name: 'Delicado', available: true },
      { name: 'Confetes Chocolate', available: true },
      { name: 'Sucrilhos', available: true },
      { name: 'Flocos de Arroz', available: true },
      { name: 'Aveia', available: true },
      { name: 'Amendoim', available: true },
      { name: 'PaÃ§oca', available: true },
      { name: 'Chocoball', available: true },
      { name: 'Granulado Chocolate', available: true },
      { name: 'Leite em PÃ³', available: true },
      { name: 'Granola', available: true },
    ];

    // Caldas (syrups) para aÃ§aÃ­ e sorvete
    // Estas opÃ§Ãµes representam sabores de calda extras que o cliente pode
    // acrescentar no aÃ§aÃ­/sorvete. SÃ£o editÃ¡veis no modo editor e podem
    // ser selecionadas em quantidade ilimitada pelo cliente.
    let syrups = [
      { name: 'Morango', available: true },
      { name: 'Chocolate', available: true },
      { name: 'Chocolate com Menta', available: true },
      { name: 'Brigadeiro', available: true },
      { name: 'Leite Condensado', available: true },
      { name: 'Floresta Negra', available: true },
    ];

    // DefiniÃ§Ã£o dos produtos e categorias
    // Lista de grupos de produtos. TambÃ©m usamos 'let' para permitir
    // adiÃ§Ã£o/remoÃ§Ã£o de itens e categorias no modo editor.
    // Antes de sobrescrever via localStorage, este array servirÃ¡ como
    // fonte de dados padrÃ£o. ApÃ³s esta definiÃ§Ã£o, criamos um mapa com
    // as opÃ§Ãµes de personalizaÃ§Ã£o padrÃ£o (customOptions/proteinLimit) para
    // cada item. Esse mapa Ã© usado para restaurar propriedades ausentes
    // em categorias carregadas do localStorage.
    let categories = JSON.parse(`[
  {
    "key": "batatas",
    "name": "Batatas do DragÃ£o",
    "emoji": "ðŸŸ",
    "items": [
      {
        "id": "1-up",
        "name": "Batata Comum (P) \"1-UP\"",
        "description": "Batata comum pequena",
        "price": 4.0
      },
      {
        "id": "smash-bros",
        "name": "Batata (P) \"Smash Bros\"",
        "description": "Batata pequena especial",
        "price": 6.0
      },
      {
        "id": "scorpion",
        "name": "Batata 25cm \"Scorpion\"",
        "description": "Batata 25 cm",
        "price": 25.0
      },
      {
        "id": "final-boss",
        "name": "Batata 35cm \"Final Boss\"",
        "description": "Batata 35 cm",
        "price": 35.0
      },
      {
        "id": "fatality-batata",
        "name": "Batata 25cm \"Fatality\"",
        "description": "Batata 25 cm (2 molhos)",
        "price": 45.0
      },
      {
        "id": "brutality",
        "name": "Batata 35cm \"Brutality\"",
        "description": "Batata 35 cm (3 molhos)",
        "price": 55.0
      }
    ]
  },
  {
    "key": "hamburgers",
    "name": "HambÃºrgueres",
    "emoji": "ðŸ¥Ÿ",
    "items": [
      {
        "id": "shuriken",
        "name": "Shuriken â€” 15 cm",
        "description": "Montagem: 1 proteÃ­na + atÃ© 18 ingredientes",
        "price": 0.0
      },
      {
        "id": "grand-line",
        "name": "Grand Line â€” 25 cm",
        "description": "Montagem: 2 proteÃ­nas + atÃ© 18 ingredientes",
        "price": 0.0
      }
    ]
  },
  {
    "key": "tapiocas-salgadas",
    "name": "Tapiocas Salgadas",
    "emoji": "ðŸ¥™",
    "items": [
      {
        "id": "kanto",
        "name": "Kanto â€” Pequena",
        "description": "Montagem: 1 proteÃ­na + atÃ© 18 ingredientes",
        "price": 10.0
      },
      {
        "id": "johto",
        "name": "Johto â€” MÃ©dia",
        "description": "Montagem: 2 proteÃ­nas + atÃ© 18 ingredientes",
        "price": 15.0
      }
    ]
  },
  {
    "key": "tapiocas-doces",
    "name": "Tapiocas Doces",
    "emoji": "ðŸ¥™",
    "items": [
      {
        "id": "alola-p",
        "name": "Alola P",
        "description": "",
        "price": 10.0
      },
      {
        "id": "alola-g",
        "name": "Alola G",
        "description": "",
        "price": 15.0
      },
      {
        "id": "cerulean-p",
        "name": "Cerulean P",
        "description": "",
        "price": 10.0
      },
      {
        "id": "cerulean-g",
        "name": "Cerulean G",
        "description": "",
        "price": 15.0
      }
    ]
  },
  {
    "key": "bebidas",
    "name": "Bebidas",
    "emoji": "ðŸ¥¤",
    "items": [
      {
        "id": "guaracamp-copo",
        "name": "Guaracamp Copo",
        "description": "",
        "price": 2.0
      },
      {
        "id": "mini-200",
        "name": "Refrigerante Mini 200ml",
        "description": "",
        "price": 3.0
      },
      {
        "id": "agua-gas",
        "name": "Ãgua com gÃ¡s",
        "description": "",
        "price": 3.5
      },
      {
        "id": "agua-comum",
        "name": "Ãgua",
        "description": "",
        "price": 3.5
      },
      {
        "id": "lata",
        "name": "Refrigerante Lata",
        "description": "",
        "price": 5.5
      },
      {
        "id": "conveniencia",
        "name": "ConveniÃªncia 2L",
        "description": "",
        "price": 7.5
      },
      {
        "id": "sabores-2l",
        "name": "Refrigerantes Sabores 2L",
        "description": "",
        "price": 12.0
      },
      {
        "id": "coca-2l",
        "name": "Coca-Cola 2L",
        "description": "",
        "price": 14.0
      }
    ]
  },
  {
    "key": "acai",
    "name": "AÃ§aÃ­ / Sorvete",
    "emoji": "ðŸ¥¤",
    "items": [
      {
        "id": "caldo-500",
        "name": "Caldo de Cana 500 ml",
        "description": "",
        "price": 6.0
      }
    ]
  }
]`);

    /**
     * VariÃ¡veis de estado: armazenam informaÃ§Ãµes do cliente e do carrinho.
     * SÃ£o carregadas do localStorage na inicializaÃ§Ã£o e salvas a cada
     * alteraÃ§Ã£o.
     */
    let customer = {
      name: '',
      phone: '',
      type: 'Entrega',
      address: {
        logradouro: '',
        number: '',
        complement: '',
        bairro: '',
        marco: '',
        cidade: 'SeropÃ©dica-RJ',
        km: '39',
        freight: 0,
      },
    };
    let cart = [];
    let cartObservations = '';

    // ==============================
    // Mapa de dados padrÃ£o dos itens
    // Este objeto armazena as definiÃ§Ãµes originais de personalizaÃ§Ã£o para
    // cada item (customOptions e proteinLimit) conforme declaradas nas
    // categorias acima. Ele Ã© preenchido imediatamente apÃ³s a definiÃ§Ã£o
    // inicial das categorias. Ao carregar categorias do localStorage,
    // usamos esse mapa para restaurar campos ausentes, garantindo que
    // itens jÃ¡ salvos continuem com as opÃ§Ãµes de montagem corretas.
    const defaultItemData = {};
    // Popula defaultItemData a partir das categorias originais
    categories.forEach(group => {
      if (!group || !group.items) return;
      group.items.forEach(item => {
        if (!item || !item.id) return;
        defaultItemData[item.id] = {};
        if (item.name !== undefined) {
          defaultItemData[item.id].name = item.name;
        }
        if (item.description !== undefined) {
          defaultItemData[item.id].description = item.description;
        }
        if (item.price !== undefined) {
          defaultItemData[item.id].price = item.price;
        }
        if (Array.isArray(item.customOptions)) {
          // Clonar profundamente para evitar mutaÃ§Ãµes
          defaultItemData[item.id].customOptions = JSON.parse(JSON.stringify(item.customOptions));
        }
        if (item.proteinLimit !== undefined) {
          defaultItemData[item.id].proteinLimit = item.proteinLimit;
        }
      });
    });

    // Senha do editor armazenada como sequÃªncia de cÃ³digos de caracteres para nÃ£o
    // exibir a senha em texto claro no cÃ³digo. A senha original Ã©
    // "EdLeoMarc&2025". Para verificar, convertemos cada cÃ³digo para
    // caractere e comparamos com a entrada do usuÃ¡rio.
    const editorPasswordCodes = [69, 100, 76, 101, 111, 77, 97, 114, 99, 38, 50, 48, 50, 53];
    function getEditorPassword() {
      return editorPasswordCodes.map(c => String.fromCharCode(c)).join('');
    }

    /**
     * Utilidade: formata um nÃºmero como moeda brasileira (BRL) com vÃ­rgula
     * decimal. Usa toLocaleString para garantir a formataÃ§Ã£o correta.
     *
     * @param {number} value
     * @returns {string}
     */
    function formatCurrency(value) {
      return value.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
      });
    }

    function populateCustomerForm() {
      const nameEl = document.getElementById('customer-name');
      if (!nameEl) return;

      const phoneEl = document.getElementById('customer-phone');
      const typeEl = document.getElementById('order-type');
      const deliveryFields = document.getElementById('delivery-fields');
      const logradouroEl = document.getElementById('address-logradouro');
      const numberEl = document.getElementById('address-number');
      const complementEl = document.getElementById('address-complement');
      const bairroEl = document.getElementById('address-bairro');
      const marcoEl = document.getElementById('address-marco');
      const cidadeEl = document.getElementById('address-cidade');
      const kmEl = document.getElementById('address-km');
      const uberFreightGroup = document.getElementById('uber-freight-group');
      const uberFreightEl = document.getElementById('uber-freight');

      const address = customer.address || {};

      nameEl.value = customer.name || '';
      if (phoneEl) phoneEl.value = customer.phone || '';

      if (typeEl) {
        const selectedType = customer.type || 'Entrega';
        typeEl.value = selectedType;
        if (deliveryFields) {
          deliveryFields.style.display = selectedType === 'Entrega' ? 'block' : 'none';
        }
      }

      if (logradouroEl) logradouroEl.value = address.logradouro || '';
      if (numberEl) numberEl.value = address.number || '';
      if (complementEl) complementEl.value = address.complement || '';
      if (bairroEl) bairroEl.value = address.bairro || '';
      if (marcoEl) marcoEl.value = address.marco || '';

      if (cidadeEl) {
        const defaultCity = cidadeEl.defaultValue || 'SeropÃ©dica-RJ';
        cidadeEl.value = address.cidade || defaultCity;
      }

      let selectedKm = '39';
      if (kmEl) {
        selectedKm = address.km || '39';
        kmEl.value = selectedKm;
      }

      if (uberFreightGroup) {
        uberFreightGroup.style.display = selectedKm === 'Outro' ? 'block' : 'none';
      }
      if (uberFreightEl) uberFreightEl.value = address.freight || '';
    }

    /**
     * Carrega dados salvos no localStorage (se existirem) e os aplica Ã s
     * variÃ¡veis globais de estado e aos campos do formulÃ¡rio.
     */
    function loadFromStorage() {
      try {
        // Carregar dados de cliente salvos na chave palatarius_customer. NÃ£o hÃ¡
        // sistema de usuÃ¡rios global, portanto ignoramos palatarius_current_user
        // e palatarius_users. Caso existam dados salvos, clonamos para a
        // variÃ¡vel customer; caso contrÃ¡rio, inicializamos com estruturas vazias.
        const storedCustomer = localStorage.getItem('palatarius_customer');
        if (storedCustomer) {
          customer = JSON.parse(storedCustomer);
        }
        // Garantir que existam objetos base
        if (!customer.address) customer.address = {};
        const storedCart = localStorage.getItem('palatarius_cart');
        if (storedCart) {
          cart = JSON.parse(storedCart);
        }
        const storedObs = localStorage.getItem('palatarius_cart_obs');
        if (storedObs) {
          cartObservations = storedObs;
        }
        // Carregar catÃ¡logo e imagens personalizados, se existirem
        const storedCats = localStorage.getItem('palatarius_categories');
        if (storedCats) {
          try {
            categories = JSON.parse(storedCats);
            // ApÃ³s carregar categorias salvas, restaure campos de personalizaÃ§Ã£o
            // ausentes usando o mapa defaultItemData. Isso assegura que
            // customOptions e proteinLimit nÃ£o sejam perdidos entre versÃµes.
            categories.forEach(cat => {
              if (!cat.items) return;
              cat.items.forEach(item => {
                const def = defaultItemData[item.id];
                if (!def) return;
                if (def.name !== undefined && (item.name === undefined || item.name === null || item.name === '')) {
                  item.name = def.name;
                }
                if (def.description !== undefined && (item.description === undefined || item.description === null || item.description === '')) {
                  item.description = def.description;
                }
                if (def.price !== undefined && (item.price === undefined || item.price === null || Number.isNaN(item.price))) {
                  item.price = def.price;
                }
                // Se o item original possuÃ­a customOptions mas o salvo nÃ£o possui,
                // atribui uma cÃ³pia das opÃ§Ãµes padrÃ£o
                if (def.customOptions && !Array.isArray(item.customOptions)) {
                  item.customOptions = JSON.parse(JSON.stringify(def.customOptions));
                }
                // Se o item original possuÃ­a proteinLimit e o salvo nÃ£o
                // definiu explicitamente, restaure o valor padrÃ£o
                if (def.proteinLimit !== undefined && item.proteinLimit === undefined) {
                  item.proteinLimit = def.proteinLimit;
                }
                // Se o item tiver opÃ§Ãµes de personalizaÃ§Ã£o (customOptions) ou um
                // proteinLimit definido, mas a propriedade customizable estiver
                // falsa ou ausente, torne-o customizÃ¡vel por padrÃ£o. Isso evita
                // que itens previamente salvos percam a flag de montagem.
                if ((Array.isArray(item.customOptions) || item.proteinLimit !== undefined) && !item.customizable) {
                  item.customizable = true;
                }
              });
            });
            // Para garantir que os hambÃºrgueres sempre tenham apenas um molho e um extra,
            // atualize o maxSelections de 'sauces' e 'extras' para 1 em itens jÃ¡ salvos.
            categories.forEach(cat => {
              if (!cat.items) return;
              cat.items.forEach(item => {
                if (Array.isArray(item.customOptions)) {
                  item.customOptions.forEach(group => {
                    if (group.key === 'sauces' || group.key === 'extras') {
                      group.maxSelections = 1;
                    }
                  });
                }
              });
            });

            // Ajustar itens de aÃ§aÃ­/sorvete para permitir toppings ilimitados e incluir caldas
            categories.forEach(cat => {
              if (!cat || cat.key !== 'acai' || !Array.isArray(cat.items)) return;
              cat.items.forEach(item => {
                if (!Array.isArray(item.customOptions)) return;
                let hasToppings = false;
                let hasSyrups = false;
                item.customOptions.forEach(group => {
                  if (group.key === 'toppings') {
                    group.maxSelections = toppings.length;
                    hasToppings = true;
                  }
                  if (group.key === 'syrups') {
                    group.maxSelections = syrups.length;
                    hasSyrups = true;
                  }
                });
                // Inserir grupo de caldas se nÃ£o existir
                if (!hasSyrups) {
                  item.customOptions.push({
                    key: 'syrups',
                    name: 'Caldas',
                    type: 'checkbox',
                    maxSelections: syrups.length,
                    required: false,
                    choicesSource: 'syrups',
                  });
                }
              });
            });
          } catch (e) {
            console.error('Erro ao analisar categorias armazenadas:', e);
          }
        }
        const storedAssets = localStorage.getItem('palatarius_assets');
        if (storedAssets) {
          try {
            assets = JSON.parse(storedAssets);
          } catch (e) {
            console.error('Erro ao analisar assets armazenados:', e);
          }
        }
        applyDefaultAssets({ skipPersist: false });
      // Carregar listas globais se existirem
      const storedOpts = localStorage.getItem('palatarius_options');
      if (storedOpts) {
        try {
          const opts = JSON.parse(storedOpts);
          /**
           * Quando as listas sÃ£o gravadas em versÃµes antigas, podem conter
           * entradas como strings simples. Para o editor e as opÃ§Ãµes de
           * personalizaÃ§Ã£o funcionarem corretamente, convertemos qualquer
           * string em um objeto com as propriedades `name` e `available`.
           * Se jÃ¡ for um objeto, apenas garantimos que `available` existe.
           */
          function normalizeList(list) {
            if (!Array.isArray(list)) return [];
            return list.map(item => {
              if (typeof item === 'string') {
                return { name: item, available: true };
              }
              // garantir que tenha name/label
              const obj = { ...item };
              if (obj.name === undefined && obj.label !== undefined) {
                obj.name = obj.label;
              }
              if (obj.available === undefined) {
                obj.available = true;
              }
              return obj;
            });
          }
          if (opts.proteins) proteins = normalizeList(opts.proteins);
          if (opts.ingredients) ingredients = normalizeList(opts.ingredients);
          if (opts.sauces) sauces = normalizeList(opts.sauces);
          if (opts.extras) extras = normalizeList(opts.extras);
          if (opts.acaiFlavors) acaiFlavors = normalizeList(opts.acaiFlavors);
          if (opts.iceCreamFlavors) iceCreamFlavors = normalizeList(opts.iceCreamFlavors);
          if (opts.toppings) toppings = normalizeList(opts.toppings);
          if (opts.syrups) syrups = normalizeList(opts.syrups);
        } catch (e) {
          console.error('Erro ao analisar opÃ§Ãµes globais armazenadas:', e);
        }
      }
      } catch (e) {
        console.error('Erro ao carregar localStorage', e);
      }
      // Aplicar dados ao formulÃ¡rio de cliente
      populateCustomerForm();
      // Atualizar badge do carrinho
      updateCartBadge();
      // Se ainda nÃ£o hÃ¡ categoria ativa ou a atual nÃ£o existe, definir para a primeira
      if (!activeCategory || !categories.find(c => c.key === activeCategory)) {
        activeCategory = categories.length ? categories[0].key : undefined;
      }
      loadFromStorageCompleted = true;
    }

    /**
     * Salva dados do cliente e do carrinho no localStorage.
     */
    function saveToStorage() {
      localStorage.setItem('palatarius_customer', JSON.stringify(customer));
      localStorage.setItem('palatarius_cart', JSON.stringify(cart));
      localStorage.setItem('palatarius_cart_obs', cartObservations);
      // Salvar catÃ¡logo e imagens tambÃ©m
      saveCatalog();

      // NÃ£o persiste dados em usuÃ¡rios: nÃ£o existe sistema de autenticaÃ§Ã£o.
    }

    /**
     * Salva o catÃ¡logo (categorias e itens) e o mapa de imagens no localStorage.
     */
    function saveCatalog() {
      try {
        localStorage.setItem('palatarius_categories', JSON.stringify(categories));
        localStorage.setItem('palatarius_assets', JSON.stringify(assets));
        // Salvar listas globais de opÃ§Ãµes
        const optionsObj = {
          proteins: proteins,
          ingredients: ingredients,
          sauces: sauces,
          extras: extras,
          acaiFlavors: acaiFlavors,
          iceCreamFlavors: iceCreamFlavors,
          toppings: toppings,
          syrups: syrups,
        };
        localStorage.setItem('palatarius_options', JSON.stringify(optionsObj));
      } catch (e) {
        console.error('Erro ao salvar catÃ¡logo:', e);
      }
    }

    /**
     * Calcula o valor do frete com base nos dados do cliente.
     * - Para retirada: 0.
     * - Para entrega em KM 39â€“42: valor fixo de 4,00.
     * - Para "Outro": utiliza o valor informado pelo usuÃ¡rio.
     * - Se nenhum valor informado em "Outro", assume 0.
     *
     * @returns {number}
     */
    function calculateFreight() {
      if (customer.type === 'Retirada') return 0;
      const km = customer.address.km;
      if (['39','40','41','42'].includes(km)) {
        return 4.00;
      }
      // Outro: valor informado
      const freightVal = parseFloat(customer.address.freight);
      return isNaN(freightVal) ? 0 : freightVal;
    }

    /**
     * Navega entre as telas (sections). Recebe o id da seÃ§Ã£o a ser exibida
     * e oculta todas as outras.
     *
     * @param {string} screenId
     */
    function showScreen(screenId) {
      const sections = document.querySelectorAll('section');
      sections.forEach(sec => {
        sec.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
      // Se for a tela de carrinho, renderizar carrinho
      if (screenId === 'cart-screen') {
        renderCart();
      }
    }

    /**
     * Gera o identificador do pedido conforme especificado: {NOME_CLIENTE} -
     * {DD/MM/AAAA} {HH:MM} - {Ãºltimos 2 dÃ­gitos do telefone}.
     *
     * @returns {string}
     */
    function generateOrderId() {
      const now = new Date();
      const date = now.toLocaleDateString('pt-BR');
      const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const phone = customer.phone || '';
      const last2 = phone.slice(-2);
      return `${customer.name} - ${date} ${time} - ${last2}`;
    }

    /**
     * Atualiza o badge flutuante de carrinho com a contagem total de itens.
     */
    function updateCartBadge() {
      const badge = document.getElementById('cart-badge');
      const countSpan = document.getElementById('cart-count');
      const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      if (totalCount > 0) {
        badge.style.display = 'flex';
        countSpan.textContent = totalCount;
      } else {
        badge.style.display = 'none';
        countSpan.textContent = '';
      }
    }

    /**
     * Renderiza a navegaÃ§Ã£o das categorias e o menu de itens da categoria
     * selecionada. Permite busca textual atravÃ©s do campo de busca.
     */
    // Categoria ativa inicia com a primeira categoria disponÃ­vel apÃ³s carregar do armazenamento
    let activeCategory;
    function renderCategories() {
      const nav = document.getElementById('category-nav');
      nav.innerHTML = '';
        categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat.name;
        btn.classList.toggle('active', cat.key === activeCategory);
        btn.addEventListener('click', () => {
          activeCategory = cat.key;
          renderCategories();
          renderProducts();
        });
        nav.appendChild(btn);
      });
    }

    function renderProducts() {
      const list = document.getElementById('product-list');
      list.innerHTML = '';
      // Obter texto de busca
      const searchTerm = (document.getElementById('search-input').value || '').toLowerCase();
      // Encontrar categoria ativa
      const category = categories.find(c => c.key === activeCategory);
      if (!category) return;
      // Filtrar itens pela busca
      const filteredItems = category.items.filter(item => {
        const term = item.name.toLowerCase() + (item.description || '').toLowerCase();
        return term.includes(searchTerm);
      });
      filteredItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        // Imagem ou placeholder
        const imgDiv = document.createElement('div');
        imgDiv.className = 'product-image';
        const assetUrl = getAssetUrl(assets[item.id]);
        if (assetUrl) {
          const img = document.createElement('img');
          img.src = assetUrl;
          img.alt = item.name;
          img.loading = 'lazy';
          img.decoding = 'async';
          imgDiv.appendChild(img);
        } else {
          // Placeholder com emoji relacionado
          let placeholderEmoji = 'Ã°Å¸ÂÃ¢â‚¬Â';
          if (category.emoji) placeholderEmoji = category.emoji;
          const span = document.createElement('span');
          span.textContent = placeholderEmoji;
          imgDiv.appendChild(span);
          const placeholderText = document.createElement('small');
          placeholderText.textContent = 'Foto em breve';
          placeholderText.style.fontSize = '0.7rem';
          placeholderText.style.color = 'var(--gray-light)';
          placeholderText.style.position = 'absolute';
          placeholderText.style.bottom = '0.4rem';
          placeholderText.style.right = '0.4rem';
          imgDiv.style.position = 'relative';
          imgDiv.appendChild(placeholderText);
        }
        card.appendChild(imgDiv);
        const content = document.createElement('div');
        content.className = 'product-content';
        const title = document.createElement('div');
        title.className = 'product-title';
        title.textContent = item.name;
        content.appendChild(title);
        if (item.description) {
          const desc = document.createElement('div');
          desc.className = 'product-desc';
          desc.textContent = item.description;
          content.appendChild(desc);
        }
        const price = document.createElement('div');
        price.className = 'product-price';
        // Se o item tiver priceInput, exibir "PreÃ§o a definir".
        if (item.priceInput) {
          price.textContent = 'PreÃ§o a definir';
        } else {
          price.textContent = formatCurrency(item.price);
        }
        content.appendChild(price);
        const actions = document.createElement('div');
        actions.className = 'product-actions';
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-primary btn-small';
        addBtn.textContent = 'Adicionar';
        // Verificar disponibilidade do item
        const isAvailable = (item.available !== false);
        if (isAvailable) {
        addBtn.addEventListener('click', () => {
            // Verifique se o item exige customizaÃ§Ã£o. AlÃ©m da flag "customizable",
            // considere itens que possuem definiÃ§Ãµes de customOptions ou proteinLimit.
            // Determine se o item precisa de personalizaÃ§Ã£o. AlÃ©m da flag "customizable",
            // considere itens com a propriedade customOptions (mesmo se vazia ou nÃ£o
            // for array) ou com proteinLimit definido. Isso garante que
            // hambÃºrgueres e outros itens configurÃ¡veis abram o modal mesmo
            // quando dados antigos do localStorage nÃ£o possuam array de opÃ§Ãµes.
            const needsCustomization = item.customizable || (item.customOptions !== undefined) || (item.proteinLimit !== undefined);
            if (needsCustomization) {
              openCustomizationModal(item);
            } else {
              addToCart(item);
            }
          });
        } else {
          addBtn.disabled = true;
          addBtn.textContent = 'IndisponÃ­vel';
          addBtn.style.backgroundColor = 'var(--gray-medium)';
          addBtn.style.cursor = 'not-allowed';
        }
        actions.appendChild(addBtn);
        content.appendChild(actions);
        card.appendChild(content);
        list.appendChild(card);
      });
    }

    /**
     * Adiciona um item ao carrinho sem personalizaÃ§Ã£o.
     *
     * @param {Object} item
     */
    function addToCart(item) {
      // Procurar se jÃ¡ existe no carrinho (id e sem opÃ§Ãµes)
      const existingIndex = cart.findIndex(ci => ci.id === item.id && !ci.options);
      if (existingIndex !== -1) {
        cart[existingIndex].quantity += 1;
      } else {
        cart.push({ id: item.id, name: item.name, price: item.price, quantity: 1 });
      }
      saveToStorage();
      updateCartBadge();
    }

    /**
     * Abre o modal de montagem para itens customizÃ¡veis. Permite selecionar
     * proteÃ­nas (atÃ© 1), ingredientes (atÃ© 18), observaÃ§Ãµes e preÃ§o quando
     * apropriado. Caso seja ediÃ§Ã£o de item jÃ¡ no carrinho, recebe tambÃ©m o
     * Ã­ndice desse item.
     *
     * @param {Object} item
     * @param {number|null} editIndex
     */
    let currentModalItem = null;
    let currentEditIndex = null;
    function openCustomizationModal(item, editIndex = null) {
      currentModalItem = item;
      currentEditIndex = editIndex;
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = '';
      // TÃ­tulo
      document.getElementById('modal-title').textContent = `Montar ${item.name}`;
      /**
       * FunÃ§Ã£o interna para gerar um grupo de opÃ§Ãµes no modal.
       * Aceita tipo (radio ou checkbox), um array de choices, chave e
       * limite de seleÃ§Ãµes. Cria elementos de input e trata o limite
       * mÃ¡ximo desabilitando opÃ§Ãµes excedentes.
       */
      function createOptionGroup(group) {
        const section = document.createElement('div');
        section.className = 'modal-section';
        const label = document.createElement('label');
        label.textContent = group.name;
        // Armazenar chave, limite e texto base para atualizaÃ§Ã£o
        label.dataset.groupKey = group.key;
        label.dataset.max = group.maxSelections || 1;
        label.dataset.baseText = group.name;
        section.appendChild(label);
        const optsDiv = document.createElement('div');
        optsDiv.className = 'options';
        let choices = [];
        if (group.choices) {
          choices = group.choices;
        } else if (group.choicesSource) {
          // Determinar fonte de escolhas dinÃ¢micas
          switch (group.choicesSource) {
            case 'proteins':
              choices = proteins;
              break;
            case 'ingredients':
              choices = ingredients;
              break;
            case 'sauces':
              choices = sauces;
              break;
            case 'extras':
              choices = extras;
              break;
            case 'acaiFlavors':
              choices = acaiFlavors;
              break;
            case 'iceCreamFlavors':
              choices = iceCreamFlavors;
              break;
            case 'allFlavors':
              choices = [...acaiFlavors, ...iceCreamFlavors];
              break;
            case 'toppings':
              choices = toppings;
              break;
              case 'syrups':
                choices = syrups;
                break;
            default:
              choices = [];
          }
        }
        // Converter choices em objeto uniforme {value, label, available}
        const choiceList = choices.map(ch => {
          if (typeof ch === 'string') {
            return { value: ch, label: ch, available: true };
          }
          return { value: ch.value || ch.name, label: ch.label || ch.name, available: ch.available !== false };
        });
        choiceList.forEach(choice => {
          if (!choice.available) return;
          const wrap = document.createElement('label');
          wrap.className = 'option-item';
          const input = document.createElement('input');
          input.type = group.type === 'radio' ? 'radio' : 'checkbox';
          input.name = group.key;
          input.value = choice.value;
          wrap.appendChild(input);
          wrap.appendChild(document.createTextNode(choice.label));
          // Atualizar contagem no change para checkbox groups
          if (group.type === 'checkbox') {
            input.addEventListener('change', () => {
              updateGroupCounts(group.key, group.maxSelections || 1);
            });
          }
          optsDiv.appendChild(wrap);
        });
        // Adicionar opÃ§Ã£o "Nenhum" para grupos nÃ£o obrigatÃ³rios de radio
        if (group.type === 'radio' && !group.required) {
          const wrapNone = document.createElement('label');
          wrapNone.className = 'option-item';
          const inputNone = document.createElement('input');
          inputNone.type = 'radio';
          inputNone.name = group.key;
          inputNone.value = '';
          wrapNone.appendChild(inputNone);
          wrapNone.appendChild(document.createTextNode('Nenhum'));
          optsDiv.appendChild(wrapNone);
        }
        section.appendChild(optsDiv);
        modalContent.appendChild(section);
        // Inicializa contagem
        if (group.type === 'checkbox') {
          updateGroupCounts(group.key, group.maxSelections || 1);
        }
      }
      /**
       * Atualiza contagem de seleÃ§Ã£o de um grupo de checkboxes e desabilita
       * opÃ§Ãµes extras quando atingir o limite. Atualiza o rÃ³tulo com
       * contador, se houver.
       *
       * @param {string} key
       * @param {number} max
       */
      function updateGroupCounts(key, max) {
        const inputs = modalContent.querySelectorAll(`input[name="${key}"]`);
        let selected = 0;
        inputs.forEach(input => {
          if (input.checked) selected++;
        });
        inputs.forEach(input => {
          if (!input.checked && selected >= max) {
            input.disabled = true;
          } else {
            input.disabled = false;
          }
        });
        // Atualizar contador no rÃ³tulo
        const label = modalContent.querySelector(`label[data-group-key="${key}"]`);
        if (label) {
          const base = label.dataset.baseText || label.textContent;
          label.textContent = `${base} (${selected}/${max})`;
        }
      }
      // Determinar grupos de personalizaÃ§Ã£o
      let groups = [];
      if (Array.isArray(item.customOptions)) {
        groups = item.customOptions;
      } else if (item.customizable) {
        // Fallback para itens montÃ¡veis (pastÃ©is, tapiocas, prensado) que usam proteÃ­nas e acompanhamentos
        const pLimit = item.proteinLimit || 1;
        groups = [
          {
            key: 'protein',
            name: pLimit > 1 ? `ProteÃ­nas (atÃ© ${pLimit})` : 'ProteÃ­na',
            type: pLimit > 1 ? 'checkbox' : 'radio',
            maxSelections: pLimit,
            required: false,
            choicesSource: 'proteins',
          },
          {
            key: 'ingredients',
            name: 'Acompanhamentos (atÃ© 18)',
            type: 'checkbox',
            maxSelections: 18,
            required: false,
            choicesSource: 'ingredients',
          },
        ];
      }
      // Criar grupos no modal
      groups.forEach(gr => {
        createOptionGroup(gr);
      });
      // Campo de preÃ§o customizado, se aplicÃ¡vel
      if (item.priceInput) {
        const priceSection = document.createElement('div');
        priceSection.className = 'modal-section';
        const priceLabel = document.createElement('label');
        priceLabel.textContent = 'PreÃ§o (R$)';
        priceSection.appendChild(priceLabel);
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.min = '0';
        priceInput.step = '0.01';
        priceInput.id = 'custom-price';
        priceSection.appendChild(priceInput);
        modalContent.appendChild(priceSection);
      }
      // ObservaÃ§Ã£o do item
      const obsSection = document.createElement('div');
      obsSection.className = 'modal-section';
      const obsLabel = document.createElement('label');
      obsLabel.textContent = 'ObservaÃ§Ã£o do item';
      obsSection.appendChild(obsLabel);
      const obsInput = document.createElement('textarea');
      obsInput.id = 'custom-observation';
      obsInput.rows = 2;
      obsSection.appendChild(obsInput);
      modalContent.appendChild(obsSection);
      // Preencher seleÃ§Ãµes ao editar
      if (editIndex !== null && cart[editIndex]) {
        const existing = cart[editIndex];
        if (existing.options) {
          Object.keys(existing.options).forEach(key => {
            const value = existing.options[key];
            if (!value) return;
            const inputs = modalContent.querySelectorAll(`input[name="${key}"]`);
            inputs.forEach(input => {
              if (Array.isArray(value)) {
                if (value.includes(input.value)) input.checked = true;
              } else {
                if (input.value === value) input.checked = true;
              }
            });
            // Atualizar contagem para checkboxes
            const groupDef = groups.find(g => g.key === key);
            if (groupDef && groupDef.type === 'checkbox') {
              updateGroupCounts(key, groupDef.maxSelections || 1);
            }
          });
          // preÃ§o customizado
          if (item.priceInput) {
            modalContent.querySelector('#custom-price').value = existing.price;
          }
          // observaÃ§Ã£o
          modalContent.querySelector('#custom-observation').value = existing.options.observation || '';
        }
      }
      // Exibir modal
      document.getElementById('modal-overlay').classList.add('active');
    }

    /**
     * Atualiza o contador de ingredientes no modal e desabilita checkboxes
     * quando o limite de 18 Ã© atingido.
     */
    function updateIngredientCounter() {
      const checks = document.querySelectorAll('#modal-content input[name="ingredients"]');
      let selected = 0;
      checks.forEach(ch => { if (ch.checked) selected++; });
      const counter = document.getElementById('ingredient-counter');
      if (counter) counter.textContent = `Ingredientes (${selected}/18):`;
      checks.forEach(ch => {
        if (!ch.checked && selected >= 18) {
          ch.disabled = true;
        } else {
          ch.disabled = false;
        }
      });
    }

    /**
     * Fechar o modal e limpar variÃ¡veis temporÃ¡rias.
     */
    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
      currentModalItem = null;
      currentEditIndex = null;
    }

    /**
     * Ao salvar no modal, cria/atualiza o item no carrinho com as opÃ§Ãµes
     * selecionadas.
     */
    function saveModal() {
      const modalEl = document.getElementById('modal-content');
      // Preparar objeto de opÃ§Ãµes
      const options = {};
      // Se item tiver customOptions definidas, coletar conforme grupos; caso contrÃ¡rio usar fallback
      if (Array.isArray(currentModalItem.customOptions)) {
        currentModalItem.customOptions.forEach(group => {
          const inputs = modalEl.querySelectorAll(`input[name="${group.key}"]`);
          if (!inputs || inputs.length === 0) return;
          if (group.type === 'radio') {
            const checked = modalEl.querySelector(`input[name="${group.key}"]:checked`);
            options[group.key] = checked ? checked.value : '';
          } else {
            const selected = Array.from(inputs).filter(i => i.checked).map(i => i.value);
            options[group.key] = selected;
          }
        });
      } else if (currentModalItem.customizable) {
        // Coletar proteÃ­na
        const protInputs = modalEl.querySelectorAll('input[name="protein"]');
        if (protInputs.length) {
          if (protInputs[0].type === 'radio') {
            const checked = modalEl.querySelector('input[name="protein"]:checked');
            options.protein = checked ? checked.value : '';
          } else {
            const selected = Array.from(protInputs).filter(i => i.checked).map(i => i.value);
            options.protein = selected;
          }
        }
        // Coletar ingredientes
        const ingInputs = modalEl.querySelectorAll('input[name="ingredients"]:checked');
        options.ingredients = Array.from(ingInputs).map(ch => ch.value);
      }
      // ObservaÃ§Ã£o
      const observation = (modalEl.querySelector('#custom-observation')?.value || '').trim();
      options.observation = observation;
      // PreÃ§o customizado (se existir)
      let price = currentModalItem.price;
      if (currentModalItem.priceInput) {
        const priceVal = parseFloat(modalEl.querySelector('#custom-price').value);
        price = isNaN(priceVal) ? 0 : priceVal;
      }
      const newItem = {
        id: currentModalItem.id,
        name: currentModalItem.name,
        price: price,
        quantity: 1,
        options: options,
      };
      if (currentEditIndex !== null && cart[currentEditIndex]) {
        // Atualizar item existente preservando quantidade
        const existingQty = cart[currentEditIndex].quantity;
        newItem.quantity = existingQty;
        cart[currentEditIndex] = newItem;
      } else {
        // Inserir novo item
        cart.push(newItem);
      }
      saveToStorage();
      updateCartBadge();
      closeModal();
    }

    /**
     * Renderiza a tela de carrinho com todos os itens selecionados e permite
     * ediÃ§Ã£o/removal. Atualiza subtotais, frete e total.
     */
    function renderCart() {
      // Preencher observaÃ§Ãµes gerais
      document.getElementById('cart-observations').value = cartObservations;
      const container = document.getElementById('cart-items');
      container.innerHTML = '';
      cart.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        // Imagem
        const img = document.createElement('div');
        img.style.width = '64px';
        img.style.height = '64px';
        img.style.backgroundColor = 'var(--gray-medium)';
        img.style.display = 'flex';
        img.style.alignItems = 'center';
        img.style.justifyContent = 'center';
        img.style.color = 'var(--gray-light)';
        img.style.fontSize = '1.5rem';
        const assetUrl = getAssetUrl(assets[item.id]);
        if (assetUrl) {
          const imgtag = document.createElement('img');
          imgtag.src = assetUrl;
          imgtag.alt = item.name;
          imgtag.loading = 'lazy';
          imgtag.style.width = '64px';
          imgtag.style.height = '64px';
          imgtag.style.objectFit = 'cover';
          img.appendChild(imgtag);
        } else {
          // determinar emoji com base na categoria
          let catEmoji = 'Ã°Å¸ÂÃ¢â‚¬Â';
          for (const cat of categories) {
            if (cat.items.some(ci => ci.id === item.id)) {
              catEmoji = cat.emoji || catEmoji;
              break;
            }
          }
          img.textContent = catEmoji;
        }
        div.appendChild(img);
        // Detalhes
        const details = document.createElement('div');
        details.className = 'cart-item-details';
        const title = document.createElement('div');
        title.className = 'cart-item-title';
        title.textContent = item.name;
        details.appendChild(title);
        // OpÃ§Ãµes
        if (item.options) {
          const opts = document.createElement('div');
          opts.className = 'cart-item-options';
          Object.keys(item.options).forEach(key => {
            const val = item.options[key];
            if (!val || key === 'observation') return;
            let label;
            switch (key) {
              case 'protein':
                label = 'ProteÃ­na';
                break;
              case 'ingredients':
                label = 'Acompanhamentos';
                break;
              case 'blend':
                label = 'Blend';
                break;
              case 'sauces':
                label = 'Molhos';
                break;
              case 'extras':
                label = 'Extras';
                break;
              case 'flavors':
                label = 'Sabores';
                break;
              case 'toppings':
                label = 'Toppings';
                break;
              case 'syrups':
                label = 'Caldas';
                break;
              default:
                // Capitalizar chave
                label = key.charAt(0).toUpperCase() + key.slice(1);
            }
            const entry = document.createElement('div');
            if (Array.isArray(val)) {
              entry.textContent = `${label}: ${val.join(', ')}`;
            } else {
              entry.textContent = `${label}: ${val}`;
            }
            opts.appendChild(entry);
          });
          if (item.options.observation) {
            const oSpan = document.createElement('div');
            oSpan.textContent = 'Obs: ' + item.options.observation;
            opts.appendChild(oSpan);
          }
          details.appendChild(opts);
        }
        // PreÃ§o unitÃ¡rio
        const price = document.createElement('div');
        price.textContent = formatCurrency(item.price);
        price.style.color = 'var(--primary-yellow)';
        details.appendChild(price);
        div.appendChild(details);
        // AÃ§Ãµes (quantidade, editar, remover)
        const actions = document.createElement('div');
        actions.className = 'cart-item-actions';
        // Quantidade
        const qtyCtrl = document.createElement('div');
        qtyCtrl.className = 'quantity-control';
        const minusBtn = document.createElement('button');
        minusBtn.textContent = 'âˆ’';
        minusBtn.addEventListener('click', () => {
          if (cart[index].quantity > 1) {
            cart[index].quantity--;
          } else {
            cart.splice(index, 1);
          }
          saveToStorage();
          updateCartBadge();
          renderCart();
        });
        qtyCtrl.appendChild(minusBtn);
        const qtyDisplay = document.createElement('span');
        qtyDisplay.textContent = item.quantity;
        qtyCtrl.appendChild(qtyDisplay);
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.addEventListener('click', () => {
          cart[index].quantity++;
          saveToStorage();
          updateCartBadge();
          renderCart();
        });
        qtyCtrl.appendChild(plusBtn);
        actions.appendChild(qtyCtrl);
        // Editar
        if (item.options) {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-secondary btn-small';
          editBtn.textContent = 'Editar';
          editBtn.addEventListener('click', () => {
            // Abrir modal com dados existentes
            const originalItem = categories.flatMap(c => c.items).find(ci => ci.id === item.id);
            if (originalItem) {
              openCustomizationModal(originalItem, index);
            }
          });
          actions.appendChild(editBtn);
        }
        // Remover
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-secondary btn-small';
        removeBtn.textContent = 'Remover';
        removeBtn.addEventListener('click', () => {
          cart.splice(index, 1);
          saveToStorage();
          updateCartBadge();
          renderCart();
        });
        actions.appendChild(removeBtn);
        div.appendChild(actions);
        container.appendChild(div);
      });
      // Totais
      const totalsDiv = document.getElementById('cart-totals');
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const freight = calculateFreight();
      const total = subtotal + freight;
      totalsDiv.innerHTML = '';
      const rowSub = document.createElement('div');
      rowSub.innerHTML = `<span>Subtotal</span><span>${formatCurrency(subtotal)}</span>`;
      totalsDiv.appendChild(rowSub);
      const rowFreight = document.createElement('div');
      rowFreight.innerHTML = `<span>Frete</span><span>${formatCurrency(freight)}</span>`;
      totalsDiv.appendChild(rowFreight);
      const rowTotal = document.createElement('div');
      rowTotal.className = 'total';
      rowTotal.innerHTML = `<span>Total</span><span>${formatCurrency(total)}</span>`;
      totalsDiv.appendChild(rowTotal);
    }

    /**
     * FunÃ§Ã£o utilitÃ¡ria para gerar um slug a partir de um nome. O slug Ã©
     * utilizado como identificador interno de itens e chaves de categoria.
     * Remove caracteres especiais, converte espaÃ§os em hÃ­fens e aplica
     * minÃºsculas. Se jÃ¡ existir um slug igual no escopo onde serÃ¡ usado,
     * adiciona um nÃºmero incremental para garantir unicidade.
     *
     * @param {string} name
     * @param {Set<string>} existingSet
     * @returns {string}
     */
    function generateSlug(name, existingSet) {
      let slug = name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // remove acentos
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
      let originalSlug = slug;
      let counter = 1;
      while (existingSet.has(slug) || slug === '') {
        slug = `${originalSlug}-${counter}`;
        counter++;
      }
      return slug;
    }

    /**
     * Renderiza o editor do cardapio. Cria dinamicamente campos de
     * ediÃ§Ã£o para cada categoria e seus itens, permitindo alterar
     * nome, emoji, descriÃ§Ã£o, preÃ§o, flags e imagens. TambÃ©m inclui
     * botÃµes para adicionar/remover categorias e itens.
     */
    function renderEditor() {
      const container = document.getElementById('editor-content');
      container.innerHTML = '';
      categories.forEach((cat, ci) => {
        const catDiv = document.createElement('div');
        catDiv.style.backgroundColor = 'var(--gray-dark)';
        catDiv.style.borderRadius = 'var(--radius-card)';
        catDiv.style.padding = '1rem';
        catDiv.style.marginBottom = '1rem';
        catDiv.style.boxShadow = 'var(--shadow)';
        // TÃ­tulo e remover categoria
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        const h3 = document.createElement('h3');
        h3.textContent = `Grupo ${ci+1}`;
        header.appendChild(h3);
        const delCatBtn = document.createElement('button');
        delCatBtn.className = 'btn btn-secondary btn-small';
        delCatBtn.textContent = 'Remover Grupo';
        delCatBtn.addEventListener('click', () => {
          if (confirm('Deseja remover este grupo e todos os itens?')) {
            categories.splice(ci, 1);
            saveCatalog();
            renderEditor();
            renderCategories();
            renderProducts();
          }
        });
        header.appendChild(delCatBtn);
        catDiv.appendChild(header);
        // Campos para editar nome e emoji da categoria
        const nameGroup = document.createElement('div');
        nameGroup.className = 'form-group';
        const nameLabel = document.createElement('label');
        nameLabel.textContent = 'Nome do Grupo';
        nameGroup.appendChild(nameLabel);
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = cat.name;
        nameInput.addEventListener('input', (e) => {
          cat.name = e.target.value;
          // Atualizar nav se estiver visÃ­vel
          renderCategories();
        });
        nameGroup.appendChild(nameInput);
        catDiv.appendChild(nameGroup);
        const emojiGroup = document.createElement('div');
        emojiGroup.className = 'form-group';
        const emojiLabel = document.createElement('label');
        emojiLabel.textContent = 'Emoji';
        emojiGroup.appendChild(emojiLabel);
        const emojiInput = document.createElement('input');
        emojiInput.type = 'text';
        emojiInput.value = cat.emoji || '';
        emojiInput.addEventListener('input', (e) => {
          cat.emoji = e.target.value;
          renderCategories();
        });
        emojiGroup.appendChild(emojiInput);
        catDiv.appendChild(emojiGroup);
        // Itens da categoria
        const itemsWrapper = document.createElement('div');
        itemsWrapper.style.marginTop = '0.5rem';
        cat.items.forEach((item, ii) => {
          const itemDiv = document.createElement('div');
          itemDiv.style.backgroundColor = 'var(--gray-medium)';
          itemDiv.style.borderRadius = 'var(--radius-input)';
          itemDiv.style.padding = '0.8rem';
          itemDiv.style.marginBottom = '0.8rem';
          // Header item
          const itemHeader = document.createElement('div');
          itemHeader.style.display = 'flex';
          itemHeader.style.justifyContent = 'space-between';
          itemHeader.style.alignItems = 'center';
          const itemTitle = document.createElement('strong');
          itemTitle.textContent = `${ii+1}. ${item.name}`;
          itemHeader.appendChild(itemTitle);
          const delItemBtn = document.createElement('button');
          delItemBtn.className = 'btn btn-secondary btn-small';
          delItemBtn.textContent = 'Remover Item';
          delItemBtn.addEventListener('click', () => {
            if (confirm('Deseja remover este item?')) {
              // Remover imagem associada
              if (assets[item.id]) {
                delete assets[item.id];
              }
              cat.items.splice(ii, 1);
              saveCatalog();
              renderEditor();
              renderCategories();
              renderProducts();
            }
          });
          itemHeader.appendChild(delItemBtn);
          itemDiv.appendChild(itemHeader);
          // Nome do item
          const itemNameGroup = document.createElement('div');
          itemNameGroup.className = 'form-group';
          const itemNameLabel = document.createElement('label');
          itemNameLabel.textContent = 'Nome do Item';
          itemNameGroup.appendChild(itemNameLabel);
          const itemNameInput = document.createElement('input');
          itemNameInput.type = 'text';
          itemNameInput.value = item.name;
          itemNameInput.addEventListener('input', (e) => {
            item.name = e.target.value;
            itemHeader.querySelector('strong').textContent = `${ii+1}. ${item.name}`;
            renderProducts();
          });
          itemNameGroup.appendChild(itemNameInput);
          itemDiv.appendChild(itemNameGroup);
          // DescriÃ§Ã£o
          const itemDescGroup = document.createElement('div');
          itemDescGroup.className = 'form-group';
          const itemDescLabel = document.createElement('label');
          itemDescLabel.textContent = 'DescriÃ§Ã£o';
          itemDescGroup.appendChild(itemDescLabel);
          const itemDescInput = document.createElement('textarea');
          itemDescInput.rows = 2;
          itemDescInput.value = item.description || '';
          itemDescInput.addEventListener('input', (e) => {
            item.description = e.target.value;
            renderProducts();
          });
          itemDescGroup.appendChild(itemDescInput);
          itemDiv.appendChild(itemDescGroup);
          // PreÃ§o
          const priceGroup = document.createElement('div');
          priceGroup.className = 'form-group';
          const priceLabel = document.createElement('label');
          priceLabel.textContent = 'PreÃ§o (R$)';
          priceGroup.appendChild(priceLabel);
          const priceInput = document.createElement('input');
          priceInput.type = 'number';
          priceInput.min = '0';
          priceInput.step = '0.01';
          priceInput.value = item.price;
          priceInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            item.price = isNaN(val) ? 0 : val;
            renderProducts();
            renderCart();
          });
          priceGroup.appendChild(priceInput);
          itemDiv.appendChild(priceGroup);
          // Flags de personalizaÃ§Ã£o e outras opÃ§Ãµes
          const flagsGroup = document.createElement('div');
          flagsGroup.style.display = 'flex';
          flagsGroup.style.alignItems = 'center';
          flagsGroup.style.flexWrap = 'wrap';
          flagsGroup.style.gap = '1rem';
          // customizÃ¡vel
          const customLabel = document.createElement('label');
          customLabel.style.display = 'flex';
          customLabel.style.alignItems = 'center';
          const customCheckbox = document.createElement('input');
          customCheckbox.type = 'checkbox';
          customCheckbox.checked = !!item.customizable;
          customCheckbox.addEventListener('change', (e) => {
            item.customizable = e.target.checked;
            // Se tornar customizÃ¡vel e nÃ£o possuir customOptions, garantir proteinLimit
            if (item.customizable && !item.customOptions && item.proteinLimit === undefined) {
              item.proteinLimit = 1;
            }
          });
          customLabel.appendChild(customCheckbox);
          customLabel.appendChild(document.createTextNode('Montagem'));
          flagsGroup.appendChild(customLabel);
          // priceInput
          const priceInLabel = document.createElement('label');
          priceInLabel.style.display = 'flex';
          priceInLabel.style.alignItems = 'center';
          const priceInCheckbox = document.createElement('input');
          priceInCheckbox.type = 'checkbox';
          priceInCheckbox.checked = !!item.priceInput;
          priceInCheckbox.addEventListener('change', (e) => {
            item.priceInput = e.target.checked;
            renderProducts();
          });
          priceInLabel.appendChild(priceInCheckbox);
          priceInLabel.appendChild(document.createTextNode('PreÃ§o a definir'));
          flagsGroup.appendChild(priceInLabel);
          // Disponibilidade do item
          const availLabel = document.createElement('label');
          availLabel.style.display = 'flex';
          availLabel.style.alignItems = 'center';
          const availCheckbox = document.createElement('input');
          availCheckbox.type = 'checkbox';
          availCheckbox.checked = item.available !== false;
          availCheckbox.addEventListener('change', (e) => {
            item.available = e.target.checked;
            renderProducts();
          });
          availLabel.appendChild(availCheckbox);
          availLabel.appendChild(document.createTextNode('DisponÃ­vel'));
          flagsGroup.appendChild(availLabel);
          // Para itens com montagem via fallback (sem customOptions), permitir definir limite de proteÃ­nas
          if (item.customizable && !Array.isArray(item.customOptions)) {
            const proteinLimitLabel = document.createElement('label');
            proteinLimitLabel.style.display = 'flex';
            proteinLimitLabel.style.alignItems = 'center';
            proteinLimitLabel.style.gap = '0.3rem';
            const protInput = document.createElement('input');
            protInput.type = 'number';
            protInput.min = '1';
            protInput.step = '1';
            protInput.style.width = '60px';
            protInput.value = item.proteinLimit || 1;
            protInput.addEventListener('input', (e) => {
              const val = parseInt(e.target.value, 10);
              item.proteinLimit = (isNaN(val) || val < 1) ? 1 : val;
            });
            proteinLimitLabel.appendChild(document.createTextNode('Limite de proteÃ­nas'));
            proteinLimitLabel.appendChild(protInput);
            flagsGroup.appendChild(proteinLimitLabel);
          }
          itemDiv.appendChild(flagsGroup);
          // Upload de imagem
          const imgGroup = document.createElement('div');
          imgGroup.className = 'form-group';
          const imgLabel = document.createElement('label');
          imgLabel.textContent = 'Imagem (PNG)';
          imgGroup.appendChild(imgLabel);
          const imgInput = document.createElement('input');
          imgInput.type = 'file';
          imgInput.accept = 'image/png';

          const previewBox = document.createElement('div');
          previewBox.style.display = 'flex';
          previewBox.style.alignItems = 'center';
          previewBox.style.gap = '0.5rem';
          previewBox.style.marginTop = '0.5rem';

          const thumb = document.createElement('img');
          thumb.style.width = '64px';
          thumb.style.height = '64px';
          thumb.style.objectFit = 'cover';
          thumb.style.borderRadius = '8px';

          const placeholder = document.createElement('span');
          placeholder.style.fontSize = '0.85rem';
          placeholder.style.color = 'var(--gray-light)';
          placeholder.style.fontStyle = 'italic';
          placeholder.textContent = 'Nenhuma imagem enviada.';

          previewBox.appendChild(thumb);
          previewBox.appendChild(placeholder);

          const statusMessage = document.createElement('div');
          statusMessage.style.fontSize = '0.85rem';
          statusMessage.style.marginTop = '0.5rem';
          statusMessage.style.color = 'var(--gray-light)';
          const currentAsset = assets[item.id] || '';
          const isLocalAsset = typeof currentAsset === 'string' && currentAsset.startsWith('data:');
          statusMessage.dataset.mode = isLocalAsset ? 'local' : (currentAsset ? 'remote' : '');
          if (isLocalAsset) {
            statusMessage.style.color = '#ffa726';
            statusMessage.textContent = 'Imagem pendente de envio.';
          } else if (currentAsset) {
            statusMessage.textContent = 'Imagem carregada.';
          } else {
            statusMessage.textContent = 'Nenhuma imagem enviada.';
          }

          imgGroup.appendChild(imgInput);

          const toRelativePath = (input) => {
            if (!input) return '';
            let normalized = String(input).trim().replace(/^\.?\/+/, '');
            if (normalized.startsWith(ASSET_BASE_URL)) {
              normalized = normalized.slice(ASSET_BASE_URL.length);
            }
            return normalized;
          };

          const basePath = ASSET_BASE_URL.endsWith('/') ? ASSET_BASE_URL : `${ASSET_BASE_URL}/`;

          let manifestSelect = null;

          const manualWrapper = document.createElement('div');
          manualWrapper.style.marginTop = '0.5rem';

          const manualLabel = document.createElement('label');
          manualLabel.textContent = `Caminho da imagem (${basePath} ou URL)`;
          manualLabel.style.display = 'block';
          manualLabel.style.marginBottom = '0.3rem';
          manualWrapper.appendChild(manualLabel);

          const manualInput = document.createElement('input');
          manualInput.type = 'text';
          manualInput.placeholder = `${basePath}arquivo.png ou URL completa`;
          manualInput.style.width = '100%';
          manualInput.value = isLocalAsset ? '' : (currentAsset || '');
          manualInput.addEventListener('change', () => {
            const value = manualInput.value.trim();
            const relative = toRelativePath(value);
            if (manifestSelect) {
              manifestSelect.value = value && availableImages.includes(relative) ? relative : '';
            }
            if (value) {
              assets[item.id] = value;
              saveCatalog();
              refreshPreview(value);
              statusMessage.dataset.mode = 'remote';
              statusMessage.style.color = 'var(--gray-light)';
              statusMessage.textContent = 'Imagem carregada.';
            } else {
              delete assets[item.id];
              saveCatalog();
              refreshPreview('');
              statusMessage.dataset.mode = '';
              statusMessage.style.color = 'var(--gray-light)';
              statusMessage.textContent = 'Nenhuma imagem enviada.';
            }
          });

          manualWrapper.appendChild(manualInput);

          if (Array.isArray(availableImages) && availableImages.length) {
            manifestSelect = document.createElement('select');
            manifestSelect.style.marginTop = '0.3rem';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = 'Escolher imagem da pasta';
            manifestSelect.appendChild(placeholderOption);
            availableImages.forEach(fileName => {
              const option = document.createElement('option');
              option.value = fileName;
              option.textContent = fileName;
              manifestSelect.appendChild(option);
            });
            const initialRelative = toRelativePath(assets[item.id] || '');
            if (initialRelative && availableImages.includes(initialRelative)) {
              manifestSelect.value = initialRelative;
            }
            manifestSelect.addEventListener('change', () => {
              const selected = manifestSelect.value;
              manualInput.value = selected ? selected : '';
              manualInput.dispatchEvent(new Event('change'));
            });
            manualWrapper.appendChild(manifestSelect);
          }

          imgGroup.appendChild(manualWrapper);
          imgGroup.appendChild(previewBox);
          imgGroup.appendChild(statusMessage);

          function refreshPreview(path) {
            const url = getAssetUrl(path);
            if (url) {
              thumb.src = url;
              thumb.style.display = 'block';
              placeholder.style.display = 'none';
            } else {
              thumb.src = '';
              thumb.style.display = 'none';
              placeholder.style.display = 'block';
            }
            if (typeof path === 'string' && path.startsWith('data:')) {
              statusMessage.dataset.mode = 'local';
            } else if (path) {
              statusMessage.dataset.mode = 'remote';
            } else {
              statusMessage.dataset.mode = '';
            }
            if (typeof manualInput !== 'undefined') {
              if (typeof path === 'string' && !path.startsWith('data:')) {
                manualInput.value = path;
              } else if (!path) {
                manualInput.value = '';
              }
            }
            if (manifestSelect) {
              const relativePath = toRelativePath(path);
              manifestSelect.value = relativePath && availableImages.includes(relativePath) ? relativePath : '';
            }
          }

          refreshPreview(assets[item.id] || '');

          imgInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            imgInput.disabled = true;
            statusMessage.style.color = 'var(--gray-light)';
            statusMessage.textContent = 'Enviando imagem...';
            try {
              const newPath = await uploadCatalogImage(item.id, file, assets[item.id] || '');
              assets[item.id] = newPath;
              saveCatalog();
              renderProducts();
              refreshPreview(newPath);
              const localOnly = typeof newPath === 'string' && newPath.startsWith('data:');
              statusMessage.dataset.mode = localOnly ? 'local' : 'remote';
              if (localOnly && manualInput.value.trim() === '') {
                const rawName = (file && file.name) ? file.name.toLowerCase().replace(/\s+/g, '-') : `${item.id}.png`;
                const basePath = ASSET_BASE_URL.endsWith('/') ? ASSET_BASE_URL : `${ASSET_BASE_URL}/`;
                const suggestion = rawName.endsWith('.png') ? `${basePath}${rawName}` : `${basePath}${rawName}.png`;
                manualInput.value = suggestion;
              }
              statusMessage.style.color = localOnly ? '#ffa726' : '#66bb6a';
              statusMessage.textContent = localOnly
                ? `Imagem disponivel apenas neste navegador. Publique o PNG em ${basePath} e informe o caminho.`
                : 'Imagem atualizada.';
            } catch (error) {
              console.error('Falha no upload da imagem:', error);
              statusMessage.style.color = '#ef5350';
              statusMessage.textContent = error.message || 'Falha ao enviar imagem.';
            } finally {
              imgInput.value = '';
              imgInput.disabled = false;
              setTimeout(() => {
                if (statusMessage.dataset.mode === 'remote') {
                  statusMessage.style.color = 'var(--gray-light)';
                  statusMessage.textContent = 'Imagem carregada.';
                } else if (statusMessage.dataset.mode === 'local') {
                  statusMessage.style.color = '#ffa726';
                  statusMessage.textContent = 'Imagem pendente de envio.';
                }
              }, 2500);
            }
          });

          itemDiv.appendChild(imgGroup);
          itemsWrapper.appendChild(itemDiv);
        });
        catDiv.appendChild(itemsWrapper);
        // BotÃ£o adicionar item
        const addItemBtn = document.createElement('button');
        addItemBtn.className = 'btn btn-secondary btn-small';
        addItemBtn.textContent = 'Adicionar Item';
        addItemBtn.addEventListener('click', () => {
          const name = prompt('Nome do novo item:');
          if (!name) return;
          // Criar slug Ãºnico considerando itens existentes
          const existingIds = new Set(cat.items.map(it => it.id));
          const slug = generateSlug(name, existingIds);
          cat.items.push({ id: slug, name: name, description: '', price: 0 });
          renderEditor();
          renderCategories();
          renderProducts();
        });
        catDiv.appendChild(addItemBtn);
        container.appendChild(catDiv);
      });

      // --------- Editor de listas globais (proteÃ­nas, ingredientes, etc.) ---------
      // Criar um contÃªiner para as listas globais
      const globalContainer = document.createElement('div');
      globalContainer.style.backgroundColor = 'var(--gray-dark)';
      globalContainer.style.borderRadius = 'var(--radius-card)';
      globalContainer.style.padding = '1rem';
      globalContainer.style.boxShadow = 'var(--shadow)';
      globalContainer.style.marginBottom = '1rem';
      const globalTitle = document.createElement('h3');
      globalTitle.textContent = 'Ingredientes e OpÃ§Ãµes Globais';
      globalContainer.appendChild(globalTitle);
      // FunÃ§Ã£o auxiliar para renderizar uma lista
      function renderOptionList(title, list, updateCallback) {
        const section = document.createElement('div');
        section.style.marginBottom = '1rem';
        const h4 = document.createElement('h4');
        h4.textContent = title;
        section.appendChild(h4);
        // Antes de iterar para gerar linhas, normalize todos os itens para
        // garantir que list[i] seja um objeto com uma propriedade name.
        for (let i = 0; i < list.length; i++) {
          const item = list[i];
          // Se for string ou valor falso, converter para objeto
          if (typeof item !== 'object' || item === null) {
            list[i] = { name: String(item), available: true };
          } else {
            // Se nÃ£o tem name mas tem label, copiar
            if (!('name' in item) && ('label' in item)) {
              item.name = item.label;
            }
            // Se ainda nÃ£o houver flag de disponibilidade, definir como true
            if (item.available === undefined) {
              item.available = true;
            }
            // Se o nome estÃ¡ vazio ou nÃ£o definido, tente usar label ou value
            if (!item.name || item.name.trim() === '') {
              if (item.label && item.label.trim()) {
                item.name = item.label.trim();
              } else if (item.value && String(item.value).trim()) {
                item.name = String(item.value).trim();
              } else {
                item.name = 'OpÃ§Ã£o';
              }
            }
          }
        }
        // Agora iterar com a lista normalizada. NÃ£o usar o Ã­ndice de
        // forEach diretamente no callback do botÃ£o Remover porque a
        // lista pode mudar enquanto iteramos; capturamos idx via closure.
        list.forEach((opt, idx) => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '0.5rem';
          row.style.marginBottom = '0.4rem';
          // Nome (editÃ¡vel). Usamos um div contenteditable para evitar
          // problemas de renderizaÃ§Ã£o observados em inputs sobre fundo escuro.
          const nameDiv = document.createElement('div');
          nameDiv.contentEditable = true;
          nameDiv.textContent = opt.name || opt.label || opt.value || '';
          nameDiv.style.flex = '1';
          nameDiv.style.minHeight = '36px';
          nameDiv.style.padding = '0.4rem 0.6rem';
          const computedStyle = getComputedStyle(document.documentElement);
          nameDiv.style.backgroundColor = computedStyle.getPropertyValue('--gray-medium') || '#232323';
          nameDiv.style.color = computedStyle.getPropertyValue('--primary-white') || '#FFFFFF';
          nameDiv.style.boxShadow = 'inset 0 0 0 1px var(--gray-light)';
          nameDiv.style.borderRadius = getComputedStyle(document.documentElement).getPropertyValue('--radius-input') || '8px';
          nameDiv.style.outline = 'none';
          // Ao perder o foco, atualizar o nome no objeto
          nameDiv.addEventListener('blur', () => {
            const newVal = nameDiv.textContent.trim();
            opt.name = newVal;
            if (opt.label !== undefined) opt.label = newVal;
            if (opt.value !== undefined && (opt.value === '' || opt.value === null)) {
              opt.value = newVal;
            }
          });
          row.appendChild(nameDiv);
          // Disponibilidade
          const avail = document.createElement('input');
          avail.type = 'checkbox';
          avail.checked = opt.available !== false;
          avail.addEventListener('change', (e) => {
            opt.available = e.target.checked;
          });
          row.appendChild(avail);
          // Remover opÃ§Ã£o
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-secondary btn-small';
          delBtn.textContent = 'Remover';
          delBtn.addEventListener('click', () => {
            if (confirm('Deseja remover esta opÃ§Ã£o?')) {
              list.splice(idx, 1);
              renderEditor();
            }
          });
          row.appendChild(delBtn);
          section.appendChild(row);
        });
        // BotÃ£o para adicionar nova opÃ§Ã£o
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-secondary btn-small';
        addBtn.textContent = 'Adicionar';
        addBtn.addEventListener('click', () => {
          const name = prompt('Nome da nova opÃ§Ã£o:');
          if (!name) return;
          list.push({ name: name, available: true });
          renderEditor();
        });
        section.appendChild(addBtn);
        globalContainer.appendChild(section);
      }
      // Renderizar cada lista global
      renderOptionList('ProteÃ­nas', proteins, () => {});
      renderOptionList('Acompanhamentos', ingredients, () => {});
      renderOptionList('Molhos Especiais', sauces, () => {});
      renderOptionList('Extras para HambÃºrgueres', extras, () => {});
      renderOptionList('Sabores de AÃ§aÃ­', acaiFlavors, () => {});
      renderOptionList('Sabores de Sorvete', iceCreamFlavors, () => {});
      renderOptionList('Toppings', toppings, () => {});
      // Adicionar lista de Caldas (syrups) para ediÃ§Ã£o
      renderOptionList('Caldas', syrups, () => {});
      container.appendChild(globalContainer);
    }

    /**
     * Adiciona um novo grupo ao catÃ¡logo. Pergunta o nome e gera uma key
     * automÃ¡tica baseada no nome. Define emoji padrÃ£o como "ðŸ½ï¸".
     */
    function addCategory() {
      const name = prompt('Nome do novo grupo:');
      if (!name) return;
      // Gerar slug Ãºnico para chave
      const existingKeys = new Set(categories.map(c => c.key));
      const slug = generateSlug(name, existingKeys);
      categories.push({ key: slug, name: name, emoji: 'ðŸ½ï¸', items: [] });
      renderEditor();
      renderCategories();
      renderProducts();
    }

    /**
     * Monta a mensagem que serÃ¡ enviada via WhatsApp com todos os detalhes
     * do pedido. Inclui dados do cliente, itens do carrinho, observaÃ§Ãµes e
     * identificador do pedido.
     *
     * @returns {string}
     */
    function buildWhatsAppMessage() {
      let message = `*Palatarius - Pedido Online*`;
      message += `\nCliente: ${customer.name} | Tel: ${customer.phone}`;
      message += `\nEntrega/Retirada: ${customer.type}`;
      if (customer.type === 'Entrega') {
        const addr = customer.address;
        const addrString = `${addr.logradouro}, ${addr.number}${addr.complement ? ' - ' + addr.complement : ''}, ${addr.bairro}, ${addr.marco}`;
        message += `\nEndereÃ§o: ${addrString}`;
        message += ` | KM: ${addr.km}`;
        message += `\nFrete: ${formatCurrency(calculateFreight())}`;
      } else {
        message += `\nFrete: R$ 0,00`;
      }
      message += `\n\n*Itens:*`;
      cart.forEach((item, idx) => {
        message += `\n${idx+1}) ${item.name} x${item.quantity} â€” ${formatCurrency(item.price)}`;
        if (item.options) {
          Object.keys(item.options).forEach(key => {
            const val = item.options[key];
            if (!val || key === 'observation') return;
            let label;
            switch (key) {
              case 'protein':
                label = 'ProteÃ­na';
                break;
              case 'ingredients':
                label = 'Acompanhamentos';
                break;
              case 'blend':
                label = 'Blend';
                break;
              case 'sauces':
                label = 'Molhos';
                break;
              case 'extras':
                label = 'Extras';
                break;
              case 'flavors':
                label = 'Sabores';
                break;
              case 'toppings':
                label = 'Toppings';
                break;
              case 'syrups':
                label = 'Caldas';
                break;
              default:
                label = key.charAt(0).toUpperCase() + key.slice(1);
            }
            if (Array.isArray(val)) {
              if (val.length) message += `\n   ${label}: ${val.join(', ')}`;
            } else {
              if (val) message += `\n   ${label}: ${val}`;
            }
          });
          if (item.options.observation) {
            message += `\n   Obs item: ${item.options.observation}`;
          }
        }
      });
      const subtotal = cart.reduce((sum, it) => sum + it.price * it.quantity, 0);
      const freight = calculateFreight();
      const total = subtotal + freight;
      message += `\nSubtotal: ${formatCurrency(subtotal)}`;
      message += `\nFrete: ${formatCurrency(freight)}`;
      message += `\n*Total: ${formatCurrency(total)}*`;
      if (cartObservations) {
        message += `\n\nObs gerais: ${cartObservations}`;
      }
      message += `\n\nIdentificador: ${generateOrderId()}`;
      return message;
    }

    /**
     * Gera um cupom/recibo em uma nova janela para impressÃ£o em uma
     * impressora tÃ©rmica de 80 mm. O recibo contÃ©m todas as informaÃ§Ãµes
     * do pedido, incluindo dados do cliente, itens selecionados com suas
     * personalizaÃ§Ãµes, subtotal, frete e total. O conteÃºdo Ã© gerado
     * em HTML simples com fonte monoespaÃ§ada para facilitar a
     * visualizaÃ§Ã£o em impressoras tÃ©rmicas. Em seguida, abre uma nova
     * janela, escreve o HTML e aciona a impressÃ£o.
     */
    function generateCoupon() {
      // Certificar que hÃ¡ itens e dados do cliente vÃ¡lidos
      if (!validateCustomerForm()) {
        alert('Preencha corretamente os dados do cliente antes de gerar o cupom.');
        return;
      }
      if (cart.length === 0) {
        alert('Seu carrinho estÃ¡ vazio!');
        return;
      }
      const now = new Date();
      const dateStr = now.toLocaleDateString('pt-BR');
      const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const orderId = generateOrderId();
      // Construir linhas HTML para o recibo
      const lines = [];
      lines.push('<div style="width:80mm; font-family: monospace;">');
      lines.push('<h3 style="text-align:center; margin:0;">Palatarius</h3>');
      lines.push('<div style="text-align:center; margin-bottom:4px;">Pedido Online</div>');
      lines.push(`<div>Data: ${dateStr} ${timeStr}</div>`);
      lines.push(`<div>Cliente: ${customer.name}</div>`);
      lines.push(`<div>Telefone: ${customer.phone}</div>`);
      if (customer.type === 'Entrega') {
        const addr = customer.address;
        const addrString = `${addr.logradouro}, ${addr.number}${addr.complement ? ' - ' + addr.complement : ''}, ${addr.bairro}, ${addr.marco}`;
        lines.push(`<div>Entrega: ${addrString}</div>`);
        lines.push(`<div>KM: ${addr.km}</div>`);
      } else {
        lines.push('<div>Retirada no balcÃ£o</div>');
      }
      lines.push('<hr style="border-top:1px dashed #000; margin:4px 0;"/>');
      lines.push('<div><strong>Itens:</strong></div>');
      cart.forEach((item, idx) => {
        lines.push(`<div>${idx + 1}) ${item.name} x${item.quantity} â€” ${formatCurrency(item.price)}</div>`);
        if (item.options) {
          Object.keys(item.options).forEach(key => {
            const val = item.options[key];
            if (!val || key === 'observation') return;
            let label;
            switch (key) {
              case 'protein': label = 'ProteÃ­na'; break;
              case 'ingredients': label = 'Acomp.'; break;
              case 'blend': label = 'Blend'; break;
              case 'sauces': label = 'Molhos'; break;
              case 'extras': label = 'Extras'; break;
              case 'flavors': label = 'Sabores'; break;
              case 'toppings': label = 'Toppings'; break;
              case 'syrups': label = 'Caldas'; break;
              default: label = key;
            }
            if (Array.isArray(val) && val.length) {
              lines.push(`<div style="margin-left:8px;">${label}: ${val.join(', ')}</div>`);
            } else if (!Array.isArray(val) && val) {
              lines.push(`<div style="margin-left:8px;">${label}: ${val}</div>`);
            }
          });
          if (item.options.observation) {
            lines.push(`<div style="margin-left:8px;">Obs: ${item.options.observation}</div>`);
          }
        }
      });
      const subtotal = cart.reduce((sum, it) => sum + it.price * it.quantity, 0);
      const freight = calculateFreight();
      const total = subtotal + freight;
      lines.push('<hr style="border-top:1px dashed #000; margin:4px 0;"/>');
      lines.push(`<div>Subtotal: ${formatCurrency(subtotal)}</div>`);
      lines.push(`<div>Frete: ${formatCurrency(freight)}</div>`);
      lines.push(`<div><strong>Total: ${formatCurrency(total)}</strong></div>`);
      if (cartObservations) {
        lines.push('<div style="margin-top:4px;"><em>Obs gerais:</em></div>');
        lines.push(`<div>${cartObservations}</div>`);
      }
      lines.push('<hr style="border-top:1px dashed #000; margin:4px 0;"/>');
      lines.push(`<div>Identificador: ${orderId}</div>`);
      lines.push('</div>');
      // Montar documento HTML completo para a nova janela
      const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Recibo Palatarius</title>
<style>body{margin:0;padding:4px;font-family: monospace;font-size:12px;} h3{margin:0;font-size:16px;}</style>
</head><body>${lines.join('')}</body></html>`;
      const popup = window.open('', 'palatarius_receipt', 'width=360,height=600');
      if (!popup) {
        alert('Nao foi possivel abrir a janela de impressao. Verifique se o navegador bloqueou pop-ups.');
        return;
      }
      popup.document.write(html);
      popup.document.close();
    });
  }

});
  </script>

</body></html>

